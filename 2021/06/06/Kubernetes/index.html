<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes">
<meta property="og:url" content="http://example.com/2021/06/06/Kubernetes/index.html">
<meta property="og:site_name" content="LEMON">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo0jsryj60ys0md76e02.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo5kl1gj31cc0ro466.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo9xan5j31090qztby.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uohgqrvj30lu0gzgno.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upe69bgj30w30g3gqb.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upifvlkj319g0kznpg.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upmukg7j30wp0hgmyd.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upq32y4j30of0fqn0l.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uptd7wbj30su0jcjya.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1grndlevtw8j30ey09yaab.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1grndmm5ymqj30fc07swer.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7ur6odhwj30fg0fzabf.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7utpkiy4j30of052aax.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7utsp2asj30nc03oglx.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uw7j1trj30o808kta2.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uwcz6dbj30o808kta2.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpxgfacwj30le06kwff.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpy9cumlj30qr03rdg2.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpyrtm7yj60ns02eglt02.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uwy44bgj30vd0l93zq.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uxxrfp3j30p704ojrx.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uzrb0nrj30zh0mk3z9.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uzvvy8tj30zg0d1wfg.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v01ysnzj30yw08otay.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v05lx1ej30zk0ehjsd.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0cpenuj31020bgmxn.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0od5jbj30zh0cyjs2.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0wtpolj30ut03wmxk.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v12fx9qj30uq045mxk.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v182350j30uv04dwew.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v1bofyrj30uy03owew.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v1p27o3j30xd0g70u2.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v20t5rzj30v50gwtc0.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v25ddjsj30s50lnafb.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2ayww4j30sx0jd11p.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2gjt4wj30sw0it471.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2lb7tmj30sv0irgwj.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2owu0xj60s60fcacs02.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2ulrlwj30sa0ln76f.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2zr3qej314c0ijah5.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3b92l4j31720loh4b.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3j0i4cj31on0u0e81.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3mu4rwj31ny0u0e81.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3vm0fdj31cu0p2n3w.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v47gg29j31mc0qeqhz.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4bw64tj31720s0jw1.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4fnrinj311o0okn8s.jpg">
<meta property="og:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4kfopij31jw0cgq6z.jpg">
<meta property="article:published_time" content="2021-06-05T16:40:46.000Z">
<meta property="article:modified_time" content="2021-08-06T01:19:44.220Z">
<meta property="article:author" content="Armin">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo0jsryj60ys0md76e02.jpg">

<link rel="canonical" href="http://example.com/2021/06/06/Kubernetes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kubernetes | LEMON</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">LEMON</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/06/Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/armin.png">
      <meta itemprop="name" content="Armin">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LEMON">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
      
        <!--toc-->
<span id="more"></span>

<h1 id="一、K8S概念"><a href="#一、K8S概念" class="headerlink" title="一、K8S概念"></a>一、K8S概念</h1><h2 id="1-什么是Kubernetes"><a href="#1-什么是Kubernetes" class="headerlink" title="1. 什么是Kubernetes ?"></a>1. 什么是Kubernetes ?</h2><blockquote>
<p>k8s是一组服务器集群，K8s所管理的集群节点上的容器。<a target="_blank" rel="noopener" href="https://kubernetes.io/">官方网站</a></p>
</blockquote>
<p>Kubernetes是一个可移植的，可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。它拥有一个庞大且快速增长的生态系统。Kubernetes的服务，支持和工具广泛可用。</p>
<p>Kubernetes这个名字起源于希腊语，意思是舵手或飞行员。Google在2014年开源了Kubernetes项目。Kubernetes将超过15年的Google在大规模生产工作负载方面的经验与社区中最好的想法和实践相结合。</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo0jsryj60ys0md76e02.jpg" alt="c"></p>
<h2 id="2-为什么需要它？他的功能？"><a href="#2-为什么需要它？他的功能？" class="headerlink" title="2. 为什么需要它？他的功能？"></a>2. 为什么需要它？他的功能？</h2><p>容器是捆绑和运行应用程序的好方法。在生产环境中，您需要管理运行应用程序的容器，并确保没有停机时间。例如，如果一个容器发生故障，则需要启动另一个容器。如果由系统处理此行为，会不会更容易？</p>
<p>这就是Kubernetes的救援方法！Kubernetes为您提供了一个可弹性运行分布式系统的框架。它负责应用程序的扩展和故障转移，提供部署模式等。例如，Kubernetes可以轻松管理系统的Canary部署。</p>
<h3 id="自我修复"><a href="#自我修复" class="headerlink" title="自我修复"></a>自我修复</h3><blockquote>
<p>在节点故障时重新启动失败的容器，替换和重新部署容器，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保线上服务不中断。</p>
</blockquote>
<h3 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h3><blockquote>
<p>使用命令、UI或者基于CPU使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。</p>
</blockquote>
<h3 id="自动部署和回滚"><a href="#自动部署和回滚" class="headerlink" title="自动部署和回滚"></a>自动部署和回滚</h3><blockquote>
<p>Kubernetes采用滚动更新策略更新应用，一次更新一个Pod，而不是同时删除所有Pod，如果更新过程中出现问题，Kubernetes将回滚更改，升级保证业务不受影响。</p>
</blockquote>
<h3 id="存储编排"><a href="#存储编排" class="headerlink" title="存储编排"></a>存储编排</h3><blockquote>
<p>挂载外部存储系统，无论是来自本地存储，公有云（如AWS），还是网络存储（如NFS、iSCSI、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性。</p>
</blockquote>
<h3 id="服务发现和负载均衡"><a href="#服务发现和负载均衡" class="headerlink" title="服务发现和负载均衡"></a>服务发现和负载均衡</h3><blockquote>
<p>Kubernetes为多个容器提供一个统一访问入口（内部IP地址和一个DNS名称），并且负载均衡关联的所有容器，使得用户无需考虑容器IP问题。集群内应用可以通过DNS名称访问另一个应用，方便微服务之间通信。</p>
</blockquote>
<h3 id="机密和配置管理"><a href="#机密和配置管理" class="headerlink" title="机密和配置管理"></a>机密和配置管理</h3><blockquote>
<p>管理机密数据和应用程序配置，而不需要把敏感数据暴露在镜像里，提高敏感数据安全性。</p>
</blockquote>
<h3 id="资源监控"><a href="#资源监控" class="headerlink" title="资源监控"></a>资源监控</h3><blockquote>
<p>Node节点组件集成cAdvisor资源收集工具，可通过Heapster汇总整个集群节点资源数据，然后存储到InfluxDB时序数据库，再由Grafana展示，可以快速实现对集群资源监控，满足基本监控需求。</p>
</blockquote>
<h3 id="提供认证和授权"><a href="#提供认证和授权" class="headerlink" title="提供认证和授权"></a>提供认证和授权</h3><blockquote>
<p>支持属性访问控制 (ABAC)、角色访问控制（RBAC）认证授权策略，控制用户是否有权限使用Kubernetes API做某些事情，精细化权限分配。</p>
</blockquote>
<h2 id="3-Kubernetes架构"><a href="#3-Kubernetes架构" class="headerlink" title="3. Kubernetes架构"></a>3. Kubernetes架构</h2><blockquote>
<p>kubernetes分别有两种角色：1、master 管理节点     2、worker 工作节点</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo5kl1gj31cc0ro466.jpg" alt="b"></p>
<blockquote>
<p><strong>生产k8s集群图构</strong></p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uo9xan5j31090qztby.jpg" alt="a"></p>
<h2 id="4-Kubernetes组件"><a href="#4-Kubernetes组件" class="headerlink" title="4. Kubernetes组件"></a>4. Kubernetes组件</h2><blockquote>
<p>kubernetes分为 Master节点和 Node节点，前者是管理节点，后者是容器运行的节点。其中Master节点主要有3个重要组件，分别是APIServer，sheduler 和 controller manager。</p>
<p>Node节点 有两个组件 kubelet 和 kubelet （有时候master节点也可以既是管理节点也是工作节点）</p>
</blockquote>
<h3 id="4-1-Master-组件"><a href="#4-1-Master-组件" class="headerlink" title="4.1 Master 组件"></a>4.1 Master 组件</h3><h4 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h4><blockquote>
<p>APIServer组件负责响应用户的管理请求、进行指挥协调工作，所有服务访问统一入口。</p>
</blockquote>
<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><blockquote>
<p>scheduler组件是将待调度的pod按照一定的调度算法绑定到合适的工作节点上，负责介绍任务，选择合适的点进行分配任务。</p>
</blockquote>
<h4 id="Controller-manager"><a href="#Controller-manager" class="headerlink" title="Controller manager"></a>Controller manager</h4><blockquote>
<p>是一组控制器的合集，负责控制控制管理对应的资源，如副本（replication）和工作节点（node）等。维持副本期望数目</p>
</blockquote>
<h4 id="ETCD"><a href="#ETCD" class="headerlink" title="ETCD"></a>ETCD</h4><blockquote>
<p>etcd 负责以K/V的形式保存 Kubernetes Cluster 的配置信息和各种资源的状态信息。当数据发生变化时，etcd 会快速地通知 Kubernetes 相关组件。键值对数据库储存K8S集群所有重要信息（持久化）</p>
</blockquote>
<h3 id="4-2-Node组件"><a href="#4-2-Node组件" class="headerlink" title="4.2 Node组件"></a>4.2 Node组件</h3><blockquote>
<p>管理维护pod运行的agent，直接跟容器引擎交互实现容器的生命周期管理</p>
</blockquote>
<h4 id="Kube-proxy"><a href="#Kube-proxy" class="headerlink" title="Kube-proxy"></a>Kube-proxy</h4><blockquote>
<p>将service的流量转发到对应endpoint，负责写入规则至 IPTABLES、IPvs实现服务映射访间的</p>
</blockquote>
<h4 id="Flannel网络"><a href="#Flannel网络" class="headerlink" title="Flannel网络"></a>Flannel网络</h4><blockquote>
<p>维持各个节点上pod之间的通信。</p>
</blockquote>
<h3 id="4-3-重要组件"><a href="#4-3-重要组件" class="headerlink" title="4.3 重要组件"></a>4.3 重要组件</h3><h4 id="Coredns"><a href="#Coredns" class="headerlink" title="Coredns"></a>Coredns</h4><blockquote>
<p>可以为集群中的Svc创建一个域名IP的对应关系解析</p>
</blockquote>
<h4 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h4><blockquote>
<p>给K8S集群提供一个B/S结构访问体系</p>
</blockquote>
<h4 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h4><blockquote>
<p>官方只能实现四层代理， INGRESS可以实现七层代理</p>
</blockquote>
<h4 id="Federation"><a href="#Federation" class="headerlink" title="Federation"></a>Federation</h4><blockquote>
<p>提供一个可以跨集群中心多K8S统一管理功能</p>
</blockquote>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><blockquote>
<p>提供K8sS集群的监控能力</p>
</blockquote>
<h4 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h4><blockquote>
<p>提供K8s集群旦志统一分析介入平台</p>
</blockquote>
<h2 id="5-k8s网络架构概念"><a href="#5-k8s网络架构概念" class="headerlink" title="5. k8s网络架构概念"></a>5. k8s网络架构概念</h2><blockquote>
<p><strong>CNI（容器网络接口）</strong></p>
<p>CNI是Container Network Interface的是一个标准的，通用的接口。现在容器平台：docker，kubernetes，mesos，容器网络解决方案：flannel，calico，weave。只要提供一个标准的接口，就能为同样满足该协议的所有容器平台提供网络功能，而CNI正是这样的一个标准接口协议。</p>
<p><strong>pod的通信分类</strong></p>
<p>同一个Pod内的多个容器之间：lo Network</p>
<p>各Pod之间 或 不同主机各Pod 的通讯：Over lay Network</p>
<p>Pod 与 Service之间的通讯：各节点的 Iptables规则 或者 IPVS</p>
</blockquote>
<p><strong>K8S整体网络模型图</strong></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uohgqrvj30lu0gzgno.jpg"></p>
<p><strong>K8S中的三种网络</strong></p>
<blockquote>
<p>node网络：负责不同主机之间的pod通信的入口和出口（物理网络）</p>
<p>service网络：负责对外提供服务（暴露网络）</p>
<p>pod网络：负责pod内部容器之间的通信 和 pod 与 pod之间的通信（内部网络）</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upe69bgj30w30g3gqb.jpg" alt="image-20200920141256555"></p>
<p><strong>K8S的网络通讯原理</strong></p>
<blockquote>
<p><strong>同一个Pod内部通讯：</strong></p>
<ul>
<li>同一个Pod共享同一个网络命名空间，共享同一个 Linux协议栈。</li>
</ul>
<p><strong>Pod1 至 Pod2：</strong></p>
<ul>
<li>Pod1至Pod2不在同一台主机：Pod的地址是与 docker0在同一个网段的，但 docker0网段与宿主机网卡是两个完全不同的IP网段，并且不同Node之间的通信只能通过宿主机的物理网卡进行。将PoIP和所在 Node’MJIP关联起来，通过这个关联让Pod可以互相访问</li>
<li>Podl与Pod2在同一台机器：由 Docker0网桥直接转发请求至Pod2，不需要经过 Flannel</li>
</ul>
<p><strong>Pod 至 Service的网络：</strong></p>
<ul>
<li>iptables 或者 IPVS维护和转发</li>
</ul>
<p><strong>Pod到外网：</strong></p>
<ul>
<li>Pod向外网发送请求，查找路由表，转发数据包到宿主机的网卡，宿主网卡完成路由选择后， iptables执行 Masquerade，把源IP更改为宿主网卡的IP，然后向外网服务器发送请求</li>
</ul>
<p><strong>外网访问Pod：</strong></p>
<ul>
<li>访问对应的Service即可</li>
</ul>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upifvlkj319g0kznpg.jpg" alt="ees"></p>
<h2 id="6-Kubernetes核心概念"><a href="#6-Kubernetes核心概念" class="headerlink" title="6. Kubernetes核心概念"></a>6. Kubernetes核心概念</h2><h3 id="6-1-container"><a href="#6-1-container" class="headerlink" title="6.1 container"></a>6.1 container</h3><blockquote>
<p>容器可以运行服务和程序，容器是独立运行的一个或一组应用。容器可以进行启动、开始、停止、删除等操作，每个容器都是相互隔离的。可以把容器看作是一个简易版的linux环境（包括root用户权限、进程空间、用户空间和网络空间等）和运行其中的应用程序。</p>
</blockquote>
<h3 id="6-2-namespace"><a href="#6-2-namespace" class="headerlink" title="6.2 namespace"></a>6.2 namespace</h3><blockquote>
<p>可以将一个物理的cluster逻辑上划分成多个虚拟cluster，每个cluster就是一个namespace。不同的namespace里的资源是完全隔离的。</p>
</blockquote>
<h3 id="6-3-labels"><a href="#6-3-labels" class="headerlink" title="6.3 labels"></a>6.3 labels</h3><blockquote>
<p>标签用于区分对象（比如pod和services）, kubernetes中的任意对象都是通过label进行标识，label的实质是一系列的key/value键值对，其中key与value由用户自己指定。label可以附加到各种资源对象上，如node、pod、service、RC等，一个资源对象可以定义任意数量的label，可以通过label selector（标签选择器）查询和筛选资源对象。label是rc和service运行的基础，两者通过label来进行关联node上运行的pod</p>
</blockquote>
<h3 id="6-4-pod"><a href="#6-4-pod" class="headerlink" title="6.4 pod"></a>6.4 pod</h3><blockquote>
<p>在kubernetes系统中, pod是最小部署单元, 一个pod包含一个或多个容器（一组容器的集合）,<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/"> pod</a> 是一个可以被创建、销毁、调度、管理的最小部署单元。kubernates为每个pod都分配了唯一的ip地址, 称之为PodIP, 一个pod里的多个容器共享podip地址，它负责外部跟容器之间进行通信。</p>
<p>Pod主要分为两种类型：1、自主式pod，2、控制器管理pod</p>
<p>pod是kubernetes最重要的基本概念，也是k8s中的最小运行单元，一个pod中可以运行一个或多个的container及一个管理 container——pause</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upmukg7j30wp0hgmyd.jpg" alt="image"></p>
<h3 id="6-5-Controller-Manager"><a href="#6-5-Controller-Manager" class="headerlink" title="6.5 Controller Manager"></a>6.5 Controller Manager</h3><blockquote>
<p>Controller Manager 由 kube-controller-manager 和 cloud-controller-manager 组成， 是Kubernetes 的大脑， 它通过 apiserver 监控整个集群的状态， 并确保集群处于预期的工作状态。</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7upq32y4j30of0fqn0l.jpg" alt="image-20210226110055294"></p>
<h3 id="6-6-services"><a href="#6-6-services" class="headerlink" title="6.6 services"></a>6.6 services</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxk/p/9605901.html">services</a> 是kubernetes最外围的单元，通过虚拟一个访问ip及服务端口，可以访问我们定义好的pod资源，是通过iptables的nat转发来实现，转发的目标端口为kube_proxy生成的随机端口。services代理pod集合对外表现是一个访问入口，分配一个集群ip地址，来自这个ip的请求将负载均衡转发后端pod中的容器，service通过lable selector选择一组pod提供服务。</p>
</blockquote>
<p>deployment可以部署多个副本，每个pod 都有自己的IP，外界如何访问这些副本那？</p>
<p>答案是：service</p>
<p>k8s的 service定义了外界访问一组特定pod的方式。service有自己的IP和端口，service为pod提供了负载均衡。</p>
<p>k8s运行容器pod与访问容器这两项任务分别由controller和service执行。</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uptd7wbj30su0jcjya.jpg" alt="image-20200920132730652"></p>
<blockquote>
<p><strong>K8S-Service类型：</strong></p>
</blockquote>
<p>ClusterIp：默认类型，自动分配一个仅Cluster内部可以访问的虚拟IP</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1grndlevtw8j30ey09yaab.jpg"></p>
<p>NodePort：在ClusterIP基础上为Service在每台机器上绑定一个端口，这样可以通过NodeIP:NodePort来访问服务</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1grndmm5ymqj30fc07swer.jpg"></p>
<p>LoadBalancer：在NodePort基础上，借助cloud provider创建一个外部负载均衡器，并将请求转发到NodeIP:NodePort</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7ur6odhwj30fg0fzabf.jpg"></p>
<h1 id="二、部署K8S集群（kubeadm）"><a href="#二、部署K8S集群（kubeadm）" class="headerlink" title="二、部署K8S集群（kubeadm）"></a>二、部署K8S集群（kubeadm）</h1><blockquote>
<p>准备三台Linux虚拟机（K8S集群三台起步），系统用CentOS7.4，虚拟机配置是2颗CPU和2G内存（K8S最低要求的配置），网络使用桥接网卡方式并使用静态IP</p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>角色描述</th>
</tr>
</thead>
<tbody><tr>
<td>Master</td>
<td>ens32:192.168.2.1</td>
<td>K8S Master节点/ETCD节点</td>
</tr>
<tr>
<td>Node1</td>
<td>ens32:192.168.2.2</td>
<td>K8S Node节点</td>
</tr>
<tr>
<td>Node2</td>
<td>ens32:192.168.2.3</td>
<td>K8S Node节点</td>
</tr>
<tr>
<td>harbor</td>
<td>ens32:192.168.2.4</td>
<td>docker 镜像仓库节点</td>
</tr>
</tbody></table>
<h2 id="1-系统环境初始化"><a href="#1-系统环境初始化" class="headerlink" title="1. 系统环境初始化"></a>1. 系统环境初始化</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改主机名</span></span><br><span class="line">hostnamectl set-hostname master1</span><br><span class="line">hostnamectl set-hostname node1</span><br><span class="line">hostnamectl set-hostname node2</span><br><span class="line">hostnamectl set-hostname harbor</span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置系统时区为中国/上海</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前的 UTC 时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启依赖于系统时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载阿里源</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装相关依赖</span></span><br><span class="line">yum install -y epel-release conntrack ntpdate ntp ipvsadm ipset iptables-services iptables curl sysstat libseccomp wget unzip net-tools git yum-utils jq  device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步时间</span></span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加hosts</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="string">192.168.2.1 master1</span></span><br><span class="line"><span class="string">192.168.2.2 node1</span></span><br><span class="line"><span class="string">192.168.2.3 node2</span></span><br><span class="line"><span class="string">192.168.2.4 hub.lemon.com</span></span><br><span class="line"><span class="string">199.232.68.133 raw.githubusercontent.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置防火墙为 Iptables 并设置空规则</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">systemctl  start iptables</span><br><span class="line">systemctl  <span class="built_in">enable</span> iptables</span><br><span class="line">iptables -F  &amp;&amp;  service iptables save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭swap、selinux</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭系统不需要服务</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl <span class="built_in">disable</span> postfix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 rsyslogd 和 systemd journald</span></span><br><span class="line"><span class="comment"># 持久化保存日志的目录</span></span><br><span class="line">mkdir /var/<span class="built_in">log</span>/journal</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Journal]</span></span><br><span class="line"><span class="string"># 持久化保存到磁盘</span></span><br><span class="line"><span class="string">Storage=persistent</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 压缩历史日志</span></span><br><span class="line"><span class="string">Compress=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SyncIntervalSec=5m</span></span><br><span class="line"><span class="string">RateLimitInterval=30s</span></span><br><span class="line"><span class="string">RateLimitBurst=1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 最大占用空间 10G</span></span><br><span class="line"><span class="string">SystemMaxUse=10G</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 单日志文件最大 200</span></span><br><span class="line"><span class="string">MSystemMaxFileSize=200M</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 日志保存时间 2 周</span></span><br><span class="line"><span class="string">MaxRetentionSec=2week</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 不将日志转发到 syslog</span></span><br><span class="line"><span class="string">ForwardToSyslog=no</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<h2 id="2-升级系统内核并优化"><a href="#2-升级系统内核并优化" class="headerlink" title="2. 升级系统内核并优化"></a>2. 升级系统内核并优化</h2><blockquote>
<p>CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如：</p>
<p>高版本的 docker(1.13 以后) 启用了 3.10 kernel 实验支持的 kernel memory account 功能(无法关闭)，当节点压力大如频繁启动和停止容器时会导致 cgroup memory leak；网络设备引用计数泄漏, 会导致类似于报错：”kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1”;</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方案：升级内核到 4.4.X 以上；</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载内核源</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最新版本内核</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用内核</span></span><br><span class="line">cat /boot/grub2/grub.cfg |grep menuentry</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核启动项</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级系统文件</span></span><br><span class="line">yum update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 设置开机从新内核启动 &amp; 重启系统</span></span><br><span class="line">grub2-set-default <span class="string">&quot;CentOS Linux (4.4.236-1.el7.elrepo.x86_64) 7 (Core)&quot;</span> &amp;&amp; reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核</span></span><br><span class="line">uname -r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-proxy开启ipvs的前置条件</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自加载</span></span><br><span class="line">chmod a+x /etc/rc.d/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash /etc/sysconfig/modules/ipvs.modules&#x27;</span> &gt;&gt; /etc/rc.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化内核参数</span></span><br><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># 关闭IPV6协议</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启网桥模式</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启路由转发</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 不检查物理内存是否够用</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启 OOM</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=1048576</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances=8192</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启的文件句柄数目</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启对大的文件数目</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ~~~</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=2310720</span></span><br><span class="line"><span class="string">vm.dirty_bytes=15728640</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自动加载</span></span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<h2 id="3-部署Docker、kubeadm、kubectl"><a href="#3-部署Docker、kubeadm、kubectl" class="headerlink" title="3. 部署Docker、kubeadm、kubectl"></a>3. 部署Docker、kubeadm、kubectl</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载阿里的docker源、Centos7源、kubernetes源</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">yum clean all &amp;&amp; yum makecache &amp;&amp; <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docke，记给docker换镜像源</span></span><br><span class="line">yum -y install docker-ce-18.09.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 /etc/docker 目录</span></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 daemon配置文件</span></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;: [&quot;https://p8hkkij9.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Kubeadm （主从配置）</span></span><br><span class="line"><span class="comment"># 这里正常情况下，master上安装kubeadm、kubectl，node只安装kubelet就行，不过都装上也没事。</span></span><br><span class="line">yum -y install kubeadm-1.15.1 kubectl-1.15.1 kubelet-1.15.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机启动kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>

<h2 id="4-初始化主节点"><a href="#4-初始化主节点" class="headerlink" title="4. 初始化主节点"></a>4. 初始化主节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s节点上提前下载k8s镜像</span></span><br><span class="line">cat image-k8s-v1_15_1.sh </span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">    kube-apiserver:v1.15.1</span><br><span class="line">    kube-controller-manager:v1.15.1</span><br><span class="line">    kube-scheduler:v1.15.1</span><br><span class="line">    kube-proxy:v1.15.1</span><br><span class="line">    pause:3.1</span><br><span class="line">    etcd:3.3.10</span><br><span class="line">    coredns:1.3.1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">bash image-k8s-v1_15_1.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像是否完善</span></span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k8s.gcr.io/kube-apiserver            v1.15.1             68c3eb07bfc3        14 months ago       207MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager   v1.15.1             d75082f1d121        14 months ago       159MB</span><br><span class="line">k8s.gcr.io/kube-scheduler            v1.15.1             b0b3c4c404da        14 months ago       81.1MB</span><br><span class="line">k8s.gcr.io/kube-proxy                v1.15.1             89a062da739d        14 months ago       82.4MB</span><br><span class="line">k8s.gcr.io/coredns                   1.3.1               eb516548c180        20 months ago       40.3MB</span><br><span class="line">k8s.gcr.io/etcd                      3.3.10              2c4adeb21b4f        21 months ago       258MB</span><br><span class="line">k8s.gcr.io/pause                     3.1                 da86e6ba6ca1        2 years ago         742kB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改kubeadm默认初始化配置模板</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubeadm config print init-defaults &gt; kubeadm-config.yaml</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># cat kubeadm-config.yaml </span></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  <span class="comment"># 填写好master1的IP地址</span></span><br><span class="line">  advertiseAddress: 192.168.2.1</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: master1</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line"><span class="comment"># 选择初始化的k8s集群版本镜像</span></span><br><span class="line">kubernetesVersion: v1.15.1</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  <span class="comment"># 原因是一会要用的flannel来解决pod的扁平化网络，而flannel默认的网段就是10.244.0.0/16，所以这就将pod的IP段设置为和flannel相同的IP段，免得后期再做修改</span></span><br><span class="line">  podSubnet: <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line"><span class="comment"># 下面这一段的意思是将默认的iptables调度方式改为为IPVS</span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">featureGates:</span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span></span><br><span class="line">mode: ipvs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化k8s集群</span></span><br><span class="line"><span class="comment"># 如果</span></span><br><span class="line"><span class="comment"># --experimental-upload-certs：可以让后来加入的主节点自动加入证书；注：v1.15以上版本的参数已改为--upload-certs</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubeadm init --config=kubeadm-config.yaml --experimental-upload-certs | tee kubeadm-init.log</span></span><br></pre></td></tr></table></figure>

<h2 id="5-加入主节点以及其余工作节点"><a href="#5-加入主节点以及其余工作节点" class="headerlink" title="5. 加入主节点以及其余工作节点"></a>5. 加入主节点以及其余工作节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># cat kubeadm-init.log</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.2.1:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4dc6790b3232bc4fd7f80e614d38e21b15cfd3d318f09b596b68336375b381e4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查kubelet服务是否已经打开</span></span><br><span class="line">systemctl status kubelet | grep running</span><br><span class="line">   Active: active (running) since 日 2020-09-13 01:53:32 CST; 6min ago</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是会发现节点的状态是NotReady</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1   NotReady   master   11m     v1.15.1</span><br><span class="line">node1     NotReady   &lt;none&gt;   2m13s   v1.15.1</span><br><span class="line">node2     NotReady   &lt;none&gt;   2m10s   v1.15.1</span><br></pre></td></tr></table></figure>

<p><strong>这就需要下面来部署flannel来解决扁平化网络问题</strong></p>
<h2 id="6-部署-CNI-flannel网络"><a href="#6-部署-CNI-flannel网络" class="headerlink" title="6. 部署 CNI - flannel网络"></a>6. 部署 CNI - flannel网络</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署flannel全覆盖网络</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再来检查节点状态</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS   ROLES    AGE     VERSION</span><br><span class="line">master1   Ready    master   18m     v1.15.1</span><br><span class="line">node1     Ready    &lt;none&gt;   8m38s   v1.15.1</span><br><span class="line">node2     Ready    &lt;none&gt;   8m35s   v1.15.1+</span><br></pre></td></tr></table></figure>

<h2 id="7-查看集群状态-和相关的容器"><a href="#7-查看集群状态-和相关的容器" class="headerlink" title="7. 查看集群状态 和相关的容器"></a>7. 查看集群状态 和相关的容器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br><span class="line">NAME      STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME</span><br><span class="line">master1   Ready    master   20m   v1.15.1   192.168.2.1   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line">node1     Ready    &lt;none&gt;   10m   v1.15.1   192.168.2.2   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line">node2     Ready    &lt;none&gt;   10m   v1.15.1   192.168.2.3   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod --all-namespaces -o wide</span></span><br><span class="line">NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE    IP            NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-5c98db65d4-57czz          1/1     Running   4          136d   10.244.0.9    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-5c98db65d4-s9fsm          1/1     Running   4          136d   10.244.0.8    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-master1                      1/1     Running   3          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-master1            1/1     Running   3          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-master1   1/1     Running   3          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-6qw52       1/1     Running   20         136d   192.168.2.3   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-hj7wr       1/1     Running   1          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-wc96r       1/1     Running   20         136d   192.168.2.2   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-5xcpl                  1/1     Running   5          136d   192.168.2.3   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-lwjps                  1/1     Running   4          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-r77pb                  1/1     Running   4          136d   192.168.2.2   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-master1            1/1     Running   3          136d   192.168.2.1   master1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="8-搭建配置harbor私有仓库"><a href="#8-搭建配置harbor私有仓库" class="headerlink" title="8. 搭建配置harbor私有仓库"></a>8. 搭建配置harbor私有仓库</h2><blockquote>
<p>安装Harbor需要先安装docker和docker-compose，上面的系统初始化、系统升级和优化、安装Docker的步骤这里不再陈述</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在所有docker节点的daemon.json文件上添加下面信任配置</span></span><br><span class="line">cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://p8hkkij9.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;https://hub.lemon.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#~~ 这里先不急着重启docker，等一会颁发完证书之后在重启</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Harbor节点上安装docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.14.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># chmod a+x docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># mv docker-compose /usr/local/bin/</span></span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.23.2, build 1110ad01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Harbor私有hub，创建CA证书</span></span><br><span class="line">[root@harbor ~]<span class="comment"># which openssl</span></span><br><span class="line">/usr/bin/openssl</span><br><span class="line">[root@harbor ~]<span class="comment"># mkdir -p /data/ssl &amp;&amp; cd /data/ssl/</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7utpkiy4j30of052aax.jpg"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7utsp2asj30nc03oglx.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生成证书签名请求</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout hub.lemon.com.key -out hub.lemon.com.csr</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uw7j1trj30o808kta2.jpg"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uwcz6dbj30o808kta2.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成注册表主机证书</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># openssl x509 -req -days 365 -in hub.lemon.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out hub.lemon.com.crt</span></span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=CN/ST=Beijing/L=Beijing/O=lemon/OU=hub/CN=hub.lemon.com</span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看生成的证书</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpxgfacwj30le06kwff.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 信任自签发的域名证书</span></span><br><span class="line"><span class="comment"># 由于linux操作系统不信任自签发的CA证书，所以需要把证书加入到系统的信任证书里</span></span><br><span class="line"><span class="comment"># 添加自签证书到系统</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># cp hub.lemon.com.crt /etc/pki/ca-trust/source/anchors/</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># ls -lh /etc/pki/ca-trust/source/anchors/</span></span><br><span class="line">总用量 4.0K</span><br><span class="line">-rw-r--r-- 1 root root 1.9K 9月  13 02:23 hub.lemon.com.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让系统CA信任立刻生效</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># update-ca-trust enable</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># update-ca-trust extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果已经启动Docker了，必须要重启；如果安装过Harbor以后再重启的话，有可能会出现harbor连不上的情况，需要重新把Harbor启动的容器和镜像删除后，重新install一遍</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建harbor的证.目录</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># mkdir -p /usr/local/harbor/ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制域名证到harbor要安装的路径</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># cp hub.lemon.com.crt hub.lemon.com.key /usr/local/harbor/ssh/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装测试，上传harbor安装包并解压到相应路径</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpy9cumlj30qr03rdg2.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># tar xf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line">[root@harbor ~]<span class="comment"># mv harbor/* /usr/local/harbor/</span></span><br><span class="line">[root@harbor ~]<span class="comment"># cd /usr/local/harbor/ &amp;&amp; ls</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gsfpyrtm7yj60ns02eglt02.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># harbor配置备份 &amp; 修改配置文件</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># cp harbor.yml harbor.yml.bak</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># vim harbor.yml</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uwy44bgj30vd0l93zq.jpg" alt="gggg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成配置 &amp; 安装（需联网）</span></span><br><span class="line"><span class="comment"># 下载harbor所需镜像</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># ./prepare</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/prepare    v1.9.0              aa594772c1e8        12 months ago       147MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Harbor</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># ./install.sh --with-notary --with-clair --with-chartmuseum</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor日志文件存放路径为/var/log/harbor/</span></span><br><span class="line"><span class="comment"># 如果需要修改Harbor的配置文件harbor.yml，因为Harbor是基于docker-compose服务编排的，我们可以使用docker-compose命令重启Harbor。不修改配置文件，重启Harbor命令：docker-compose start | stop | restart</span></span><br><span class="line">1、停止Harbor</span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose -f /usr/local/harbor/docker-compose.yml down</span></span><br><span class="line"></span><br><span class="line">2、启动Harbor</span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose -f /usr/local/harbor/docker-compose.yml up -d</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uxxrfp3j30p704ojrx.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开机自运行</span></span><br><span class="line">[root@harbor ~]<span class="comment"># cat &lt;&lt;END&gt;&gt; /etc/rc.local </span></span><br><span class="line">docker-compose -f /usr/<span class="built_in">local</span>/harbor/docker-compose.yml up -d</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">[root@harbor ~]<span class="comment"># chmod u+x /etc/rc.d/rc.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录Harbor仓库</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># docker login https://hub.lemon.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: Harbor12345</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端测试是否能够访问（须在客户端加入hosts）</span></span><br><span class="line">https://hub.lemon.com/</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uzrb0nrj30zh0mk3z9.jpg"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7uzvvy8tj30zg0d1wfg.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便在一个节点上测试docker是否能使用harbor库</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker login https://hub.lemon.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># docker pull httpd</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker tag httpd:latest hub.lemon.com/library/httpd:v1  #打好标签</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker rmi httpd:latest</span></span><br><span class="line">Untagged: httpd:latest</span><br><span class="line">Untagged: httpd@sha256:0fce91cc167634ede639701b7dd1d8093f4ad2f2d9d0d5a8f4be2eaef8a570fb</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v01ysnzj30yw08otay.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># docker push hub.lemon.com/library/httpd:v1    #推送至harbor仓库</span></span><br><span class="line">The push refers to repository [hub.lemon.com/library/httpd]</span><br><span class="line">f1fee4547086: Pushed </span><br><span class="line">a6a46c0268b1: Pushed </span><br><span class="line">951b1be5cf2d: Pushed </span><br><span class="line">d37da03a9458: Pushed </span><br><span class="line">07cab4339852: Pushed </span><br><span class="line">v1: digest: sha256:8c9bc11ca46ffd0b6b8a00e30aa670abef6c0d5d308e318a5cb8cf9e23931649 size: 1367</span><br><span class="line"><span class="comment"># 回到浏览器查看</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v05lx1ej30zk0ehjsd.jpg"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0cpenuj31020bgmxn.jpg" alt="iiii"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes拉取harbor库镜像创建pod</span></span><br><span class="line"><span class="comment"># 在此之前先将打标签的镜像删除</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker rmi hub.lemon.com/library/httpd:v1</span></span><br><span class="line">Untagged: hub.lemon.com/library/httpd:v1</span><br><span class="line">Untagged: hub.lemon.com/library/httpd@sha256:8c9bc11ca46ffd0b6b8a00e30aa670abef6c0d5d308e318a5cb8cf9e23931649</span><br><span class="line">Deleted: sha256:6d82971d37d087be9917ab2015a4dc807569c736d3f2017c0821ddc4ed126617</span><br><span class="line">Deleted: sha256:59a897aaa844713f078ea9234bd61b0f4885598a9ffb1267b4c59983813abb52</span><br><span class="line">Deleted: sha256:6942605f2c5a8ba622491e369f2585daafe749a645835f5abb4fb9d11803664d</span><br><span class="line">Deleted: sha256:0f44970c8ecb7e1107f45ff7d5a7f7f3799a9821dce5cd30c51f2f7641339665</span><br><span class="line">Deleted: sha256:97635989e45ed57deef09cd09be52d008a073f2e1e045a1ba91956fbc2db2961</span><br><span class="line">Deleted: sha256:07cab433985205f29909739f511777a810f4a9aff486355b71308bb654cdc868</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于harbor仓库的镜像启动Pod</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl run httpd-01 --image=hub.lemon.com/library/httpd:v1 --port=80 --replicas=1</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/httpd-01 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有deployment</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   1/1     1            1           21s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有rs（RESTARTS副本）</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">httpd-01-6c9fbcfb65   1         1         1       47s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有pod</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   0          58s</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   0          69s   10.244.1.2   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互式执行容器命令</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-9hlhv ls</span></span><br><span class="line">bin  build  cgi-bin  conf  error  htdocs  icons  include  logs	modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问这个pod的IP</span></span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.244.1.2</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有已经退出的容器</span></span><br><span class="line">docker rm -v $(docker ps -qa -f status=exited)</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0od5jbj30zh0cyjs2.jpg" alt="k"></p>
<h2 id="9-基本的使用下K8S"><a href="#9-基本的使用下K8S" class="headerlink" title="9. 基本的使用下K8S"></a>9. 基本的使用下K8S</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pod的详细信息</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   1          12h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试删除这个pod容器后，k8s会不会重新策划这个pod</span></span><br><span class="line">kubectl -n default delete pod httpd-01-6c9fbcfb65-jvmc8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证, 可以看到k8s看到副本的期望值不符合之后，就会马上新起来一个pod来满足这个期望值</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在生产环境下发现一个副本的pod已经不够用了，需要扩容</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default scale --replicas=3  deployment/httpd-01</span></span><br><span class="line">deployment.extensions/httpd-01 scaled</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   3/3     3            3           12h</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          51s</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          51s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h    10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          2m8s   10.244.2.3   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          2m8s   10.244.2.2   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment"># 能够看到，已经扩容成功了，没错，就是这么简单~~</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是现在又引来了一个新的问题，我有三个容器，端口一样，但ip确是不一样的，外界该要怎么访问这个pod呢？</span></span><br><span class="line"><span class="comment"># 答：使用SVC来实现</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl expose --help|grep -A 1 &#x27;Create a service for an nginx&#x27;</span></span><br><span class="line">  <span class="comment"># Create a service for an nginx deployment, which serves on port 80 and connects to the containers on port 8000.</span></span><br><span class="line">  kubectl expose deployment nginx --port=80 --target-port=8000</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 查看一下deployment名称</span></span><br><span class="line"> [root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   3/3     3            3           13h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建svc</span></span><br><span class="line"> [root@master1 ~]<span class="comment"># kubectl expose deployment httpd-01 --port=88 --target-port=80</span></span><br><span class="line"> service/httpd-01 exposed</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 查看一下svc地址</span></span><br><span class="line"> [root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">httpd-01     ClusterIP   10.99.191.162   &lt;none&gt;        88/TCP    30s   run=httpd-01</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   13h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里为了好验证负载均衡，在访问之前先修改容器网页</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          13h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          23m   10.244.2.3   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          23m   10.244.2.2   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-9hlhv bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-9hlhv:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node1-10.244.1.3&#x27; &gt; htdocs/index.html </span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-hjhjn bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-hjhjn:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node2-10.244.2.3&#x27; &gt; htdocs/index.html</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-x52hh bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-x52hh:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node2-10.244.2.2&#x27; &gt; htdocs/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问SVC从而以负载均衡的方式访问到pod副本</span></span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.3</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.2</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node1-10.244.1.3</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原理：查看下ipvsadm规则</span></span><br><span class="line">[root@master1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.2.1:6443             Masq    1      3          0         </span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.6:53                Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:53                Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line">  -&gt; 10.244.0.6:9153              Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:9153              Masq    1      0          0         </span><br><span class="line"><span class="comment"># 这就是刚才创建的SVC，实际上他就是一个转发规则</span></span><br><span class="line">TCP  10.99.191.162:88 rr</span><br><span class="line">  -&gt; 10.244.1.3:80                Masq    1      0          1         </span><br><span class="line">  -&gt; 10.244.2.2:80                Masq    1      0          1         </span><br><span class="line">  -&gt; 10.244.2.3:80                Masq    1      0          2         </span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.6:53                Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:53                Masq    1      0          0</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面做的其实只能在内部访问，如果像对外开放的话，需将原本svc的type类型改为NodePort类型，因为默认的ClusterIP类型只是针对这个集群，封闭不对外暴露的。</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl edit svc httpd-01</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2020-09-13T07:50:56Z&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    run: httpd-01</span><br><span class="line">  name: httpd-01</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;21567&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/services/httpd-01</span><br><span class="line">  uid: 624c99c1-b27f-4990-aa5b-d381e0a37755</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.99.191.162</span><br><span class="line">  ports:</span><br><span class="line">  - port: 88</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    run: httpd-01</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再来查看这个svc的类型</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">httpd-01     NodePort    10.99.191.162   &lt;none&gt;        88:32552/TCP   28m   run=httpd-01</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        14h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会发现它基于上面的88端口对外打开了一个随机端口32552提供服务，而且是将所有k8s节点都打开了这个端口号对外服务</span></span><br><span class="line">[root@master1 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1945/kube-proxy</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1568/kube-proxy</span><br><span class="line"></span><br><span class="line">[root@node2 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1601/kube-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 外界访问</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v0wtpolj30ut03wmxk.jpg" alt="kk"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v12fx9qj30uq045mxk.jpg" alt="kkk"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v182350j30uv04dwew.jpg" alt="kkkk"></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v1bofyrj30uy03owew.jpg" alt="kkkkk"></p>
<p><em><strong>至此整体kubernetes集群架构搭建完成</strong></em></p>
<h1 id="三、Kubectl常用命令"><a href="#三、Kubectl常用命令" class="headerlink" title="三、Kubectl常用命令"></a>三、Kubectl常用命令</h1><blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">kubectl官方详细命令</a></strong></p>
</blockquote>
<h2 id="1-查看集群状态"><a href="#1-查看集群状态" class="headerlink" title="1. 查看集群状态"></a>1. 查看集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看客户端及服务端程序版本信息</span></span><br><span class="line">kubectl version --short=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">kubectl cluster-info </span><br></pre></td></tr></table></figure>

<h2 id="2-创建资源对象"><a href="#2-创建资源对象" class="headerlink" title="2. 创建资源对象"></a>2. 创建资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod资源</span></span><br><span class="line">kubectl run name --image=(镜像名) --replicas=(副本数) --port=(容器要暴露的端口) --labels=(设定自定义标签)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 陈述式对象配置管理方式</span></span><br><span class="line">kubectl create -f **.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明式对象配置管理方式（也适用于更新等）</span></span><br><span class="line">kubectl apply -f **.yaml</span><br></pre></td></tr></table></figure>

<h2 id="3、查看资源对象"><a href="#3、查看资源对象" class="headerlink" title="3、查看资源对象"></a>3、查看资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间</span></span><br><span class="line">kubectl get namespace</span><br><span class="line"></span><br><span class="line"><span class="comment"># -o 输出格式, wide表示plain-text</span></span><br><span class="line">kubectl get pods,services -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># -l 标签选择器(多个的话是与逻辑)，-n 指定命名空间，不指定默认default</span></span><br><span class="line">kubectl get pod -l <span class="string">&quot;key=value,key=value&quot;</span> -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># -l 基于集合的标签选择器, -L查询结果显示标签</span></span><br><span class="line"><span class="comment"># 注意: 为了避免和shell解释器解析!, 必须要为此类表达式使用单引号</span></span><br><span class="line">kubectl get pod -l <span class="string">&quot;key1 in (val1,val2),!key2&quot;</span> -L key </span><br><span class="line"></span><br><span class="line"><span class="comment"># -w 监视资源变动信息</span></span><br><span class="line">kubectl get pod -w</span><br></pre></td></tr></table></figure>

<h2 id="4、打印容器中日志信息"><a href="#4、打印容器中日志信息" class="headerlink" title="4、打印容器中日志信息"></a>4、打印容器中日志信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f 持续监控，-c如果pod中只有一个容器不用加</span></span><br><span class="line">kubectl logs name -f -c container_name -n kube-system</span><br></pre></td></tr></table></figure>

<h2 id="5、在容器中执行命令"><a href="#5、在容器中执行命令" class="headerlink" title="5、在容器中执行命令"></a>5、在容器中执行命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器外部执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> name -c container_name -n kube-system -- 具体命令</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器内部执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod_name /bin/sh 进入容器的交互式shell</span><br></pre></td></tr></table></figure>

<h2 id="6、删除资源对象"><a href="#6、删除资源对象" class="headerlink" title="6、删除资源对象"></a>6、删除资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除指定资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除kube-system下指定标签的资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] -l key=value -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除kube-system下所有资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] --all -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制删除Terminating的资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] source_name --force --grace-period=0 -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般不用这种方式删除</span></span><br><span class="line">kubectl delete -f xx.yaml</span><br><span class="line">kubectl apply -f xx.yaml --prune -l &lt;labels&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认删除控制器会同时删除其管控的所有Pod对象，加上cascade=false就只删除rs</span></span><br><span class="line">kubectl delete rs rs_name --cascade=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="7、更新资源对象"><a href="#7、更新资源对象" class="headerlink" title="7、更新资源对象"></a>7、更新资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --force 如果需要基于此前的配置文件进行替换，需要加上force</span></span><br><span class="line">kubectl replace -f xx.yaml --force</span><br></pre></td></tr></table></figure>

<h2 id="8、将服务暴露出去-创建Service"><a href="#8、将服务暴露出去-创建Service" class="headerlink" title="8、将服务暴露出去(创建Service)"></a>8、将服务暴露出去(创建Service)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployments/deployment_name --<span class="built_in">type</span>=<span class="string">&quot;NodePort&quot;</span> --port=(要暴露的容器端口) --name=(Service对象名字)</span><br></pre></td></tr></table></figure>

<h2 id="9、扩容和缩容"><a href="#9、扩容和缩容" class="headerlink" title="9、扩容和缩容"></a>9、扩容和缩容</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment/deployment_name --replicas=N</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有当前副本数等于M时才会执行扩容或者缩容</span></span><br><span class="line">kubectl scale deployment/deployment_name --replicas=N --current-replicas=M</span><br></pre></td></tr></table></figure>

<h2 id="10、查看API版本"><a href="#10、查看API版本" class="headerlink" title="10、查看API版本"></a>10、查看API版本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-versions</span><br></pre></td></tr></table></figure>

<h2 id="11、在本地主机上为API-Server启动一个代理网关"><a href="#11、在本地主机上为API-Server启动一个代理网关" class="headerlink" title="11、在本地主机上为API Server启动一个代理网关"></a>11、在本地主机上为API Server启动一个代理网关</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 之后就可以通过curl来对此套字节发起访问请求</span></span><br><span class="line">kubectl proxy --port=8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># jq可以对json进行过滤)</span></span><br><span class="line">curl localhost:8080/api/v1/namespaces/ | jq .items[].metadata.name</span><br></pre></td></tr></table></figure>

<h2 id="12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释"><a href="#12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释" class="headerlink" title="12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释"></a>12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二级对象可用类似于pods.spec这种方式查看</span></span><br><span class="line">kubectl explain pods/deployments/...</span><br></pre></td></tr></table></figure>

<h2 id="13、查看某资源对象的配置文件"><a href="#13、查看某资源对象的配置文件" class="headerlink" title="13、查看某资源对象的配置文件"></a>13、查看某资源对象的配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --export表示省略由系统生成的信息, 后面加 &gt; file.yaml就可以快速生成一个配置文件了</span></span><br><span class="line">kubectl get source_type source_name -o yaml --<span class="built_in">export</span></span><br></pre></td></tr></table></figure>

<h2 id="14、标签管理相关命令"><a href="#14、标签管理相关命令" class="headerlink" title="14、标签管理相关命令"></a>14、标签管理相关命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加标签,如果是修改的话需要后面添加--overwrite</span></span><br><span class="line">kubectl label pods/pod_name key=value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给工作节点添加标签，后续可以使用nodeSelector来指定pod被调度到指定的工作节点上运行</span></span><br><span class="line">kubectl label nodes node_name key=value</span><br></pre></td></tr></table></figure>

<h2 id="15、注解管理相关命令"><a href="#15、注解管理相关命令" class="headerlink" title="15、注解管理相关命令"></a>15、注解管理相关命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl annotate pods pod_name key=value</span><br></pre></td></tr></table></figure>

<h2 id="16、patch修改Deployment控制器进行控制器升级"><a href="#16、patch修改Deployment控制器进行控制器升级" class="headerlink" title="16、patch修改Deployment控制器进行控制器升级"></a>16、patch修改Deployment控制器进行控制器升级</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -p 以补丁形式更新补丁形式默认是json</span></span><br><span class="line">kubectl patch deployment deployment-demo -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;minReadySeconds&quot;: 5&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改depolyment中的镜像文件</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployments deployment-demo myapp=ikubernetes/myapp:v2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印滚动更新过程中的状态信息</span></span><br><span class="line">kubectl rollout status deployment deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控deployment的更新过程</span></span><br><span class="line">kubectl get deployments deployment-demo --watch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停更新</span></span><br><span class="line">kubectl rollout pause deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续更新</span></span><br><span class="line">kubectl rollout resume deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史版本(能查到具体的历史需要在apply的时候加上--record参数)</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到指定版本，不加--to-version则回滚到上一个</span></span><br><span class="line">kubectl rollout undo deployments deployment-demo --to-revision=2</span><br></pre></td></tr></table></figure>



<h1 id="四、k8s的资源清单（重点）"><a href="#四、k8s的资源清单（重点）" class="headerlink" title="四、k8s的资源清单（重点）"></a>四、k8s的资源清单（重点）</h1><h2 id="1-资源类型"><a href="#1-资源类型" class="headerlink" title="1. 资源类型"></a>1. 资源类型</h2><blockquote>
<p><strong>k8s中所有的资源都会抽象为资源，资源实例化之后，叫做对象。</strong></p>
</blockquote>
<p><em><strong>分为以下三种：</strong></em></p>
<ul>
<li>名称空间级别</li>
<li>集群级别</li>
<li>元数据型级别</li>
</ul>
<h3 id="1-1-名称空间级别"><a href="#1-1-名称空间级别" class="headerlink" title="1.1 名称空间级别"></a>1.1 名称空间级别</h3><ul>
<li><p><strong>服务发现及负载均衡型资源（ ServiceDiscovery LoadBalance）：</strong> Service(SVC)、Ingress、……</p>
</li>
<li><p><strong>配置与存储型资源：</strong> Volume（存储卷）、CSI（容器存储接口，可以扩展各种各样的第三方存储卷）</p>
</li>
<li><p><strong>特殊类型的存储卷：</strong> ConfigMap（当配置中心来使用的资源类型）、Secret（保存敏感数据）、DownwardAPI（把外部环境中的信息输出给容器）</p>
</li>
<li><p><strong>工作负载型资源（workload）：</strong> Pod（pause）、Replicase、 Deployment、StatefulSet、DaemonSet、Job、Cron Job（Replication Controller在v1.11版本被废弃）</p>
</li>
</ul>
<h3 id="1-2-集群级资源级别"><a href="#1-2-集群级资源级别" class="headerlink" title="1.2 集群级资源级别"></a>1.2 集群级资源级别</h3><ul>
<li>Namespace</li>
<li>Node</li>
<li>Role</li>
<li>Clusterrole</li>
<li>RoleBinding</li>
<li>ClusterRoleBinding</li>
</ul>
<h3 id="1-3-元数据型资源"><a href="#1-3-元数据型资源" class="headerlink" title="1.3 元数据型资源"></a>1.3 元数据型资源</h3><ul>
<li><p>HPA</p>
</li>
<li><p>PodTemplate</p>
</li>
<li><p>Limi tRange</p>
</li>
</ul>
<h2 id="2-资源清单"><a href="#2-资源清单" class="headerlink" title="2. 资源清单"></a>2. 资源清单</h2><blockquote>
<p><strong>在k8s中，一般使用yaml格式的文件来创建符合我们预期期望的pod，这样的yaml文件我们一般称为资源清单</strong></p>
</blockquote>
<h3 id="2-1-yaml语法格式"><a href="#2-1-yaml语法格式" class="headerlink" title="2.1 yaml语法格式"></a>2.1 yaml语法格式</h3><blockquote>
<p>是一个可读性高，用来表达数据序列的格式。YAML 的意思其实是：仍是一种标记语言，但为了强调这种语言以数据做为中心，而不是以标记语言为重点。</p>
</blockquote>
<p><strong>基本语法</strong></p>
<ul>
<li>缩进时不允许使用Tab键，只允许使用空格</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li># 标识注释，从这个字符一直到行尾，都会被解释器忽略</li>
</ul>
<p><strong>YAML 支持的数据结构</strong></p>
<ul>
<li>对象：键值对的集合，又称为映射（mapping）、哈希（hashes）、字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence）、列表（list）</li>
<li>纯量（scalars）：单个的、不可再分的值</li>
</ul>
<p><strong>对象类型：对象的一组键值对，使用冒号结构表示</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Steve</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">18</span></span><br></pre></td></tr></table></figure>

<p>Yaml 也允许另一种写法，将所有键值对写成一个行内对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hash:</span> &#123; <span class="attr">name:</span> <span class="string">Steve</span>, <span class="attr">age:</span> <span class="number">18</span> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>数组类型：一组连词线开头的行，构成一个数组</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">animal</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Cat</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Dog</span></span><br></pre></td></tr></table></figure>

<p>数组也可以采用行内表示法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">animal:</span> [<span class="string">Cat</span>, <span class="string">Dog</span>]</span><br></pre></td></tr></table></figure>

<p><strong>复合结构：对象和数组可以结合使用，形成复合结构</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Ruby</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Perl</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Python</span></span><br><span class="line"><span class="attr">websites:</span></span><br><span class="line"><span class="attr">YAML:</span> <span class="string">yaml.org</span></span><br><span class="line"><span class="attr">Ruby:</span> <span class="string">ruby-lang.org</span></span><br><span class="line"><span class="attr">Python:</span> <span class="string">python.org</span></span><br><span class="line"><span class="attr">Perl:</span> <span class="string">use.perl.org</span>  </span><br></pre></td></tr></table></figure>

<p><strong>纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="string">字符串布尔值整数浮点数</span> <span class="literal">Null</span></span><br><span class="line"><span class="number">2</span> <span class="string">时间</span> <span class="string">日期</span></span><br><span class="line"></span><br><span class="line"><span class="string">数值直接以字面量的形式表示</span></span><br><span class="line"><span class="attr">number:</span> <span class="number">12.30</span></span><br><span class="line"></span><br><span class="line"><span class="string">布尔值用true和false表示</span></span><br><span class="line"><span class="attr">isSet:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="literal">null</span><span class="string">用</span> <span class="string">~</span> <span class="string">表示</span></span><br><span class="line"><span class="attr">parent:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="string">时间采用</span> <span class="string">ISO8601</span> <span class="string">格式</span></span><br><span class="line"><span class="attr">iso8601:</span> <span class="number">2001-12-14t21:59:43.10-05:00</span></span><br><span class="line"></span><br><span class="line"><span class="string">日期采用复合</span> <span class="string">iso8601</span> <span class="string">格式的年、月、日表示</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">1976-07-31</span></span><br><span class="line"></span><br><span class="line"><span class="string">YAML允许使用两个感叹号，强制转换数据类型</span></span><br><span class="line"><span class="attr">e:</span> <span class="type">!!str</span> <span class="number">123</span></span><br><span class="line"><span class="attr">f:</span> <span class="type">!!str</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>字符串</strong></p>
<p>字符串默认不使用引号表示</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">这是一行字符串</span></span><br></pre></td></tr></table></figure>

<p>如果字符串之中包含空格或特殊字符，需要放在引号之中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">&#x27;内容：字符串&#x27;</span></span><br></pre></td></tr></table></figure>

<p>单引号和双引号都可以使用，双引号不会对特殊字符转义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">s1:</span> <span class="string">&#x27;内容\n字符串&#x27;</span></span><br><span class="line"><span class="attr">s2:</span> <span class="string">&quot;内容\n字符串&quot;</span></span><br></pre></td></tr></table></figure>

<p>单引号之中如果还有单引号，必须连续使用两个单引号转义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">&#x27;labor&#x27;</span><span class="string">&#x27;s day&#x27;</span></span><br></pre></td></tr></table></figure>

<p>字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为空格</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">这是一段</span></span><br><span class="line">   <span class="string">多行</span></span><br><span class="line">   <span class="string">字符串</span></span><br></pre></td></tr></table></figure>

<p>多行字符串可以使用|保留换行符，也可以使用&gt;折叠换行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">this:</span> <span class="string">|</span></span><br><span class="line"><span class="string">Foo</span></span><br><span class="line"><span class="string">Bar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">that:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">Foo</span></span><br><span class="line"><span class="string">Bar</span></span><br></pre></td></tr></table></figure>

<p>+ 表示保留文字块末尾的换行，- 表示删除字符串末尾的换行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">s1:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  Foo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">s2:</span> <span class="string">|+</span></span><br><span class="line"><span class="string">  Foo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">s3:</span> <span class="string">|-</span></span><br><span class="line">  <span class="string">Foo</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-k8s剧本的常用字段"><a href="#2-2-k8s剧本的常用字段" class="headerlink" title="2.2 k8s剧本的常用字段"></a>2.2 k8s剧本的常用字段</h3><blockquote>
<p>必须存在的属性</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数名</th>
<th align="center">字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td align="center">String</td>
<td>K8S API 的版本，目前基本是v1，可以用 kubectl api-version 命令查询</td>
</tr>
<tr>
<td>kind</td>
<td align="center">String</td>
<td>这里指的是 yaml 文件定义的资源类型和角色, 比如: Pod</td>
</tr>
<tr>
<td>metadata</td>
<td align="center">Object</td>
<td>元数据对象，固定值写 metadata</td>
</tr>
<tr>
<td>metadata.name</td>
<td align="center">String</td>
<td>元数据对象的名字，这里由我们编写，比如命名Pod的名字</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td align="center">String</td>
<td>元数据对象的命名空间，由我们自身定义</td>
</tr>
<tr>
<td>Spec</td>
<td align="center">Object</td>
<td>详细定义对象，固定值写Spec</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td align="center">list</td>
<td>这里是Spec对象的容器列表定义，是个列表</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td align="center">String</td>
<td>这里定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td align="center">String</td>
<td>这里定义要用到的镜像名称</td>
</tr>
</tbody></table>
<blockquote>
<p>主要属性【这些属性比较重要，如果不指定的话系统会自动补充默认值】</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>这里定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>这里定义要用到的镜像名称</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td>定义镜像拉取策略，有Always、Never、IfNotPresent三个值可选（1）Always:意思是每次都尝试重新拉取镜像（2）Never:表示仅使用本地镜像（3）lfNotPresent:如果本地有镜像就使用本地镜像，没有就拉取在线镜像。上面三个值都没设置的话，默认是Always。</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令。</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组可以指定多个。</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录，进入容器时默认所在的目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的路径</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>String</td>
<td>设置存储卷路经的读写模式，true或者false，默认为读写模式</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认跟上面containerPort相同，注意设置了hostPort同一台主机无法启动该容器的相同副本（因为主机的端口号不能相同，这样会冲突)</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持TCP和UDP，默认值为 TCP</td>
</tr>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行前需设置的环境变量列表</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定CPU的限制，单位为core数，将用于docker run –cpu-shares参数这里前面文章 Pod资源限制有讲过）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定MEM内存的限制，单位为MlB、GiB</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度时的限制设置</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU请求，单位为core数，容器启动时初始化可用数量</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为MIB、GiB，容器启动的初始化可用数量</td>
</tr>
</tbody></table>
<blockquote>
<p>额外的参数项</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义Pod的重启策略，可选值为Always、OnFailure，默认值为Always。1.Always:Pod一旦终止运行，则无论容器是如何终止的，kubelet服务都将重启它。2.OnFailure:只有Pod以非零退出码终止时，kubelet才会重启该容器。如果容器正常结束（退出码为0），则kubelet将不会重启它。3.Never:Pod终止后，kubelet将退出码报告给Master，不会重启该Pod。</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定义Node的Label过滤标签，以key:value格式指定，选择node节点去运行</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td>定义pull镜像时使用secret名称，以name:secretkey格式指定</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为false。设置true表示使用宿主机网络，不使用docker网桥，同时设置了true将无法在同一台宿主机上启动第二个副本。</td>
</tr>
</tbody></table>
<blockquote>
<p>查看资源有那些资源清单属性，使用以下命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看属性说明，使用以下命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.apiVersion</span><br></pre></td></tr></table></figure>

<blockquote>
<p>资源清单格式</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">group/apiversion</span>     <span class="comment"># 如果没有给定group名称，那么默认为core，可以使用kubectlapi-versions命令获取当前k8s版本上所有的apiversion版本信息（每个版本可能不同）</span></span><br><span class="line"><span class="attr">kind:</span>          <span class="comment"># 资源类别</span></span><br><span class="line"><span class="attr">metadata:</span>      <span class="comment"># 资源元数据</span></span><br><span class="line"> <span class="attr">name:</span> </span><br><span class="line"> <span class="attr">namespace:</span> </span><br><span class="line"> <span class="attr">lables:</span> </span><br><span class="line"> <span class="attr">annotations:</span>  <span class="comment"># 主要目的是方便用户阅读查找</span></span><br><span class="line"><span class="attr">spec:</span>          <span class="comment"># 期望的状态（disired state)</span></span><br><span class="line"><span class="attr">status:</span>        <span class="comment"># 当前状态，本字段由Kubernetes自身维护，用户不能去定义</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>资源清单的常用命令</p>
</blockquote>
<p>1.获取apiVersion版本信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-versions</span><br></pre></td></tr></table></figure>

<p>2.获取资源的apiVersion的版本信息(以pod为例)，该命令同时输出属性设置帮助文档</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod</span><br></pre></td></tr></table></figure>

<blockquote>
<p>字段配置格式</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">apiVersion</span> <span class="string">&lt;string&gt;</span>            <span class="comment"># 表示字符串类型 </span></span><br><span class="line"><span class="string">metadata</span> <span class="string">&lt;Object&gt;</span>              <span class="comment"># 表示需要嵌套多层字段 </span></span><br><span class="line"><span class="string">labels</span> <span class="string">&lt;map[string]string&gt;</span>     <span class="comment"># 表示由k：v组成的映射 </span></span><br><span class="line"><span class="string">finalizers</span> <span class="string">&lt;[]string&gt;</span>          <span class="comment"># 表示字串列表 </span></span><br><span class="line"><span class="string">ownerReferences</span> <span class="string">&lt;[]Object&gt;</span>     <span class="comment"># 表示对象列表 </span></span><br><span class="line"><span class="string">hostPID</span> <span class="string">&lt;boolean&gt;</span>              <span class="comment"># 布尔类型 </span></span><br><span class="line"><span class="string">priority</span> <span class="string">&lt;integer&gt;</span>             <span class="comment"># 整型 </span></span><br><span class="line"><span class="string">name</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>       <span class="comment"># 如果类型后面接-required-，表示为必填字段</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>示例：通过定义清单文件创建Pod</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前K8S API 的版本</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="comment"># 元数据</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># pod名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-apache-pod</span></span><br><span class="line">  <span class="comment"># pod的名称空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="comment"># pod的标签</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">httpd</span></span><br><span class="line"><span class="comment"># 对象的详细信息</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 容器信息</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="comment"># 容器名称</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">      <span class="comment"># 这个容器使用的镜像</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">hub.lemon.com/library/httpd:v1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过yaml文件创建pod</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f xxx.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取资源的资源配置文件</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 -o 参数 加 yaml，可以将资源的配置以yaml的格式输出出来，也可以使用json，输出为json格式</span></span><br><span class="line">kubectl get pod &#123;podName&#125; -o yaml</span><br></pre></td></tr></table></figure>

<h2 id="3、pod的生命周期"><a href="#3、pod的生命周期" class="headerlink" title="3、pod的生命周期"></a>3、pod的生命周期</h2><blockquote>
<p>pod对象自从创建开始至终止退出的时间范围称为生命周期，在这段时间中，pod会处于多种不同的状态，并执行一些操作；其中，创建主容器为必须的操作，其他可选的操作还包括运行初始化容器（init container）、容器启动后钩子（start hook）、容器的存活性探测（liveness probe）、就绪性探测（readiness probe）以及容器终止前狗子（pre stop hook）等，这些操作是否执行则取决于pod的定义</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v1p27o3j30xd0g70u2.jpg" alt="image-20200919181303358"></p>
<p><strong>init C &amp; start-stop &amp; readiness &amp; liveness 整体流程：</strong></p>
<p>1、kubectl 调用 apiserver –&gt; etcd –&gt; kubelet –&gt; CRI 进行容器初始化</p>
<p>2、首先会先启动一个pause容器（任何pod启动时都会先pause容器）</p>
<p>3、init C 容器不会伴随整个pod的生命周期；如果是正常退出（0），进入main C，否则（非0），一直重启 失败。</p>
<p>4、进入main C后有两个参数，start：在刚启动时可以允许他执行一个命令，stop：退出时也可以允许他执行一个命令。</p>
<p>5、readiness模板：可以在main C运行的多少秒之后进行就绪检测；检测通过后，pod状态就为running，否则为failed。</p>
<p>6、liveness模板：伴随着整个main C的生命周期，当main C里面的进程 与 liveness检测结果不一致时，就可以执行对应的命令。</p>
<h3 id="3-1-Init-C"><a href="#3-1-Init-C" class="headerlink" title="3.1 Init C"></a>3.1 Init C</h3><blockquote>
<p>Pod能够具有多个容器，应用运行在容器里面，但是它也可能有一个或多个先于应用容器启动的Init容器</p>
</blockquote>
<p>Init容器与普通的容器非常像，除了如下两点：</p>
<ul>
<li>Init容器总是运行到成功完成为止</li>
<li>每个Init容器都必须在下一个Init容器启动之前成功完成</li>
</ul>
<p>如果Pod的Init容器失败，Kubernetes会不断地重启该Pod，直到Init容器成功为止。然而，如果Pod对应的restartPolicy为Never，它不会重新启动, 因为Init容器具有与应用程序容器分离的单独镜像，所以它们的启动相关代码具有如下优势：</p>
<ul>
<li>它们可以包含并运行实用工具，但是出于安全考虑，是不建议在应用程序容器镜像中包含这些实用工具的。</li>
<li>它们可以包含使用工具和定制化代码来安装，但是不能出现在应用程序镜像中。例如，创建镜像没必要FROM另一个镜像，只需要在安装过程中使用类似sed、awk、python或dig这样的工具。</li>
<li>应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像。</li>
<li>Init容器使用LinuxNamespace，所以相对应用程序容器来说具有不同的文件系统视图。因此，它们能够具有访问Secret的权限，而应用程序容器则不能。</li>
<li>它们必须在应用程序容器启动之前运行完成，而应用程序容器是并行运行的，所以Init容器能够提供了一种简单的阻塞或延迟应用容器的启动的方法，直到满足了一组先决条件。</li>
</ul>
<p>Init C 特殊说明：</p>
<ul>
<li>在Pod启动过程中，Init容器会按顺序在网络和数据卷初始化之后启动。每个容器必须在下一个容器启动之前成功退出。</li>
<li>如果由于运行时或失败退出，将导致容器启动失败，它会根据Pod的restartPolicy指定的策略进行重试。然而，如果Pod的restartPolicy设置为Always，Init容器失败时会使用RestartPolicy策略。</li>
<li>在所有的Init容器没有成功之前，Pod将不会变成Ready状态。Init容器的端口将不会在Service中进行聚集。正在初始化中的Pod处于Pending状态，但应该会将Initializing状态设置为true。</li>
<li>如果Pod重启，所有Init容器必须重新执行。</li>
<li>对Init容器spec的修改被限制在容器image字段，修改其他字段都不会生效。更改Init容器的image字段，等价于重启该Pod。</li>
<li>Init容器具有应用容器的所有字段。除了readinessProbe，因为Init容器无法定义不同于完成（completion）的就绪（readiness）之外的其他状态。这会在验证过程中强制执行。</li>
<li>在Pod中的每个app和Init容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误</li>
</ul>
<blockquote>
<p>Init 容器示例</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lemon-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># main容器字段</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="comment"># 容器启动后执行的命令</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The main-container is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="comment"># init容器字段</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="comment"># 第一个init容器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until test -e /live01; do echo waiting for live01; sleep 10; done;&#x27;</span>]</span><br><span class="line">  <span class="comment"># 第二个init容器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until test -e /live02; do echo waiting for live02; sleep 10; done;&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod -c init-container01 -- touch /live01</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod -c init-container02 -- touch /live02</span><br></pre></td></tr></table></figure>

<h3 id="3-2-容器探针"><a href="#3-2-容器探针" class="headerlink" title="3.2 容器探针"></a>3.2 容器探针</h3><blockquote>
<p>探针是由kubelet对容器执行的定期诊断。要执行诊断，kubelet调用由容器实现的Handler。</p>
</blockquote>
<p>探测方式：</p>
<ul>
<li>readinessProbe：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与Pod匹配的所有Service的端点中删除该Pod的IP地址。初始延迟之前的就绪状态默认为Failure。如果容器不提供就绪探针，则默认状态为Success。</li>
<li>livenessProbe：指示容器是否正在运行。如果存活探测失败，则kubelet会杀死容器，并且容器将受到其重启策略的影响。如果容器不提供存活探针，则默认状态为Success。</li>
</ul>
<p>有三种类型的处理程序：</p>
<ul>
<li>ExecAction：在容器内执行指定命令。如果命令退出时返回码为0则认为诊断成功。</li>
<li>TCPSocketAction：对指定端口上的容器的IP地址进行TCP检查。如果端口打开，则诊断被认为是成功的。</li>
<li>HTTPGetAction：对指定的端口和路径上的容器的IP地址执行HTTPGet请求。如果响应的状态码大于等于200且小于400，则诊断被认为是成功的。</li>
</ul>
<p>每次探测都将获得以下三种结果之一：</p>
<ul>
<li>成功：容器通过了诊断。</li>
<li>失败：容器未通过诊断。</li>
<li>未知：诊断失败，因此不会采取任何行动</li>
</ul>
<blockquote>
<p>Init 容器init 模板检测探针 - 就绪检测</p>
</blockquote>
<p><strong>readinessProbe-httpget</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-httpget-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">httpd:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index01.html</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">readiness-httpget-pod   0/1     Running   0          11m</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">log</span> -f readiness-httpget-pod</span><br><span class="line">10.244.1.1 - - [25/Feb/2021:08:19:11 +0000] <span class="string">&quot;GET /index01.html HTTP/1.1&quot;</span> 404 196</span><br><span class="line">10.244.1.1 - - [25/Feb/2021:08:19:14 +0000] <span class="string">&quot;GET /index01.html HTTP/1.1&quot;</span> 404 196</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it readiness-httpget-pod -- /bin/sh</span><br><span class="line"><span class="comment"># echo &#x27;lemon&#x27; &gt; /usr/local/apache2/htdocs/index01.html</span></span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">log</span> -f readiness-httpget-pod</span><br><span class="line">10.244.1.1 - - [25/Feb/2021:08:28:53 +0000] <span class="string">&quot;GET /index01.html HTTP/1.1&quot;</span> 200 6</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">readiness-httpget-pod   1/1     Running   0          22m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>liveness 检测探针 - 存活检测</p>
</blockquote>
<p><strong>livenessProbe-exec</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon03</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-exec-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;test&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;/tmp/live&quot;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -w</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec-pod       1/1     Running   0          9s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec-pod       1/1     Running   1          100s</span><br></pre></td></tr></table></figure>

<p><strong>livenessProbe-httpget</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-httpget-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">httpd:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-httpget-pod   1/1     Running   0          102s</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it liveness-httpget-pod -- rm /usr/<span class="built_in">local</span>/apache2/htdocs/index.html</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-httpget-pod   1/1     Running   1          2m53s</span><br></pre></td></tr></table></figure>

<p><strong>livenessProbe-tcp</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">probe-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一段时间时候就会自动重启pod，原因nginx容器没开8080端口，tomcat就不会重启</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-Pod-hook"><a href="#3-3-Pod-hook" class="headerlink" title="3.3 Pod hook"></a>3.3 Pod hook</h3><blockquote>
<p>Podhook（钩子）是由Kubernetes管理的kubelet发起的，当容器中的进程启动前或者容器中的进程终止之前运行，这是包含在容器的生命周期之中。可以同时为Pod中的所有容器都配置hook。</p>
</blockquote>
<p>Hook的类型包括两种：</p>
<ul>
<li>exec：执行一段命令</li>
<li>HTTP：发送HTTP请求</li>
</ul>
<blockquote>
<p>start、stop 动作</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lifecycle-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the postStart handler &gt; /var/message&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the poststop handler &gt; /var/message&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Init-C-amp-探针-整合使用"><a href="#3-4-Init-C-amp-探针-整合使用" class="headerlink" title="3.4 Init C &amp; 探针 整合使用"></a>3.4 Init C &amp; 探针 整合使用</h3><blockquote>
<p>init-readiness-liveness-hook.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lemon-pod-irlp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until test -e /live01; do echo waiting for live01; sleep 10; done;&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-container02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until test -e /live02; do echo waiting for live02; sleep 10; done;&#x27;</span>]</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The main-container is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index01.html</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;test&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;/tmp&quot;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the postStart handler &gt; /var/message&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the poststop handler &gt; /var/message&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init_c</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod-irlp -c init-container01 -- touch /live01</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod-irlp -c init-container02 -- touch /live02</span><br><span class="line">$ kubectl get pod </span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">lemon-pod-irlp   0/1     Running   0          51m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Readiness</span></span><br><span class="line">$ kubectl describe pod lemon-pod-irlp</span><br><span class="line">Readiness probe failed: Get http://10.244.2.12:80/index01.html</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod-irlp -c main-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># echo &#x27;lemon&#x27; &gt; /var/www/index01.html &amp;&amp; httpd -p 80 -h /var/www/ &amp;&amp; netstat -anptu | grep httpd</span></span><br><span class="line">tcp        0      0 :::80                   :::*                    LISTEN      287/httpd</span><br><span class="line">$ kubectl get pod </span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">lemon-pod-irlp   1/1     Running   0          4m42s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Liveness</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod-irlp -c main-container -- rm -rf /tmp/</span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">lemon-pod-irlp   1/1     Running   0          5m35s</span><br><span class="line">lemon-pod-irlp   0/1     Running   1          6m1s</span><br><span class="line">$ kubectl describe pod lemon-pod-irlp</span><br><span class="line">Liveness probe failed:</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod hook</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it lemon-pod-irlp -- cat /var/message</span><br><span class="line">Hello from the postStart handler</span><br></pre></td></tr></table></figure>

<h3 id="3-5-Pod的相位"><a href="#3-5-Pod的相位" class="headerlink" title="3.5 Pod的相位"></a>3.5 Pod的相位</h3><blockquote>
<p>Pod的status字段是一个PodStatus对象，PodStatus中有一个phase字段。</p>
<p>无论是手动创建还是通过控制器创建pod，pod对象总是应该处于其生命进程中以下几个相位之一：</p>
</blockquote>
<p>挂起（Pending）：Pod已被Kubernetes系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度Pod的时间和通过网络下载镜像的时间，这可能需要花点时间。</p>
<p>运行中（Running）：该Pod已经绑定到了一个节点上，Pod中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。</p>
<p>成功（Succeeded）：Pod中的所有容器都被成功终止，并且不会再重启。</p>
<p>失败（Failed）：Pod中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。</p>
<p>未知（Unknown）：因为某些原因无法取得Pod的状态，通常是因为与Pod所在主机通信失败。</p>
<h2 id="4、controllers-控制器"><a href="#4、controllers-控制器" class="headerlink" title="4、controllers 控制器 "></a>4、controllers <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/">控制器 </a></h2><blockquote>
<p>kubernetes不会直接创建pod，而是通过controller来管理pod的，所以controller负责维护集群的状态，比如故障检测、自动扩展、滚动更新。</p>
<p>Kubernetes中会有很多的controller（控制器），这些就相当于一个状态机（快照），用来控制Pod的具体状态和行为。</p>
</blockquote>
<h3 id="1-ReplicationController"><a href="#1-ReplicationController" class="headerlink" title="1. ReplicationController"></a>1. ReplicationController</h3><p>ReplicationController（RC）用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退出，会自动创建新的 Pod 来替代；而如果异常多出来的容器也会自动回收；</p>
<h3 id="2-ReplicaSet"><a href="#2-ReplicaSet" class="headerlink" title="2. ReplicaSet"></a>2. ReplicaSet</h3><p>在新版本的 Kubernetes 中建议使用 ReplicaSet来取代 ReplicationController 。ReplicaSet 跟ReplicationController 没有本质的不同，只是名字不一样，并且 ReplicaSet 支持集合式的 selector；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">frontend-d8rs5   1/1     Running   0          29s   tier=web</span><br><span class="line">frontend-gczvb   1/1     Running   0          29s   tier=web</span><br><span class="line">frontend-twj7z   1/1     Running   0          29s   tier=web</span><br><span class="line"></span><br><span class="line">$ kubectl label pod frontend-d8rs5 tier=lemon --overwrite=<span class="literal">true</span></span><br><span class="line">pod/frontend-d8rs5 labeled</span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE    LABELS</span><br><span class="line">frontend-d8rs5   1/1     Running   0          3m3s   tier=lemon</span><br><span class="line">frontend-gczvb   1/1     Running   0          3m3s   tier=web</span><br><span class="line">frontend-mrm8n   1/1     Running   0          10s    tier=web</span><br><span class="line">frontend-twj7z   1/1     Running   0          3m3s   tier=web</span><br><span class="line"></span><br><span class="line">$ kubectl delete pod --all</span><br><span class="line">pod <span class="string">&quot;frontend-d8rs5&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;frontend-gczvb&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;frontend-mrm8n&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;frontend-twj7z&quot;</span> deleted</span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">frontend-26xlj   1/1     Running   0          11s   tier=web</span><br><span class="line">frontend-m4vhl   1/1     Running   0          11s   tier=web</span><br><span class="line">frontend-zs9tk   1/1     Running   0          11s   tier=web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 RS</span></span><br><span class="line">$ kubectl delete rs frontend -n default</span><br></pre></td></tr></table></figure>

<h3 id="3-Deployment"><a href="#3-Deployment" class="headerlink" title="3. Deployment"></a>3. Deployment</h3><p>Deployments（无状态，守护进程类，只关注群体不关注个体）</p>
<ul>
<li>一个 <em>Deployment</em> 控制器为 Pods和 ReplicaSets 提供声明式的更新能力。</li>
<li>虽然 ReplicaSet可以独立使用，但一般还是建议使用 Deployment来自动管理ReplicaSe，这样就无需担心跟其他机制的不兼容问题（比如 ReplicaSe不支持rolling-update 但 Deployment支持）。</li>
</ul>
<p>Deployment 为 Pod 和 ReplicaSet 提供了一个声明式定义 (declarative) 方法，用来替代以前的ReplicationController 来方便的管理应用。典型的应用场景包括；</p>
<ul>
<li>定义 Deployment 来创建 Pod 和 ReplicaSet</li>
<li>应用扩容和缩容</li>
<li>滚动升级和回滚</li>
<li>暂停和继续 Deployment</li>
</ul>
<h4 id="3-1-创建一个-deployment-对象"><a href="#3-1-创建一个-deployment-对象" class="headerlink" title="3.1 创建一个 deployment 对象"></a>3.1 创建一个 deployment 对象</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deploy</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           62s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-687dc75df7   3         3         3       65s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-687dc75df7-88tkk   1/1     Running   0          68s</span><br><span class="line">nginx-deployment-687dc75df7-b6whp   1/1     Running   0          68s</span><br><span class="line">nginx-deployment-687dc75df7-ljh46   1/1     Running   0          68s</span><br></pre></td></tr></table></figure>

<h4 id="3-2-Deployment-扩容缩"><a href="#3-2-Deployment-扩容缩" class="headerlink" title="3.2 Deployment 扩容缩"></a>3.2 Deployment 扩容缩</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployment nginx-deployment --replicas=5</span><br><span class="line">deployment.extensions/nginx-deployment scaled</span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-687dc75df7-88tkk   1/1     Running   0          7m22s</span><br><span class="line">nginx-deployment-687dc75df7-b6whp   1/1     Running   0          7m22s</span><br><span class="line">nginx-deployment-687dc75df7-ljh46   1/1     Running   0          7m22s</span><br><span class="line">nginx-deployment-687dc75df7-rnjzt   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-687dc75df7-wfx74   1/1     Running   0          8s</span><br><span class="line"></span><br><span class="line">$ kubectl scale deployment nginx-deployment --replicas=2</span><br><span class="line">deployment.extensions/nginx-deployment scaled</span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-687dc75df7-88tkk   1/1     Running   0          8m18s</span><br><span class="line">nginx-deployment-687dc75df7-ljh46   1/1     Running   0          8m18s</span><br></pre></td></tr></table></figure>

<p>如果集群支持 horizontal pod autoscaling 的话，还可以为Deployment设置自动扩展</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deployment nginx-deployment --min=10--max=15--cpu-percent=80</span><br></pre></td></tr></table></figure>

<h4 id="3-3-滚动升级和回滚"><a href="#3-3-滚动升级和回滚" class="headerlink" title="3.3 滚动升级和回滚"></a>3.3 滚动升级和回滚</h4><blockquote>
<p>Deployment 更新策略</p>
</blockquote>
<p>Deployment 可以保证在升级时只有一定数量的 Pod 是 down 的。默认的，它会确保至少有比期望的Pod数量少一个是up状态（最多一个不可用）。</p>
<p>Deployment 同时也可以确保只创建出超过期望数量的一定数量的 Pod。默认的，它会确保最多比期望的Pod数量多一个的 Pod 是 up 的（最多1个 surge ）。</p>
<p>未来的 Kuberentes 版本中，将从1-1变成25%-25% 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 滚动升级</span></span><br><span class="line">$ kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1</span><br><span class="line">$ kubectl describe deploy nginx-deployment | grep -i <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    Image:        nginx:1.9.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line">$ kubectl rollout undo deployment/nginx-deployment</span><br><span class="line">$ kubectl describe deploy nginx-deployment | grep -i <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    Image:        nginx:1.7.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用edit命令来编辑 Deployment</span></span><br><span class="line">$ kubectl edit deployment nginx-deployment</span><br><span class="line">     40       - image: nginx:latest</span><br><span class="line">deployment.extensions/nginx-deployment edited</span><br><span class="line">$ kubectl describe deploy nginx-deployment | grep -i <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    Image:        nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新镜像实际上就是重新创建了一个rs</span></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-5458686b99   2         2         2       23s</span><br><span class="line">nginx-deployment-687dc75df7   0         0         0       18m</span><br><span class="line">nginx-deployment-6df444bb79   0         0         0       5m55s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Rollover（多个rollout并行）</p>
</blockquote>
<p>假如您创建了一个有5个niginx:1.7.9 replica的 Deployment，但是当还只有3个nginx:1.7.9的 replica 创建出来的时候您就开始更新含有5个nginx:1.9.1 replica 的 Deployment。在这种情况下，Deployment 会立即杀掉已创建的3个nginx:1.7.9的 Pod，并开始创建nginx:1.9.1的 Pod。它不会等到所有的5个nginx:1.7.9的Pod 都创建完成后才开始改变航道。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deployment</span><br><span class="line">deployment.extensions/nginx-deployment </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用 --revision参数指定某个历史版本</span></span><br><span class="line">$ kubectl rollout undo deployment nginx-deployment --to-revision=2</span><br><span class="line">deployment.extensions/nginx-deployment rolled back</span><br><span class="line">$ kubectl describe deploy nginx-deployment | grep -i <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    Image:        nginx:1.9.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ps: kubectl rollout pause deployment nginx-deployment    <span class="comment">## 暂停 deployment 的更新</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除DeployMent</span></span><br><span class="line">$ kubectl delete deployment nginx-deployment -n default</span><br></pre></td></tr></table></figure>

<blockquote>
<p>清理 Policy</p>
</blockquote>
<p>可以通过设置.spec.revisonHistoryLimit项来指定 deployment 最多保留多少 revision 历史记录。默认的会保留所有的 revision；如果将该项设置为0，Deployment 就不允许回退了</p>
<h3 id="4-DaemonSet"><a href="#4-DaemonSet" class="headerlink" title="4. DaemonSet"></a>4. DaemonSet</h3><p>DaemonSet 确保全部（或者一些）Node 上运行一个 Pod 的副本。当有 Node 加入集群时，也会为他们新增一个Pod 。当有 Node 从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod</p>
<p>使用 DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行glusterd、ceph</li>
<li>在每个 Node 上运行日志收集 daemon，例如fluentd、logstash</li>
<li>在每个 Node 上运行监控 daemon，例如Prometheus Node Exporter、collectd、Datadog 代理、New Relic 代理，或 Ganglia gmond</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deamonset-example</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">daemonset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">deamonset-example</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">deamonset-example</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">daemonset-example</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">deamonset-example-tqmfx   1/1     Running   0          94s</span><br><span class="line">deamonset-example-wqvsm   1/1     Running   0          94s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 DaemonSet</span></span><br><span class="line">$ kubectl delete daemonset deamonset-example -n default</span><br></pre></td></tr></table></figure>

<h3 id="5-Jobs-：一次性任务"><a href="#5-Jobs-：一次性任务" class="headerlink" title="5. Jobs ：一次性任务"></a>5. Jobs ：一次性任务</h3><p>一次性任务，运行完成后pod销毁，不再重新启动新容器。还可以任务定时运行。</p>
<p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束</p>
<p>特殊说明:</p>
<ul>
<li><p>spec.template 格式同 Pod</p>
</li>
<li><p>RestartPolicy 仅支持 Never 或 OnFailure</p>
</li>
<li><p>单个Pod时，默认 Pod 成功运行后 Job 即结束</p>
</li>
<li><p>spec.completions 标志 Job 结束需要成功运行的 Pod 个数，默认为1</p>
</li>
<li><p>spec.parallelism 标志并行运行的 Pod 的个数，默认为1</p>
</li>
<li><p>spec.activeDeadlineSeconds 标志失败Pod的重试最大时间，超过这个时间不会继续重试</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>,<span class="string">&quot;-Mbignum=bpi&quot;</span>,<span class="string">&quot;-wle&quot;</span>,<span class="string">&quot;print bpi(2000)&quot;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get job</span><br><span class="line">NAME   COMPLETIONS   DURATION   AGE</span><br><span class="line">pi     1/1           3m26s      8m54s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">pi-bfmq8                  0/1     Completed   0          9m1s</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">log</span> -f pi-bfmq8</span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275905</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Job</span></span><br><span class="line">$ kubectl delete job pi -n default</span><br></pre></td></tr></table></figure>

<h3 id="6-CronJob-：定时任务"><a href="#6-CronJob-：定时任务" class="headerlink" title="6. CronJob ：定时任务"></a>6. CronJob ：定时任务</h3><p>cronjob 其实就是在job的基础上加上了时间调度，可以：在给定的时间点运行一个任务，也可以周期性的在给定时间点运行。（与linux中的crontab类似）</p>
<p>Cron Job管理基于时间的 Job，即：</p>
<ul>
<li>在给定时间点只运行一次</li>
<li>周期性地在给定时间点运行</li>
</ul>
<p>使用前提条件：当前使用的Kubernetes集群，版本 &gt;= 1.8(对 CronJob)。对于先前版本的集群，版本 &lt;1.8，启动 API Server时，通过传递选项–runtime-config=batch/v2alpha1=true可以开启 batch/v2alpha1API。</p>
<p>典型的用法如下所示：</p>
<ul>
<li>在给定的时间点调度 Job 运行</li>
<li>创建周期性运行的 Job，例如：数据库备份、发送邮件</li>
</ul>
<p>特殊说明：</p>
<ul>
<li><p>spec.template 格式同 Pod</p>
</li>
<li><p>RestartPolicy 仅支持 Never 或 OnFailure</p>
</li>
<li><p>单个 Pod 时，默认 Pod 成功运行后 Job 即结束</p>
</li>
<li><p>spec.completions 标志 Job 结束需要成功运行的 Pod 个数，默认为1</p>
</li>
<li><p>spec.parallelism 标志并行运行的 Pod 的个数，默认为1</p>
</li>
<li><p>spec.activeDeadlineSeconds 标志失败 Pod 的重试最大时间，超过这个时间不会继续重试</p>
</li>
<li><p>spec.schedule：调度，必需字段，指定任务运行周期，格式同 Cron</p>
</li>
<li><p>spec.jobTemplate：Job 模板，必需字段，指定需要运行的任务，格式同 Job</p>
</li>
<li><p>spec.startingDeadlineSeconds：启动 Job 的期限（秒级别），该字段是可选的。如果因为任何原因而错过了被调度的时间，那么错过执行时间的 Job 将被认为是失败的。如果没有指定，则没有期限</p>
</li>
<li><p>spec.concurrencyPolicy：并发策略，该字段也是可选的。它指定了如何处理被 Cron Job 创建的 Job 的并发执行。只允许指定下面策略中的一种：</p>
<ul>
<li><p>Allow（默认）：允许并发运行 Job</p>
</li>
<li><p>Forbid：禁止并发运行，如果前一个还没有完成，则直接跳过下一个</p>
</li>
<li><p>Replace：取消当前正在运行的 Job，用一个新的来替换</p>
<p>注意, 当前策略只能应用于同一个Cron Job创建的Job。如果存在多个Cron Job, 它们创建的 Job 之间总是允许并发运行。</p>
</li>
</ul>
</li>
<li><p>spec.suspend：挂起，该字段也是可选的。如果设置为true，后续所有执行都会被挂起。它对已经开始执行的 Job 不起作用。默认值为false。</p>
</li>
<li><p>spec.successfulJobsHistoryLimit和.spec.failedJobsHistoryLimit：历史限制，是可选的字段。它们指定了可以保留多少完成和失败的 Job。默认情况下，它们分别设置为3和1。设置限制的值为0，相关类型的 Job 完成后将不会被保留。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">the</span> <span class="string">Kubernetes</span> <span class="string">cluster</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get cronjob</span><br><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   */1 * * * *   False     1        10s             22s</span><br><span class="line"></span><br><span class="line">$ kubectl get job</span><br><span class="line">NAME               COMPLETIONS   DURATION   AGE</span><br><span class="line">hello-1614322500   1/1           3s         62s</span><br><span class="line">hello-1614322560   0/1           2s         2s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                     READY   STATUS      RESTARTS   AGE</span><br><span class="line">hello-1614322500-p7wmh   0/1     Completed   0          6s</span><br><span class="line">hello-1614322560-vsz58   0/1     Completed   0          27s</span><br><span class="line"></span><br><span class="line">$ kubectl logs -f hello-1614322500-p7wmh</span><br><span class="line">Sat Mar 20 13:03:17 UTC 2021</span><br><span class="line">Hello from the Kubernetes cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 cronjob</span></span><br><span class="line">$ kubectl delete cronjob hello -n default</span><br></pre></td></tr></table></figure>

<h3 id="7-StateFulSet"><a href="#7-StateFulSet" class="headerlink" title="7. StateFulSet"></a>7. StateFulSet</h3><p>StatefulSets（管理有状态应用） 作为 Controller 为 Pod 提供唯一的标识。它可以保证部署和 scale 的顺序StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），其应用场景包括：</p>
<ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现。</li>
<li>稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有Cluster IP的Service）来实现。</li>
<li>有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实现。</li>
<li>有序收缩，有序删除（即从N-1到0）。</li>
</ul>
<h3 id="8-Horizontal-Pod-Autoscaler"><a href="#8-Horizontal-Pod-Autoscaler" class="headerlink" title="8. Horizontal Pod Autoscaler"></a>8. Horizontal Pod Autoscaler</h3><p>Horizontal Pod Autoscaler 应用的资源使用率通常都有高峰和低谷的时候，如何削峰填谷，提高集群的整体资源利用率，让service中的Pod个数自动调整呢？这就有赖于Horizontal Pod Autoscaler了，顾名思义，使Pod水平自动缩放。</p>
<h2 id="5、Service"><a href="#5、Service" class="headerlink" title="5、Service"></a>5、Service</h2><blockquote>
<p>Kubernetes Service定义了这样一种抽象：一个Pod的逻辑分组，一种可以访问它们的策略 —— 通常称为微服务。这一组Pod能够被Service访问到，通常是通过Label Selector 。</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v20t5rzj30v50gwtc0.jpg" alt="image-20210301102544478"></p>
<p>Service能够提供负载均衡的能力，但是在使用上有个限制：Service 只提供 4 层负载均衡能力，而没有 7 层功能, 但有时可能需要更多的匹配规则来转发请求，这点上 4 层负载均衡是不支持的。</p>
<h3 id="5-1-Service-的类型"><a href="#5-1-Service-的类型" class="headerlink" title="5.1 Service 的类型"></a>5.1 Service 的类型</h3><p>Service 在 K8s 中有以下四种类型：</p>
<ul>
<li>ClusterIp：默认类型，自动分配一个仅 Cluster 内部可以访问的虚拟 IP</li>
<li>NodePort：在 ClusterIP 基础上为 Service 在每台机器上绑定一个端口，这样就可以通过: NodePort 来访问该服务</li>
<li>LoadBalancer：在 NodePort 的基础上，借助 cloud provider 创建一个外部负载均衡器，并将请求转发到: NodePort</li>
<li>ExternalName：把集群外部的服务引入到集群内部来，在集群内部直接使用。没有任何类型代理被创建，这只有 kubernetes 1.7 或更高版本的 kube-dns 才支持</li>
</ul>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v25ddjsj30s50lnafb.jpg" alt="image-20210301102927561"></p>
<h3 id="5-2-VIP-和-Service-代理"><a href="#5-2-VIP-和-Service-代理" class="headerlink" title="5.2 VIP 和 Service 代理"></a>5.2 VIP 和 Service 代理</h3><p>在 Kubernetes 集群中，每个 Node 运行一个kube-proxy进程。kube-proxy负责为Service实现了一种VIP（虚拟 IP）的形式，而不是ExternalName的形式。在 Kubernetes v1.0 版本，代理完全在 userspace。在Kubernetes v1.1 版本，新增了 iptables 代理，但并不是默认的运行模式。从 Kubernetes v1.2 起，默认就是iptables 代理。在 Kubernetes v1.8.0-beta.0 中，添加了 ipvs 代理。</p>
<p>在 Kubernetes 1.14 版本开始默认使用ipvs 代理。</p>
<p>在 Kubernetes v1.0 版本，Service是 “4层”（TCP/UDP over IP）概念。在 Kubernetes v1.1 版本，新增了Ingress API（beta 版），用来表示 “7层”（HTTP）服务。</p>
<p>代理模式的分类如下：</p>
<p>1、userspace 代理模式</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2ayww4j30sx0jd11p.jpg" alt="image-20210301103543203"></p>
<p>2、iptables 代理模式</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2gjt4wj30sw0it471.jpg" alt="image-20210301103602493"></p>
<p>3、ipvs 代理模式</p>
<p>这种模式，kube-proxy 会监视 Kubernetes Service对象和Endpoints，调用netlink接口以相应地创建ipvs 规则并定期与 Kubernetes Service对象和Endpoints对象同步 ipvs 规则，以确保 ipvs 状态与期望一致。访问服务时，流量将被重定向到其中一个后端 Pod。</p>
<p>与 iptables 类似，ipvs 于 netfilter 的 hook 功能，但使用哈希表作为底层数据结构并在内核空间中工作。这意味着 ipvs 可以更快地重定向流量，并且在同步代理规则时具有更好的性能。此外，ipvs 为负载均衡算法提供了更多选项，例如：</p>
<ul>
<li>rr：轮询调度</li>
<li>lc：最小连接数</li>
<li>dh：目标哈希</li>
<li>sh：源哈希</li>
<li>sed：最短期望延迟</li>
<li>nq：不排队调度</li>
</ul>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2lb7tmj30sv0irgwj.jpg" alt="image-20210301103456348"></p>
<h3 id="5-3-ClusterIP"><a href="#5-3-ClusterIP" class="headerlink" title="5.3 ClusterIP"></a>5.3 ClusterIP</h3><p>clusterIP 主要在每个 node 节点使用 IPVS，将发向 clusterIP 对应端口的数据，转发到 kube-proxy 中。然后 kube-proxy 自己内部实现有负载均衡的方法，并可以查询到这个 service 下对应 pod 的地址和端口，进而把数据转发给对应的 pod 的地址和端口。</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2owu0xj60s60fcacs02.jpg" alt="image-20210301111213452"></p>
<p>为了实现图上的功能，主要需要以下几个组件的协同工作：</p>
<ul>
<li>apiserver 用户通过kubectl命令向apiserver发送创建service的命令，apiserver接收到请求后将数据存储到etcd中</li>
<li>kube-proxy kubernetes的每个节点中都有一个叫做kube-porxy的进程，这个进程负责感知service，pod的变化，并将变化的信息写入本地的 IPVS 规则中</li>
<li>IPVS 使用NAT等技术将virtualIP的流量转至endpoint中</li>
</ul>
<p><strong>创建 myapp-deploy-svc.yaml 文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">stabel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">stabel</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">stabel</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>查看 IPVSADM</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -owide</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   172d    &lt;none&gt;</span><br><span class="line">myapp        ClusterIP   10.104.132.57   &lt;none&gt;        80/TCP    3m10s   app=myapp,release=stabel</span><br><span class="line"></span><br><span class="line">$ ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.2.1:6443             Masq    1      3          0         </span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.14:53               Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.15:53               Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line">  -&gt; 10.244.0.14:9153             Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.15:9153             Masq    1      0          0         </span><br><span class="line">TCP  10.104.132.57:80 rr</span><br><span class="line">  -&gt; 10.244.1.40:80               Masq    1      0          3         </span><br><span class="line">  -&gt; 10.244.1.41:80               Masq    1      0          3         </span><br><span class="line">  -&gt; 10.244.2.40:80               Masq    1      0          3         </span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.14:53               Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.15:53               Masq    1      0          0</span><br></pre></td></tr></table></figure>

<h3 id="5-4-Headless-Service"><a href="#5-4-Headless-Service" class="headerlink" title="5.4 Headless Service"></a>5.4 Headless Service</h3><p>有时不需要或不想要负载均衡，以及单独的 Service IP 。遇到这种情况，可以通过指定 ClusterIP(spec.clusterIP) 的值为 “None” 来创建 Headless Service 。这类 Service 并不会分配 Cluster IP， kube-proxy 不会处理它们，而且平台也不会为它们进行负载均衡和路由。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span>  </span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -owide</span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes       ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   172d    &lt;none&gt;</span><br><span class="line">myapp            ClusterIP   10.104.132.57   &lt;none&gt;        80/TCP    5m30s   app=myapp,release=stabel</span><br><span class="line">myapp-headless   ClusterIP   None            &lt;none&gt;        80/TCP    19s     app=myapp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ dig -t A myapp-headless.default.svc.cluster.local. @10.96.0.10</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; -t A myapp-headless.default.svc.cluster.local. @10.96.0.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 5421</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;myapp-headless.default.svc.cluster.local. IN A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">myapp-headless.default.svc.cluster.local. 30 IN	A 10.244.1.41</span></span><br><span class="line"><span class="string">myapp-headless.default.svc.cluster.local. 30 IN	A 10.244.1.40</span></span><br><span class="line"><span class="string">myapp-headless.default.svc.cluster.local. 30 IN	A 10.244.2.40</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: 四 3月 04 10:36:53 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 237</span></span><br></pre></td></tr></table></figure>

<h3 id="5-5-NodePort"><a href="#5-5-NodePort" class="headerlink" title="5.5 NodePort"></a>5.5 NodePort</h3><p>nodePort 的原理在于在 node 上开了一个端口，将向该端口的流量导入到 kube-proxy，然后由 kube-proxy 进一步到给对应的 pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapps</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">stabel</span></span><br><span class="line">  <span class="attr">ports:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -owide</span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span><br><span class="line">kubernetes       ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        172d    &lt;none&gt;</span><br><span class="line">myapp            ClusterIP   10.104.132.57   &lt;none&gt;        80/TCP         11m     app=myapp,release=stabel</span><br><span class="line">myapp-headless   ClusterIP   None            &lt;none&gt;        80/TCP         6m42s   app=myapp</span><br><span class="line">myapps           NodePort    10.100.41.94    &lt;none&gt;        80:32195/TCP   42s     app=web,release=stabel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询流程,并且在每台节点上都会打开一个32195端口</span></span><br><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure>

<h3 id="5-6-LoadBalancer"><a href="#5-6-LoadBalancer" class="headerlink" title="5.6 LoadBalancer"></a>5.6 LoadBalancer</h3><p>loadBalancer 和 nodePort 其实是同一种方式。区别在于 loadBalancer 比 nodePort 多了一步，就是可以调用cloud provider 去创建 LB 来向节点导流。</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2ulrlwj30sa0ln76f.jpg" alt="image-20210301113038598"></p>
<h3 id="5-7-ExternalName"><a href="#5-7-ExternalName" class="headerlink" title="5.7 ExternalName"></a>5.7 ExternalName</h3><p>这种类型的 Service 通过返回 CNAME 和它的值，可以将服务映射到 externalName 字段的内容( 例如：hub.atguigu.com )。</p>
<p>ExternalName Service 是 Service 的特例，它没有 selector，也没有定义任何的端口和Endpoint。相反的，对于运行在集群外部的服务，它通过返回该外部服务的别名这种方式来提供服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">hub.armin.com</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -owide</span><br><span class="line">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE     SELECTOR</span><br><span class="line">kubernetes       ClusterIP      10.96.0.1       &lt;none&gt;          443/TCP        172d    &lt;none&gt;</span><br><span class="line">my-service-1     ExternalName   &lt;none&gt;          hub.armin.com   &lt;none&gt;         29s     &lt;none&gt;</span><br><span class="line">myapp            ClusterIP      10.104.132.57   &lt;none&gt;          80/TCP         21m     app=myapp,release=stabel</span><br><span class="line">myapp-headless   ClusterIP      None            &lt;none&gt;          80/TCP         15m     app=myapp</span><br><span class="line">myapps           NodePort       10.100.41.94    &lt;none&gt;          80:32195/TCP   9m51s   app=web,release=stabel</span><br><span class="line"></span><br><span class="line">$ dig -t A hub.armin.com.svc.cluster.local. @10.96.0.10</span><br></pre></td></tr></table></figure>

<p>当查询主机 my-service.defalut.svc.cluster.local ( SVC_NAME.NAMESPACE.svc.cluster.local )时，集群的DNS 服务将返回一个值 my.database.example.com 的 CNAME 记录。访问这个服务的工作方式和其他的相同，唯一不同的是重定向发生在 DNS 层，而且不会进行代理或转发。</p>
<h2 id="6、Ingress"><a href="#6、Ingress" class="headerlink" title="6、Ingress"></a>6、Ingress</h2><blockquote>
<p>实际上Ingress也是Kubernetes API的标准资源类型之一，它其实就是一组基于DNS名称（host）或URL路径把请求转发到指定的Service资源的规则。用于将集群外部的请求流量转发到集群内部完成的服务发布。我们需要明白的是，Ingress资源自身不能进行“流量穿透”，仅仅是一组规则的集合，这些集合规则还需要其他功能的辅助，比如监听某套接字，然后根据这些规则的匹配进行路由转发，这些能够为Ingress资源监听套接字并将流量转发的组件就是Ingress Controller。</p>
<p>Ingress 控制器不同于Deployment 控制器的是，Ingress控制器不直接运行为kube-controller-manager的一部分，它仅仅是Kubernetes集群的一个附件，类似于CoreDNS，需要在集群上单独部署。</p>
</blockquote>
<p>Ingress-Nginx github 地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a></p>
<p>Ingress-Nginx 官方网站：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/">https://kubernetes.github.io/ingress-nginx/</a></p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v2zr3qej314c0ijah5.jpg" alt="image-20210305163255636"></p>
<h3 id="6-1-部署-Ingress-Nginx"><a href="#6-1-部署-Ingress-Nginx" class="headerlink" title="6.1 部署 Ingress-Nginx"></a>6.1 部署 Ingress-Nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># mkdir -p /etc/kubernetes/ingress-nginx &amp;&amp; cd /etc/kubernetes/ingress-nginx</span></span><br></pre></td></tr></table></figure>



<h2 id="7、K8S-存储"><a href="#7、K8S-存储" class="headerlink" title="7、K8S - 存储"></a>7、K8S - 存储</h2><ul>
<li>ConfigMap</li>
<li>Secret</li>
<li>volume</li>
<li>Persistent Volume（PV）</li>
</ul>
<h3 id="7-1-ConfigMap"><a href="#7-1-ConfigMap" class="headerlink" title="7.1 ConfigMap"></a>7.1 ConfigMap</h3><blockquote>
<p>ConfigMap 功能在 Kubernetes1.2 版本中引入，许多应用程序会从配置文件、命令行参数或环境变量中读取配置信息。ConfigMap API 给我们提供了向容器中注入配置信息的机制，ConfigMap 可以被用来保存单个属性，也可以用来保存整个配置文件或者 JSON 二进制大对象。</p>
</blockquote>
<h4 id="7-1-1-ConfigMap-的创建"><a href="#7-1-1-ConfigMap-的创建" class="headerlink" title="7.1.1 ConfigMap 的创建"></a>7.1.1 ConfigMap 的创建</h4><ul>
<li>目录创建</li>
<li>文件创建</li>
<li>字面值创建</li>
</ul>
<p><strong>使用目录创建</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ ll /etc/kubernetes/configmap-dir/</span><br><span class="line">game.properties</span><br><span class="line">ui.properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat /etc/kubernetes/configmap-dir/game.properties</span><br><span class="line">enemies=aliens</span><br><span class="line">lives=3</span><br><span class="line">enemies.cheat=<span class="literal">true</span></span><br><span class="line">enemies.cheat.level=noGoodRotten</span><br><span class="line">secret.code.passphrase=UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed=<span class="literal">true</span></span><br><span class="line">secret.code.lives=30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat /etc/kubernetes/configmap-dir/ui.properties</span><br><span class="line">color.good=purple</span><br><span class="line">color.bad=yellow</span><br><span class="line">allow.textmode=<span class="literal">true</span></span><br><span class="line">how.nice.to.look=fairlyNice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --from-file 指定在目录下的所有文件都会被用在 ConfigMap 里面创建一个键值对，键的名字就是文件名，值就是文件的内容。</span></span><br><span class="line">$ kubectl create configmap game-config-1 --from-file=/etc/kubernetes/configmap-dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl get configmap -n default -owide</span><br><span class="line">NAME            DATA   AGE</span><br><span class="line">game-config-1   2      &lt;invalid&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl get configmap -n default -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: v1</span><br><span class="line">  data:</span><br><span class="line">    game.properties: |</span><br><span class="line">      enemies=aliens</span><br><span class="line">      lives=3</span><br><span class="line">      enemies.cheat=<span class="literal">true</span></span><br><span class="line">      enemies.cheat.level=noGoodRotten</span><br><span class="line">      secret.code.passphrase=UUDDLRLRBABAS</span><br><span class="line">      secret.code.allowed=<span class="literal">true</span></span><br><span class="line">      secret.code.lives=30</span><br><span class="line">    ui.properties: |</span><br><span class="line">      color.good=purple</span><br><span class="line">      color.bad=yellow</span><br><span class="line">      allow.textmode=<span class="literal">true</span></span><br><span class="line">      how.nice.to.look=fairlyNice</span><br><span class="line">  kind: ConfigMap</span><br><span class="line">  metadata:</span><br><span class="line">    creationTimestamp: <span class="string">&quot;2021-03-08T11:54:57Z&quot;</span></span><br><span class="line">    name: game-config-1</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: <span class="string">&quot;15839&quot;</span></span><br><span class="line">    selfLink: /api/v1/namespaces/default/configmaps/game-config-1</span><br><span class="line">    uid: cb84c4f5-e509-4ecb-8513-68184b8b57af</span><br><span class="line">kind: List</span><br><span class="line">metadata:</span><br><span class="line">  resourceVersion: <span class="string">&quot;&quot;</span></span><br><span class="line">  selfLink: <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl describe configmap game-config-1 -n default</span><br><span class="line">Name:         game-config-1</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ui.properties:</span><br><span class="line">----</span><br><span class="line">color.good=purple</span><br><span class="line">color.bad=yellow</span><br><span class="line">allow.textmode=<span class="literal">true</span></span><br><span class="line">how.nice.to.look=fairlyNice</span><br><span class="line"></span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemies=aliens</span><br><span class="line">lives=3</span><br><span class="line">enemies.cheat=<span class="literal">true</span></span><br><span class="line">enemies.cheat.level=noGoodRotten</span><br><span class="line">secret.code.passphrase=UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed=<span class="literal">true</span></span><br><span class="line">secret.code.lives=30</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>使用文件创建</strong></p>
<p>只要指定为一个文件就可以从单个文件中创建 ConfigMap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create configmap game-config-2 --from-file=/etc/kubernetes/configmap-dir/game.properties</span><br><span class="line">$ kubectl get configmaps game-config-2 -o yaml</span><br><span class="line"><span class="comment"># --from-file这个参数可以使用多次，你可以使用两次分别指定上个实例中的那两个配置文件，效果就跟指定整个目录是一样的。</span></span><br></pre></td></tr></table></figure>

<p><strong>使用字面值创建</strong></p>
<p>使用文字值创建，利用–from-literal参数传递配置信息，该参数可以使用多次</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create configmap game-config-3 --from-literal=k1.how=v1 --from-literal=k2.how=v2</span><br><span class="line">$ kubectl get configmaps game-config-3 -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  k1.how: v1</span><br><span class="line">  k2.how: v2</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-03-08T12:01:19Z&quot;</span></span><br><span class="line">  name: game-config-3</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;16388&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/game-config-3</span><br><span class="line">  uid: b9e048f3-a17d-4517-bfe5-311c51377aaa</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-Pod-中使用-ConfigMap"><a href="#7-1-2-Pod-中使用-ConfigMap" class="headerlink" title="7.1.2 Pod 中使用 ConfigMap"></a>7.1.2 Pod 中使用 ConfigMap</h4><p><strong>使用 ConfigMap 来替代环境变量</strong></p>
<ul>
<li>env: 指定导入k/v</li>
<li>envFrom: 全部导入</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat cm-test-01.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.sam:</span> <span class="string">charm</span></span><br><span class="line">  <span class="attr">special.lep:</span> <span class="string">value</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-test-pod-01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_SAM_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.sam</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">env-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f cm-test-01.yaml</span><br><span class="line">$ kubectl logs cm-test-pod-01 | grep SPECIAL</span><br><span class="line">SPECIAL_HOW_KEY=very</span><br><span class="line">SPECIAL_SAM_KEY=charm</span><br></pre></td></tr></table></figure>

<p><strong>用 ConfigMap 设置命令行参数</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat cm-test-02.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">a:</span> <span class="string">b</span></span><br><span class="line">  <span class="attr">c:</span> <span class="string">d</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-test-pod-02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo $(KEY-01) $(KEY-02)&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KEY-01</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-01</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">a</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KEY-02</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-01</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">c</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs cm-test-pod-02</span><br><span class="line">b d</span><br></pre></td></tr></table></figure>

<p><strong>通过数据卷插件使用ConfigMap</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat cm-test-03.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-02</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">how:</span> <span class="string">HOW</span></span><br><span class="line">  <span class="attr">sam:</span> <span class="string">SAM</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 在数据卷里面使用这个 ConfigMap,有不同的选项。最基本的就是将文件填入数据卷,在这个文件中,键就是文件名,键值就是文件内容。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod-02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 36000&quot;</span>]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-02</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it test-pod-02 -- ls -lh /etc/config</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx    1 root     root          10 Mar  9 08:44 how -&gt; ..data/how</span><br><span class="line">lrwxrwxrwx    1 root     root          10 Mar  9 08:44 sam -&gt; ..data/sam</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it test-pod-02 -- cat /etc/config/how</span><br><span class="line">HOW</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it test-pod-02 -- cat /etc/config/sam</span><br><span class="line">SAM</span><br></pre></td></tr></table></figure>

<h4 id="7-1-3-ConfigMap-的热更新"><a href="#7-1-3-ConfigMap-的热更新" class="headerlink" title="7.1.3 ConfigMap 的热更新"></a>7.1.3 ConfigMap 的热更新</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">log-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">log-config</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it my-nginx-7b6584d96d-hpbml -- cat /etc/config/log_level</span><br><span class="line">INFO</span><br></pre></td></tr></table></figure>

<p>修改 ConfigMap，将其INFO改为DEBUG</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit configmap log-config</span><br><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a &#x27;#&#x27; will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  log_level: DEBUG</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;<span class="string">&quot;apiVersion&quot;</span>:<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;log_level&quot;</span>:<span class="string">&quot;DEBUG&quot;</span>&#125;,<span class="string">&quot;kind&quot;</span>:<span class="string">&quot;ConfigMap&quot;</span>,<span class="string">&quot;metadata&quot;</span>:&#123;<span class="string">&quot;annotations&quot;</span>:&#123;&#125;,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;log-config&quot;</span>,<span class="string">&quot;namespace&quot;</span>:<span class="string">&quot;default&quot;</span>&#125;&#125;</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2021-03-09T09:04:08Z&quot;</span></span><br><span class="line">  name: log-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;36210&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/log-config</span><br><span class="line">  uid: 8e2f15fc-cc05-414b-ad2f-9597cacf7c9a</span><br></pre></td></tr></table></figure>

<p>修改log_level的值为DEBUG等待大概 10 秒钟时间，再次查看环境变量的值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it my-nginx-7b6584d96d-hpbml -- cat /etc/config/log_level</span><br><span class="line">DEBUG</span><br></pre></td></tr></table></figure>

<h3 id="7-2-Secret"><a href="#7-2-Secret" class="headerlink" title="7.2 Secret"></a>7.2 Secret</h3><blockquote>
<p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec中。</p>
<p>并且，Secret 可以以 Volume 或者 环境变量的方式使用。</p>
</blockquote>
<p>Secret 有三种类型</p>
<ul>
<li>Service Account</li>
<li>Opaque</li>
<li>kubernetes.io/dockerconfigjson</li>
</ul>
<h4 id="7-2-1-Service-Account"><a href="#7-2-1-Service-Account" class="headerlink" title="7.2.1 Service Account"></a>7.2.1 Service Account</h4><blockquote>
<p>大致了解一下即可，Service Account 用来访问 Kubernetes API，由 Kubernetes 自动创建，并且会自动挂载到 Pod的/run/secrets/kubernetes.io/serviceaccount目录中。</p>
<p>PS : 只有与 apiserver 组件进行交互的 pod 才会有如下的 证书、命名空间、tekon密钥。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it kube-proxy-2x7r8 -n kube-system -- ls -lh /run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 13 Mar 10 02:50 ca.crt -&gt; ..data/ca.crt</span><br><span class="line">lrwxrwxrwx 1 root root 16 Mar 10 02:50 namespace -&gt; ..data/namespace</span><br><span class="line">lrwxrwxrwx 1 root root 12 Mar 10 02:50 token -&gt; ..data/token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这几个文件是 default-token 提供的，而 default-token 是 k8s 默认为每一个namespace 创建的，用于Service Account</span></span><br><span class="line">$ kubectl get secret</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-c6vqw   kubernetes.io/service-account-token   3      46d</span><br><span class="line"></span><br><span class="line">$ kubectl describe secret default-token-c6vqw</span><br><span class="line">…………………………………………………………………………</span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  7 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tYzZ2cXciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjJjNjlmMjkzLTcwNTQtNDY4My05ODNmLTljYmQyNTBlZTQ1ZiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.WdQ32P2ndcKUNbyrsKouTgBEVQf8Smq1mSd9zRpBou1KN2DUJ6UPWHvMdDlqwvN2CACOWZcri0eN8NABvNEW6cQMv7O7-GoVsuv5HLDxmO1IC1tTVUr8d-uBxULiSiQZ_Mj2LK1QKYNAHzVYRlEozzI3wZAOWBDqA7ZFVpXRQMES0lzlRc9ETZqQmxIHgF_hyTzpsRaLkR480vppOTORejZGrm_wiSvYVKKvNe3H35TRtHARCZDlGv7DAickld2rnYuKSyLdZz29CmDiE6L0ZyzTCMgPalNkmjcuij28XG19I4GLio7IiS5ZMDrQsmr_4t3G449PPSiH_0C78LICuA</span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-Opaque-Secret"><a href="#7-2-2-Opaque-Secret" class="headerlink" title="7.2.2 Opaque Secret"></a>7.2.2 Opaque Secret</h4><blockquote>
<p>base64编码格式的Secret，用来存储密码、密钥等。</p>
<p>Opaque 类型的数据是一个 map 类型，要求 value 是 base64 编码格式。</p>
</blockquote>
<p>1、创建 Opaque-Secret</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base64 -d 选项为解密</span></span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;admin&quot;</span> | base64</span><br><span class="line">YWRtaW4=</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;1f2d1e2e67df&quot;</span> | base64</span><br><span class="line">MWYyZDFlMmU2N2Rm</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat opaque-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">op-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MWYyZDFlMmU2N2Rm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get secret</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-c6vqw   kubernetes.io/service-account-token   3      46d</span><br><span class="line">op-secret             Opaque                                2      11s</span><br><span class="line"></span><br><span class="line">$ kubectl describe secret op-secret</span><br><span class="line">…………………………………………………………………………</span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:  12 bytes</span><br><span class="line">username:  5 bytes</span><br></pre></td></tr></table></figure>

<p>2、使用方式</p>
<ul>
<li>将 Secret 挂载到 Volume 中</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat volume-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seret-test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">seret-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">op-secret</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/secrets&#x27;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it seret-test -- ls -l /etc/secrets</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Mar 10 03:25 password -&gt; ..data/password</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Mar 10 03:25 username -&gt; ..data/username</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并且 secret 是会自己进行解密的</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it seret-test -- cat /etc/secrets/password</span><br><span class="line">1f2d1e2e67df</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it seret-test -- cat /etc/secrets/username</span><br><span class="line">admin</span><br></pre></td></tr></table></figure>

<ul>
<li>将 Secret 导出到环境变量中</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat env-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pod-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST_USER</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">op-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">op-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it pod-deployment-7cfd69dcf7-222q2 -- /bin/sh</span><br><span class="line">/ <span class="comment"># echo $TEST_USER</span></span><br><span class="line">admin</span><br><span class="line">/ <span class="comment"># echo $TEST_PASSWORD</span></span><br><span class="line">1f2d1e2e67df</span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-dockerconfigjson"><a href="#7-2-3-dockerconfigjson" class="headerlink" title="7.2.3 dockerconfigjson"></a>7.2.3 dockerconfigjson</h4><blockquote>
<p>用来存储私有 docker registry 的认证信息。</p>
</blockquote>
<p>1、使用 Kuberctl 创建 docker registry 认证的 secret（注：针对私有仓库）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret docker-registry myregistrykey --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># --docker-server      仓库地址</span></span><br><span class="line"><span class="comment"># --docker-username    仓库用户</span></span><br><span class="line"><span class="comment"># --docker-password    仓库密码</span></span><br></pre></td></tr></table></figure>

<p>2、在创建 Pod 的时候，通过 imagePullSecrets 来引用刚创建的 myregistrykey</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat key-secret.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">hub.lemon.com/library/my_nginx:v1</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myregistrykey</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-Volume"><a href="#7-3-Volume" class="headerlink" title="7.3 Volume"></a>7.3 Volume</h3><blockquote>
<p>容器磁盘上的文件的生命周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。首先，当容器崩溃时，kubelet 会重启它，但是容器中的文件将丢失——容器以干净的状态（镜像最初的状态）重新启动。其次，在Pod中同时运行多个容器时，这些容器之间通常需要共享文件。Kubernetes 中的Volume抽象就很好的解决了这些问题。</p>
<p>Kubernetes 中的卷有明确的寿命 —— 与封装它的 Pod 相同。所f以，卷的生命比 Pod 中的所有容器都长，当这个容器重启时数据仍然得以保存。当然，当 Pod 不再存在时，卷也将不复存在。也许更重要的是，Kubernetes支持多种类型的卷，Pod 可以同时使用任意数量的卷。</p>
</blockquote>
<p><strong>Kubernetes 支持以下类型的卷：</strong></p>
<ul>
<li>awsElasticBlockStore、azureDisk、azureFile、cephfs、csi、downwardAPI、emptyDir</li>
<li>fc、flocker、gcePersistentDisk、gitRepo、glusterfs、hostPath、iscsi、local、nfs</li>
<li>persistentVolumeClaim、projected、portworxVolume、quobyte、rbd、scaleIO、secret</li>
<li>storageos、vsphereVolume</li>
</ul>
<p><strong>比较常用的两类 emptyDir、hostPath</strong></p>
<h4 id="7-3-1-emptyDir"><a href="#7-3-1-emptyDir" class="headerlink" title="7.3.1 emptyDir"></a>7.3.1 emptyDir</h4><blockquote>
<p>当 Pod 被分配给节点时，首先创建emptyDir卷，并且只要该 Pod 在该节点上运行，该卷就会存在。正如卷的名字所述，它最初是空的。Pod 中的容器可以读取和写入emptyDir卷中的相同文件，尽管该卷可以挂载到每个容器中的相同或不同路径上。当出于任何原因从节点中删除 Pod 时，emptyDir中的数据将被永久删除。</p>
</blockquote>
<p><strong>emptyDir的用法有：</strong></p>
<ul>
<li>暂存空间，例如用于基于磁盘的合并排序</li>
<li>用作长时间计算崩溃恢复时的检查点</li>
<li>Web服务器容器提供数据时，保存内容管理器容器提取的文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat emptyDir.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache01</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache02</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it test-pd -c test-container01 -- /bin/sh</span><br><span class="line">/ <span class="comment"># cd /cache01</span></span><br><span class="line">/cache01 <span class="comment"># hostname &gt;&gt; test.log</span></span><br><span class="line">/cache01 <span class="comment"># cat test.log </span></span><br><span class="line">test-pd</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it test-pd -c test-container02 -- /bin/sh</span><br><span class="line"><span class="comment"># cd /cache02</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">test.log</span><br><span class="line"><span class="comment"># cat test.log</span></span><br><span class="line">test-pd</span><br></pre></td></tr></table></figure>

<h4 id="7-3-2-hostPath"><a href="#7-3-2-hostPath" class="headerlink" title="7.3.2 hostPath"></a>7.3.2 hostPath</h4><blockquote>
<p>hostPath卷将主机节点的文件系统中的文件或目录挂载到集群中。</p>
</blockquote>
<p><strong>hostPath 的用途如下：</strong></p>
<ul>
<li>运行需要访问 Docker 内部的容器；使用 /var/lib/docker 的 hostPath</li>
<li>在容器中运行 cAdvisor；使用 /dev/cgroups 的 hostPath</li>
<li>允许 pod 指定给定的 hostPath 是否应该在 pod 运行之前存在，是否应该创建，以及它应该以什么形式存在</li>
</ul>
<p><strong>除了所需的path属性之外，用户还可以为hostPath卷指定type</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在挂载 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td>DirectoryOrCreate</td>
<td>如果在给定的路径上没有任何东西存在，那么将根据需要在那里创建一个空目录，权限设置为 0755，与 Kubelet 具有相同的组和所有权。</td>
</tr>
<tr>
<td>Directory</td>
<td>给定的路径下必须存在目录。</td>
</tr>
<tr>
<td>FileOrCreate</td>
<td>如果在给定的路径上没有任何东西存在，那么会根据需要创建一个空文件，权限设置为 0644，与 Kubelet 具有相同的组和所有权。</td>
</tr>
<tr>
<td>File</td>
<td>给定的路径下必须存在文件。</td>
</tr>
<tr>
<td>Socket</td>
<td>给定的路径下必须存在 UNIX 套接字。</td>
</tr>
<tr>
<td>CharDevice</td>
<td>给定的路径下必须存在字符设备。</td>
</tr>
<tr>
<td>BlockDevice</td>
<td>给定的路径下必须存在块设备。</td>
</tr>
</tbody></table>
<p><strong>使用这种卷类型是请注意，因为：</strong></p>
<ul>
<li>由于每个节点上的文件都不同，具有相同配置（例如从 podTemplate 创建的）的 pod 在不同节点上的行为可能会有所不同。</li>
<li>当 Kubernetes 按照计划添加资源感知调度时，将无法考虑hostPath使用的资源。</li>
<li>在底层主机上创建的文件或目录只能由 root 写入。您需要在特权容器中以 root 身份运行进程，或修改主机上的文件权限以便写入hostPath卷。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat hostpath.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">h-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/hv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># this field is optional</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -owide</span><br><span class="line">NAME    READY   STATUS              RESTARTS   AGE   IP       NODE                 </span><br><span class="line">h-pod   0/1     ContainerCreating   0          7s    &lt;none&gt;   k8s-node-192.168.2.22</span><br><span class="line"></span><br><span class="line">$ hostname</span><br><span class="line">k8s-node-192.168.2.22</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;hv test&#x27;</span> &gt; /data/h-test.log</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it h-pod -- cat /hv/h-test.log</span><br><span class="line">hv <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-Persistent-Volume（PV）"><a href="#7-4-Persistent-Volume（PV）" class="headerlink" title="7.4 Persistent Volume（PV）"></a>7.4 Persistent Volume（PV）</h3><blockquote>
<p>PersistentVolume（简称PV） 是 Volume 之类的卷插件，也是集群中的资源，但独立于Pod的生命周期（即不会因Pod删除而被删除），不归属于某个Namespace。</p>
<p>PersistentVolumeClaim（简称PVC）是用户存储的请求，PVC消耗PV的资源，可以请求特定的大小和访问模式，需要指定归属于某个Namespace，在同一个Namespace 的 Pod才可以指定对应的PVC。</p>
</blockquote>
<p>PV (持久化卷)，是对底层的共享存储的一种抽象，PV 由管理员进行创建和配置, 它和具体的底层的共享存储技术的实现方式有关，比如Ceph、GlusterFS、NFS等，都是通过插件机制完成与共享存储的对接。</p>
<p>PVC (持久化卷声明)，PVC 是用户存储的一种声明，PVC 和 Pod 比较类型，Pod 是消耗节点，PVC 消耗的是 PV 资源，Pod 可以请求 CPU 的内存，而 PVC 可以请求特定的存储空间和访问模式。对于真正存储的用户不需要关心底层的存储实现细节，只需要直接使用PVC即可。</p>
<p>但是通过PVC请求一定的存储空间也很有可能不足以满足对于存储设备的各种需求，而且不同的应用程序对于存储性能的要求也能也不尽相同，比如读写速度、并发性能等，为了解决这一问题，Kubernetes又为我们引入了一个新的资源对象: StorageClass,通过StorageClass的定义，管理员可以将存储资源定义为某种类型的资源，比如快速存储、慢速存储等，用户根据StorageClass的描述就可以非常直观的知道各种存储资源特性了，这样就可以根据应用的特性去申请合适的存储资源了。</p>
<h4 id="7-4-1-PV-和-PVC的生命周期"><a href="#7-4-1-PV-和-PVC的生命周期" class="headerlink" title="7.4.1 PV 和 PVC的生命周期"></a>7.4.1 PV 和 PVC的生命周期</h4><blockquote>
<p>PV 可以看作可用的存储资源，PVC则是对存储资源的需求，PV 和 PVC的互相关系遵循如下图</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3b92l4j31720loh4b.jpg" alt="image-20210311104829767"></p>
<h4 id="7-4-2-资源供应-Provisioning"><a href="#7-4-2-资源供应-Provisioning" class="headerlink" title="7.4.2 资源供应 (Provisioning)"></a>7.4.2 资源供应 (Provisioning)</h4><blockquote>
<p>Kubernetes支持两种资源的供应模式：静态模式(Staic)和动态模式(Dynamic)。资源供应的结果就是创建好的PV。</p>
</blockquote>
<ul>
<li>静态模式：集群管理员手工创建许多 PV，在定义 PV 时需要将后端存储的特性进行设置。</li>
<li>动态模式：集群管理员无须手工创建 PV，而是通过 StorageClass 的设置对后端存储进行描述，标记为某种 “类型(Class)”。此时要求 PVC 对存储的类型进行声明，系统将自动完成 PV 的创建及 PVC 的绑定。<ul>
<li>PVC 可以声明 Class 为””，说明该 PVC 禁止使用动态模式。</li>
</ul>
</li>
</ul>
<p>1、静态资源下，通过PV和PVC完成绑定，并供Pod使用的存储管理机制</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3j0i4cj31on0u0e81.jpg" alt="image-20210311105424072"></p>
<p>2.动态资源下，通过StorageClass和PVC完成资源动态绑定 (系统自动生成PV，并供Pod使用的存储管理机制)</p>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3mu4rwj31ny0u0e81.jpg" alt="image-20210311105449805"></p>
<h4 id="7-4-3-资源绑定-Binding"><a href="#7-4-3-资源绑定-Binding" class="headerlink" title="7.4.3 资源绑定 (Binding)"></a>7.4.3 资源绑定 (Binding)</h4><p>在用户定义好PVC后，系统将根据PVC对存储资源的请求 (存储空间和访问模式)在已存在的PV中选择一个满足PVC要求的PV，一旦找到，就将该PV与用户定义的PVC进行绑定，然后用户的应用就可以使用这个PVC了。如果系统中没有满足PVC要求的PV，PVC则会无限期处于Pending状态，直到等到系统管理员创建了一个符合要求的PV。PV一旦绑定在某个PVC上，就被这个PVC独占，不能再与其他PVC进行绑定了。在这种情况下，当PVC申请的存储空间比PV的少时，整个PV的空间都能够为PVC所用，可能会造成资源的浪费。如果资源供应使用的是动态模式，则系统在PVC找到合适的StorageClass后，将会自动创建PV并完成PVC的绑定。</p>
<h4 id="7-4-4-资源使用-Using"><a href="#7-4-4-资源使用-Using" class="headerlink" title="7.4.4 资源使用 (Using)"></a>7.4.4 资源使用 (Using)</h4><p>Pod 使用volume的定义, 将 PVC 挂载到容器内的某个路径进行使用。volume 的类型为 persistentVoulumeClaim , 在容器应用挂载了一个 PVC 后, 就能被持续独占使用。</p>
<p>不过, 多个Pod可以挂载同一个PVC, 应用程序需要考虑多个实例共同访问一块存储空间的问题。</p>
<h4 id="7-4-5-资源释放-Releasing"><a href="#7-4-5-资源释放-Releasing" class="headerlink" title="7.4.5 资源释放 (Releasing)"></a>7.4.5 资源释放 (Releasing)</h4><p>当用户对存储资源使用哪个完毕后，用户可以删除PVC，与该PVC绑定的PV将会被标记为已释放，但还不能立刻与其他PVC进行绑定。通过之前PVC写入的数据可能还留在存储设备上，只有在清除之后该PV才能继续使用。</p>
<h4 id="7-4-6-资源回收-Reclaiming"><a href="#7-4-6-资源回收-Reclaiming" class="headerlink" title="7.4.6 资源回收 (Reclaiming)"></a>7.4.6 资源回收 (Reclaiming)</h4><p>对于PV，管理员可以设定回收策略(Reclaim Policy)用于设置与之绑定的PVC释放资源之后，对于遗留数据如何处理。只有PV的存储空间完成回收，才能供新的PVC绑定和使用。</p>
<h4 id="7-4-7-持久化卷声明的保护"><a href="#7-4-7-持久化卷声明的保护" class="headerlink" title="7.4.7 持久化卷声明的保护"></a>7.4.7 持久化卷声明的保护</h4><p>PVC 保护的目的是确保由 pod 正在使用的 PVC 不会从系统中移除，因为如果被移除的话可能会导致数据丢失，当启用 PVC 保护 alpha 功能时，如果用户删除了一个 pod 正在使用的 PVC，则该 PVC 不会被立即删除。PVC 的删除将被推迟，直到 PVC 不再被任何 pod 使用。</p>
<h4 id="7-4-8-PV-的类型-及-访问模式"><a href="#7-4-8-PV-的类型-及-访问模式" class="headerlink" title="7.4.8 PV 的类型 及 访问模式"></a>7.4.8 PV 的类型 及 访问模式</h4><blockquote>
<p>PersistentVolume 类型以插件形式实现。以下仅列部分常用类型：</p>
</blockquote>
<ul>
<li>GCEPersistentDisk</li>
<li>AWSElasticBlockStore</li>
<li>NFS</li>
<li>RBD (Ceph Block Device)</li>
<li>CephFS、Glusterfs</li>
</ul>
<blockquote>
<p>PV 的访问模式 有三种 ReadWriteOnce 、 ReadOnlyMany 、 ReadWriteMany</p>
</blockquote>
<p>PersistentVolume 可以以资源提供者支持的任何方式挂载到主机上。如下表所示，供应商具有不同的功能，每个PV 的访问模式都将被设置为该卷支持的特定模式。例如，NFS 可以支持多个读/写客户端，但特定的 NFS PV 可能以只读方式导出到服务器上。每个 PV 都有一套自己的用来描述特定功能的访问模式。</p>
<ul>
<li>ReadWriteOnce——该卷可以被单个节点以读/写模式挂载（命令行缩写：RWO）</li>
<li>ReadOnlyMany——该卷可以被多个节点以只读模式挂载（命令行缩写：ROX）</li>
<li>ReadWriteMany——该卷可以被多个节点以读/写模式挂载（命令行缩写：RWX）</li>
</ul>
<p>一个卷一次只能使用一种访问模式挂载，即使它支持很多访问模式。以下只列举部分常用插件</p>
<table>
<thead>
<tr>
<th align="left">Volume 插件</th>
<th align="left">ReadWriteOnce</th>
<th align="left">ReadOnlyMany</th>
<th align="left">ReadWriteMany</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AWSElasticBlockStore</td>
<td align="left">✓</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">CephFS</td>
<td align="left">✓</td>
<td align="left">✓</td>
<td align="left">✓</td>
</tr>
<tr>
<td align="left">GCEPersistentDisk</td>
<td align="left">✓</td>
<td align="left">✓</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Glusterfs</td>
<td align="left">✓</td>
<td align="left">✓</td>
<td align="left">✓</td>
</tr>
<tr>
<td align="left">HostPath</td>
<td align="left">✓</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="left">✓</td>
<td align="left">✓</td>
<td align="left">✓</td>
</tr>
<tr>
<td align="left">RBD</td>
<td align="left">✓</td>
<td align="left">✓</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h4 id="7-4-9-PV-的回收策略-及-阶段状态"><a href="#7-4-9-PV-的回收策略-及-阶段状态" class="headerlink" title="7.4.9 PV 的回收策略 及 阶段状态"></a>7.4.9 PV 的回收策略 及 阶段状态</h4><blockquote>
<p>回收策略包括</p>
</blockquote>
<ul>
<li>Retain（保留）——手动回收</li>
<li>Recycle（回收）——基本擦除（ rm -rf /thevolume/* ）【ps 在新版本中该策略已被弃用】</li>
<li>Delete（删除）——关联的存储资产（例如 AWS EBS、GCE PD、Azure Disk 和 OpenStack Cinder 卷）将被删除。</li>
</ul>
<p>当前，只有 NFS 和 HostPath 支持回收策略。AWS EBS、GCE PD、Azure Disk 和 Cinder 卷支持删除策略。</p>
<blockquote>
<p>PV 可以处于以下的某种状态</p>
</blockquote>
<ul>
<li>Available（可用）——一块空闲资源还没有被任何声明绑定</li>
<li>Bound（已绑定）——卷已经被声明绑定</li>
<li>Released（已释放）——声明被删除，但是资源还未被集群重新声明</li>
<li>Failed（失败）——该卷的自动回收失败</li>
</ul>
<p>命令行会显示绑定到 PV 的 PVC 的名称。</p>
<h4 id="7-4-10-PV-的实验演练-NFS"><a href="#7-4-10-PV-的实验演练-NFS" class="headerlink" title="7.4.10 PV 的实验演练 - NFS"></a>7.4.10 PV 的实验演练 - NFS</h4><p>1、安装 NFS 服务器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有的节点都需要安装 nfs-utils 和 rpcbind</span></span><br><span class="line">$ yum install -y nfs-common nfs-utils  rpcbind</span><br><span class="line">$ mkdir -p /nfs01 /nfs02 /nfs03 /nfs04</span><br><span class="line">$ chmod 777 /nfs01 /nfs02 /nfs03 /nfs04</span><br><span class="line">$ chown nfsnobody /nfs01 /nfs02 /nfs03 /nfs04</span><br><span class="line">$ cat /etc/exports</span><br><span class="line">/nfs01 *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/nfs02 *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/nfs03 *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/nfs04 *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">$ systemctl start rpcbind nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆k8s任意一台节点上测试下nfs</span></span><br><span class="line">$ showmount -e 192.168.245.44</span><br><span class="line">Export list <span class="keyword">for</span> 192.168.245.44:</span><br><span class="line">/nfs01 *</span><br><span class="line">/nfs02 *</span><br><span class="line">/nfs03 *</span><br><span class="line">/nfs04 *</span><br><span class="line">$ mkdir /<span class="built_in">test</span></span><br><span class="line">$ mount -t nfs 192.168.245.44:/nfs01 /<span class="built_in">test</span>/</span><br><span class="line">$ <span class="built_in">cd</span> /<span class="built_in">test</span>/</span><br><span class="line">$ touch tset.txt</span><br><span class="line">$ <span class="built_in">echo</span> lemon &gt; test.txt</span><br><span class="line">$ cat test.txt </span><br><span class="line">lemon</span><br><span class="line">$ umount /<span class="built_in">test</span></span><br><span class="line">$ rm -rf /<span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>2、部署 PV</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs01</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.245</span><span class="number">.44</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs02</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.245</span><span class="number">.44</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs03</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.245</span><span class="number">.44</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">30Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">static</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs04</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.245</span><span class="number">.44</span></span><br></pre></td></tr></table></figure>

<p>3、创建服务并使用 PVC</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v3vm0fdj31cu0p2n3w.jpg" alt="image-20210311162007092"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;web-0&#x27;</span> &gt; /nfs01/index.html</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;web-1&#x27;</span> &gt; /nfs02/index.html</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;web-2&#x27;</span> &gt; /nfs03/index.html</span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.24</span><br><span class="line">web-0</span><br><span class="line">$ curl 10.244.1.26</span><br><span class="line">web-1</span><br><span class="line">$ curl 10.244.1.27</span><br><span class="line">web-2</span><br></pre></td></tr></table></figure>

<h4 id="7-4-11-关于-StatefulSet-的说明"><a href="#7-4-11-关于-StatefulSet-的说明" class="headerlink" title="7.4.11 关于 StatefulSet 的说明"></a>7.4.11 关于 StatefulSet 的说明</h4><ul>
<li>匹配 Pod name ( 网络标识 ) 的模式为：$(statefulset名称)-$(序号)，比如上面的示例：web-0，web-1，web-2 。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod </span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">h-pod   1/1     Running   0          23h</span><br><span class="line">web-0   1/1     Running   0          48m</span><br><span class="line">web-1   1/1     Running   0          48m</span><br><span class="line">web-2   1/1     Running   0          48m</span><br></pre></td></tr></table></figure>

<ul>
<li>StatefulSet 为每个 Pod 副本创建了一个 DNS 域名，这个域名的格式为： $(podname).(headless servername)，也就意味着服务间是通过Pod域名来通信而非 Pod IP，因为当Pod所在Node发生故障时， Pod 会被飘移到其它 Node 上，Pod IP 会发生变化，但是 Pod 域名不会有变化。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it h-pod -- /bin/sh</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping -c 3 web-0.nginx</span></span><br><span class="line">PING web-0.nginx (10.244.2.24): 56 data bytes</span><br><span class="line">64 bytes from 10.244.2.24: seq=0 ttl=64 time=0.137 ms</span><br><span class="line">64 bytes from 10.244.2.24: seq=1 ttl=64 time=0.056 ms</span><br><span class="line">64 bytes from 10.244.2.24: seq=2 ttl=64 time=0.076 ms</span><br></pre></td></tr></table></figure>

<ul>
<li>StatefulSet 使用 Headless 服务来控制 Pod 的域名，这个域名的 FQDN 为：$(servicename).$(namespace).svc.cluster.local，其中，“cluster.local” 指的是集群的域名。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -owide -n kube-system | grep coredns</span><br><span class="line">coredns-5c98db65d4-4v4kd                            1/1     Running   13         47d   10.244.1.17</span><br><span class="line">coredns-5c98db65d4-9k5xw                            1/1     Running   7          47d   10.244.0.9</span><br><span class="line"></span><br><span class="line">$ dig -t A nginx.default.svc.cluster.local. @10.244.0.9</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">nginx.default.svc.cluster.local. 11 IN  A       10.244.2.24</span><br><span class="line">nginx.default.svc.cluster.local. 11 IN  A       10.244.1.26</span><br><span class="line">nginx.default.svc.cluster.local. 11 IN  A       10.244.1.27</span><br></pre></td></tr></table></figure>

<ul>
<li>根据 volumeClaimTemplates，为每个 Pod 创建一个 pvc，pvc 的命名规则匹配模式：(volumeClaimTemplates.name)-(pod_name)，比如上面的 volumeMounts.name=www， Podname=web-[0-2]，因此创建出来的 PVC 是 www-web-0、www-web-1、www-web-2 。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc</span><br><span class="line">NAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">www-web-0   Bound    nfspv1   1Gi        RWO            nfs            173m</span><br><span class="line">www-web-1   Bound    nfspv2   10Gi       RWO            nfs            172m</span><br><span class="line">www-web-2   Bound    nfspv3   20Gi       RWO            nfs            172m</span><br></pre></td></tr></table></figure>

<ul>
<li>删除 Pod 不会删除其 pvc，手动删除 pvc 将自动释放 pv</li>
</ul>
<p><strong>Statefulset的启停顺序</strong></p>
<ul>
<li>有序部署：部署StatefulSet时，如果有多个Pod副本，它们会被顺序地创建（从0到N-1）并且，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pv </span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS</span><br><span class="line">nfspv1   1Gi        RWO            Retain           Available           nfs         </span><br><span class="line">nfspv2   10Gi       RWO            Retain           Available           static      </span><br><span class="line">nfspv3   20Gi       RWO            Retain           Available           slow</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc.yaml</span><br><span class="line">service/nginx created</span><br><span class="line">statefulset.apps/web created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里可以看到第二个 pod 一直处于 pending 状态，导致第三个 pod 都没有创建出来</span></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running   0          19s</span><br><span class="line">web-1   0/1     Pending   0          16s</span><br></pre></td></tr></table></figure>

<ul>
<li>有序删除：当Pod被删除时，它们被终止的顺序是从N-1到0。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -owide -n default -w</span><br><span class="line">$ kubectl delete statefulset web -n default</span><br></pre></td></tr></table></figure>

<ul>
<li>有序扩展：当对 Pod 执行扩展操作时，与部署一样，它前面的Pod必须都处于Running和Ready状态。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale statefulset/web --replicas=4</span><br></pre></td></tr></table></figure>

<p><strong>StatefulSet使用场景</strong></p>
<ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于 PVC 来实现。</li>
<li>稳定的网络标识符，即 Pod 重新调度后其 PodName 和 HostName 不变。</li>
<li>有序部署，有序扩展，基于 init containers 来实现。</li>
<li>有序收缩。</li>
</ul>
<h4 id="7-4-12-PV卷-的资源释放流程"><a href="#7-4-12-PV卷-的资源释放流程" class="headerlink" title="7.4.12 PV卷 的资源释放流程"></a>7.4.12 PV卷 的资源释放流程</h4><blockquote>
<p>生产环境下要再三确认后才可以进行如下操作</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># statefulset &gt; svc &gt; pvc &gt; 使用 edit 删除 pv 卷上的 pvc 记录</span></span><br><span class="line">$ kubectl delete -f pvc.yaml</span><br><span class="line">$ kubectl delete pvc www-web-0 www-web-1 www-web-2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 虽然已经删除了 pvc，但实际上还并没有释放 pv，因为在pv的记录信息里面还是有使用者信息的，需要手工删除后才会释放</span></span><br><span class="line">$ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS</span><br><span class="line">nfspv1   1Gi        RWO            Retain           Released    default/www-web-0   nfs</span><br><span class="line">nfspv2   10Gi       RWO            Retain           Released    default/www-web-1   nfs</span><br><span class="line">nfspv3   20Gi       RWO            Retain           Released    default/www-web-2   nfs</span><br><span class="line">nfspv4   30Gi       RWX            Retain           Available                       static</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动删除这一段，pv 就会释放资源了, 其他的 pod 也就可以继续使用这些 pv 卷了</span></span><br><span class="line">$ kubectl get pv nfspv1 -o yaml</span><br><span class="line">  claimRef:</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: PersistentVolumeClaim</span><br><span class="line">    name: www-web-0</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: <span class="string">&quot;69260&quot;</span></span><br><span class="line">    uid: e175a86b-aa2c-4900-a7c4-faa1865315ab</span><br><span class="line"></span><br><span class="line">$ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS</span><br><span class="line">nfspv1   1Gi        RWO            Retain           Available           nfs         </span><br><span class="line">nfspv2   10Gi       RWO            Retain           Available           nfs         </span><br><span class="line">nfspv3   20Gi       RWO            Retain           Available           nfs         </span><br><span class="line">nfspv4   30Gi       RWX            Retain           Available           static     </span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果这些卷及数据都不想要了的话，直接在对应的nfs机器上删除挂在点上的数据，并在master上删除pv卷 kubectl delete pv xx</span></span><br></pre></td></tr></table></figure>



<h1 id="五、K8S集群调度"><a href="#五、K8S集群调度" class="headerlink" title="五、K8S集群调度"></a>五、K8S集群调度</h1><blockquote>
<p>Scheduler 是 kubernetes 的调度器，主要任务是把定义的 pod 分配到集群的节点上。有四点需要考虑：</p>
</blockquote>
<ul>
<li>公平：如何保证每个节点都能被分配资源</li>
<li>资源高效利用：集群所有资源最大化被使用</li>
<li>灵活：允许用户根据自己的需求控制调度的逻辑</li>
<li>效率：调度的性能要好，能够尽快地对大批量的 pod 完成调度工作</li>
</ul>
<p>Sheduler 是作为单独的程序运行的，启动之后会一直监听 API Server，获取PodSpec.NodeName为空的 pod，对每个 pod 都会创建一个 binding，表明该 pod 应该放到哪个节点上。</p>
<h2 id="1、调度说明"><a href="#1、调度说明" class="headerlink" title="1、调度说明"></a>1、调度说明</h2><h3 id="调度过程"><a href="#调度过程" class="headerlink" title="调度过程"></a>调度过程</h3><p>调度分为几个部分：首先是过滤掉不满足条件的节点，这个过程称为<code>predicate</code>；然后对通过的节点按照优先级排序，这个是<code>priority</code>；最后从中选择优先级最高的节点。如果中间任何一步骤有错误，就直接返回错误。</p>
<p><strong>Predicate 有一系列的算法可以使用：</strong></p>
<ul>
<li>PodFitsResources：节点上剩余的资源是否大于 pod 请求的资源</li>
<li>PodFitsHost：如果 pod 指定了 NodeName，检查节点名称是否和 NodeName 匹配</li>
<li>PodFitsHostPorts：节点上已经使用的 port 是否和 pod 申请的 port 冲突</li>
<li>PodSelectorMatches：过滤掉和 pod 指定的 label 不匹配的节点</li>
<li>NoDiskConflict：已经 mount 的 volume 和 pod 指定的 volume 不冲突，除非它们都是只读</li>
</ul>
<p>如果在 predicate 过程中没有合适的节点，pod 会一直在pending状态，不断重试调度，直到有节点满足条件。经过这个步骤，如果有多个节点满足条件，就继续 priorities 过程：按照优先级大小对节点排序。</p>
<p>优先级由一系列键值对组成，键是该优先级项的名称，值是它的权重（该项的重要性）。这些优先级选项包括：</p>
<ul>
<li>LeastRequestedPriority：通过计算 CPU 和 Memory 的使用率来决定权重，使用率越低权重越高。换句话说，这个优先级指标倾向于资源使用比例更低的节点</li>
<li>BalancedResourceAllocation：节点上 CPU 和 Memory 使用率越接近, 权重越高。这个要和上面的一起使用, 不应该单独使用</li>
<li>ImageLocalityPriority：倾向于已经有要使用镜像的节点，镜像总大小值越大，权重越高</li>
</ul>
<p><strong>通过算法对所有的优先级项目和权重进行计算，得出最终的结果。</strong></p>
<h3 id="自定义调度器"><a href="#自定义调度器" class="headerlink" title="自定义调度器"></a>自定义调度器</h3><p>除了 kubernetes 自带的调度器，你也可以编写自己的调度器。通过spec:schedulername参数指定调度器的名字，可以为 pod 选择某个调度器进行调度。比如下面的 pod 选择my-scheduler进行调度，而不是默认的default-scheduler：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">annotation-second-scheduler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">multischeduler-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedulername:</span> <span class="string">my-scheduler</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-with-second-annotation-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br></pre></td></tr></table></figure>



<h2 id="2、调度亲和性"><a href="#2、调度亲和性" class="headerlink" title="2、调度亲和性"></a>2、调度亲和性</h2><blockquote>
<p>一般情况下 POD 是通过集群自动调度选择某个节点的，默认情况下调度器考虑的是资源足够，并且负载尽量平均，但是有的时候需要能够更加细粒度的去控制 POD 的调度，比如内部的一些服务 gitlab 之类的也是跑在<code>Kubernetes</code>集群上的，就不希望对外的一些服务和内部的服务跑在同一个节点上了，害怕内部服务对外部的服务产生影响；有的时候两个服务直接交流比较频繁，又希望能够将这两个服务的 POD 调度到同样的节点上。</p>
<p>这就需要用到 Kubernetes 里面的一个概念：亲和性，亲和性主要分为两类：<code>nodeAffinity</code>和<code>podAffinity</code>。</p>
</blockquote>
<h3 id="节点亲和性（nodeAffinity）"><a href="#节点亲和性（nodeAffinity）" class="headerlink" title="节点亲和性（nodeAffinity）"></a>节点亲和性（nodeAffinity）</h3><p><strong>键值运算关系</strong></p>
<ul>
<li>In：label 的值在某个列表中</li>
<li>NotIn：label 的值不在某个列表中</li>
<li>Gt：label 的值大于某个值</li>
<li>Lt：label 的值小于某个值</li>
<li>Exists：某个 label 存在</li>
<li>DoesNotExist：某个 label 不存在</li>
</ul>
<p><code>pod.spec.nodeAffinity</code></p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodeaffinity01</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node-192.168.2.55</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels   <span class="comment"># 查看节点的LABELS</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod -owide   <span class="comment"># 由于没有k8s-node-192.168.2.55值的key，而且还是硬策略，所以pod会一直pending中。</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nodeaffinity01   0/1     Pending   0          5s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodeaffinity02</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node-192.168.2.55</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -owide     <span class="comment"># 软策略</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE     IP           NODE</span><br><span class="line">nodeaffinity01   0/1     Pending   0          3m46s   &lt;none&gt;       &lt;none&gt;</span><br><span class="line">nodeaffinity02   1/1     Running   0          5s      10.244.4.8   k8s-node-192.168.2.33</span><br></pre></td></tr></table></figure>

<p>Tips：硬策略和软策略是可以合并一起使用的，但是必须要先满足硬策略，才能在满足软策略。</p>
<h3 id="Pod-亲和性（podAffinity）"><a href="#Pod-亲和性（podAffinity）" class="headerlink" title="Pod 亲和性（podAffinity）"></a>Pod 亲和性（podAffinity）</h3><p><code>pod.spec.affinity.podAffinity/podAntiAffinity</code></p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemon</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node-192.168.2.33</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lemon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">lemon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lemon</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">lemon</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">tools</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">armin</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -owide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP            NODE</span><br><span class="line">lemon   1/1     Running   0          4s    10.244.4.12   k8s-node-192.168.2.33</span><br><span class="line"><span class="built_in">test</span>    1/1     Running   0          4s    10.244.4.11   k8s-node-192.168.2.33</span><br></pre></td></tr></table></figure>

<p><strong>亲和性/反亲和性调度策略比较如下：</strong></p>
<table>
<thead>
<tr>
<th>调度策略</th>
<th>匹配标签</th>
<th>操作符</th>
<th>拓扑域支持</th>
<th>调度目标</th>
</tr>
</thead>
<tbody><tr>
<td>nodeAffinity</td>
<td>主机</td>
<td>In, NotIn, Exists,DoesNotExist, Gt, Lt</td>
<td>否</td>
<td>指定主机</td>
</tr>
<tr>
<td>podAffinity</td>
<td>POD</td>
<td>In, NotIn, Exists,DoesNotExist</td>
<td>是</td>
<td>POD与指定POD同一拓扑域</td>
</tr>
<tr>
<td>podAnitAffinity</td>
<td>POD</td>
<td>In, NotIn, Exists,DoesNotExist</td>
<td>是</td>
<td>POD与指定POD不在同一拓扑域</td>
</tr>
</tbody></table>
<p>Tips：拓扑域 就是节点的意思</p>
<h2 id="3、调度污点"><a href="#3、调度污点" class="headerlink" title="3、调度污点"></a>3、调度污点</h2><blockquote>
<p>节点亲和性，是pod的一种属性（偏好或硬性要求），它使pod被吸引到一类特定的节点。Taint 则相反，它使节点能够排斥一类特定的 pod。</p>
<p><strong>Taint 和 Toleration</strong></p>
<p>Taint 和 toleration 相互配合，可以用来避免 pod 被分配到不合适的节点上。每个节点上都可以应用一个或多个taint ，这表示对于那些不能容忍这些 taint 的 pod，是不会被该节点接受的。如果将 toleration 应用于 pod上，则表示这些 pod 可以（但不要求）被调度到具有匹配 taint 的节点上</p>
</blockquote>
<h3 id="污点-Taint"><a href="#污点-Taint" class="headerlink" title="污点(Taint)"></a>污点(Taint)</h3><p><strong>1、污点 ( Taint ) 的组成</strong></p>
<p>使用<code>kubectl taint</code>命令可以给某个 Node 节点设置污点，Node 被设置上污点之后就和 Pod 之间存在了一种相斥的关系，可以让 Node 拒绝 Pod 的调度执行，甚至将 Node 已经存在的 Pod 驱逐出去。</p>
<p>每个污点的组成如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">key=value:effect</span></span><br></pre></td></tr></table></figure>

<p>每个污点有一个 key 和 value 作为污点的标签, 其中 value 可以为空, effect 描述污点的作用。当前 tainteffect 支持如下三个选项：</p>
<ul>
<li><code>NoSchedule</code>：表示 k8s 将不会将 Pod 调度到具有该污点的 Node 上</li>
<li><code>PreferNoSchedule</code>：表示 k8s 将尽量避免将 Pod 调度到具有该污点的 Node 上</li>
<li><code>NoExecute</code>：表示 k8s 将不会将 Pod 调度到具有该污点的 Node 上，同时会将 Node 上已经存在的 Pod 驱逐出去</li>
</ul>
<p><strong>2、污点的设置、查看和去除</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置污点</span></span><br><span class="line">$ kubectl taint nodes node1 key1=value1:NoExecute</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点说明中，查找 Taints 字段</span></span><br><span class="line">$ kubectl describe node node-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除污点</span></span><br><span class="line">$ kubectl taint nodes node1 key1:NoExecute-</span><br></pre></td></tr></table></figure>

<h3 id="容忍-Tolerations"><a href="#容忍-Tolerations" class="headerlink" title="容忍(Tolerations)"></a>容忍(Tolerations)</h3><p>设置了污点的 Node 将根据 taint 的 effect：NoSchedule、PreferNoSchedule、NoExecute 和 Pod 之间产生互斥的关系，Pod 将在一定程度上不会被调度到 Node 上。但我们可以在 Pod 上设置容忍 ( Toleration ) ，意思是设置了容忍的 Pod 将可以容忍污点的存在，可以被调度到存在污点的 Node 上。</p>
<p><strong>pod.spec.tolerations</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key2&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;PreferNoSchedule&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>其中 key, vaule, effect 要与 Node 上设置的 taint 保持一致</p>
</li>
<li><p>operator 的值为 Exists 将会忽略 value 值</p>
</li>
<li><p>tolerationSeconds 用于描述当 Pod 需要被驱逐时可以在 Node 上继续保留运行的时间，会一直循环</p>
</li>
</ul>
<p><strong>1、不指定 key 值时，表示容忍所有的污点 key</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>2、当不指定 effect 值时，表示容忍所有的污点作用</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>3、有多个 Master 存在时，防止资源浪费，可以如下设置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes Node-Name node-role.kubernetes.io/master=:PreferNoSchedule</span><br></pre></td></tr></table></figure>

<h2 id="4、固定节点"><a href="#4、固定节点" class="headerlink" title="4、固定节点"></a>4、固定节点</h2><h3 id="指定调度节点"><a href="#指定调度节点" class="headerlink" title="指定调度节点"></a>指定调度节点</h3><p><strong>1、Pod.spec.nodeName 将 Pod 直接调度到指定的 Node 节点上，会跳过 Scheduler 的调度策略，该匹配规则是强制匹配。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">k8s-node-192.168.2.22</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>2、Pod.spec.nodeSelector：通过 kubernetes 的 label-selector 机制选择节点，由调度器调度策略匹配 label，而后调度 Pod 到目标节点，该匹配规则属于强制约束。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web02</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">k1:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web02</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">arminto/my_nginx:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label node k8s-node-192.168.2.33 k1=v1</span><br></pre></td></tr></table></figure>



<h1 id="六、K8S-集群安全"><a href="#六、K8S-集群安全" class="headerlink" title="六、K8S 集群安全"></a>六、K8S 集群安全</h1><blockquote>
<p>机制说明：Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。API Server 是集群内部各个组件通信的中介，也是外部控制的入口。所以 Kubernetes 的安全机制基本就是围绕保护 API Server 来设计的。Kubernetes 使用了认证（Authentication）、鉴权（Authorization）、准入控制（AdmissionControl）三步来保证API Server的安全。</p>
</blockquote>
<p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v47gg29j31mc0qeqhz.jpg" alt="image-20210406174845095"></p>
<h2 id="1、集群认证"><a href="#1、集群认证" class="headerlink" title="1、集群认证"></a>1、集群认证</h2><h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><ul>
<li>HTTP Token 认证：通过一个 Token 来识别合法用户<ul>
<li>HTTP Token 的认证是用一个很长的特殊编码方式的并且难以被模仿的字符串 - Token 来表达客户的一种方式。Token 是一个很长的很复杂的字符串，每一个 Token 对应一个用户名存储在 API Server 能访问的文件中。当客户端发起 API 调用请求时，需要在 HTTP Header 里放入 Token。</li>
</ul>
</li>
<li>HTTP Base 认证：通过用户名+密码的方式认证<ul>
<li>用户名+：+密码用 BASE64 算法进行编码后的字符串放在 HTTP Request 中的 HeatherAuthorization 域里发送给服务端，服务端收到后进行编码，获取用户名及密码</li>
</ul>
</li>
<li>最严格的 HTTPS 证书认证：基于 CA 根证书签名的客户端身份认证方式</li>
</ul>
<h3 id="HTTPS-证书认证"><a href="#HTTPS-证书认证" class="headerlink" title="HTTPS 证书认证"></a>HTTPS 证书认证</h3><p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4bw64tj31720s0jw1.jpg" alt="image-20210406175149666"></p>
<h3 id="需要认证的节点"><a href="#需要认证的节点" class="headerlink" title="需要认证的节点"></a>需要认证的节点</h3><p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4fnrinj311o0okn8s.jpg" alt="image-20210406175424225"></p>
<p><strong>两种类型</strong></p>
<ul>
<li>两种类型Kubenetes 组件对 API Server 的访问：kubectl、Controller Manager、Scheduler、kubelet、kube-proxy</li>
<li>Kubernetes 管理的 Pod 对容器的访问：Pod（dashborad 也是以 Pod 形式运行）</li>
</ul>
<p><strong>安全性说明</strong></p>
<ul>
<li>Controller Manager、Scheduler 与 API Server 在同一台机器，所以直接使用 API Server 的非安全端口访问，<code>--insecure-bind-address=127.0.0.1</code></li>
<li>kubectl、kubelet、kube-proxy 访问 API Server 就都需要证书进行 HTTPS 双向认证</li>
</ul>
<p><strong>证书颁发</strong></p>
<ul>
<li>手动签发：通过 k8s 集群的跟 ca 进行签发 HTTPS 证书</li>
<li>自动签发：kubelet 首次访问 API Server 时，使用 token 做认证，通过后，Controller Manager 会为kubelet 生成一个证书，以后的访问都是用证书做认证了</li>
</ul>
<h3 id="kubeconfig"><a href="#kubeconfig" class="headerlink" title="kubeconfig"></a>kubeconfig</h3><p>kubeconfig 文件包含集群参数（CA证书、API Server地址），客户端参数（上面生成的证书和私钥），集群context 信息（集群名称、用户名）。Kubenetes 组件通过启动时指定不同的 kubeconfig 文件可以切换到不同的集群。</p>
<h3 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h3><p>Pod中的容器访问API Server。因为Pod的创建、销毁是动态的，所以要为它手动生成证书就不可行了。Kubenetes使用了Service Account解决Pod 访问API Server的认证问题。</p>
<h3 id="Secret-与-SA-的关系"><a href="#Secret-与-SA-的关系" class="headerlink" title="Secret 与 SA 的关系"></a>Secret 与 SA 的关系</h3><p>Kubernetes 设计了一种资源对象叫做 Secret，分为两类，一种是用于 ServiceAccount 的 service-account-token，另一种是用于保存用户自定义保密信息的 Opaque。ServiceAccount 中用到包含三个部分：Token、ca.crt、namespace。</p>
<ul>
<li>oken是使用 API Server 私钥签名的 JWT。用于访问API Server时，Server端认证</li>
<li>ca.crt，根证书。用于Client端验证API Server发送的证书</li>
<li>namespace, 标识这个service-account-token的作用域名空间</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret --all-namespaces</span><br><span class="line">kubectl describe secret default-token-5gm9r --namespace=kube-system</span><br></pre></td></tr></table></figure>

<p>默认情况下，每个 namespace 都会有一个 ServiceAccount，如果 Pod 在创建时没有指定 ServiceAccount，就会使用 Pod 所属的 namespace 的 ServiceAccount。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="https://bucket-1301203199.cos.ap-shanghai.myqcloud.com/armin/008i3skNly1gr7v4kfopij31jw0cgq6z.jpg" alt="image-20210406175833477"></p>
<h2 id="2、集群鉴权"><a href="#2、集群鉴权" class="headerlink" title="2、集群鉴权"></a>2、集群鉴权</h2><h2 id="3、准入控制"><a href="#3、准入控制" class="headerlink" title="3、准入控制"></a>3、准入控制</h2><p>准入控制是API Server的插件集合，通过添加不同的插件，实现额外的准入控制规则。甚至于API Server的一些主要的功能都需要通过 Admission Controllers 实现，比如 ServiceAccount。</p>
<p>官方文档上有一份针对不同版本的准入控制器推荐列表，其中最新的 1.14 的推荐列表是：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota</span><br></pre></td></tr></table></figure>

<p>列举几个插件的功能：</p>
<ul>
<li>NamespaceLifecycle：防止在不存在的 namespace 上创建对象，防止删除系统预置 namespace，删除namespace 时，连带删除它的所有资源对象。</li>
<li>LimitRanger：确保请求的资源不会超过资源所在 Namespace 的 LimitRange 的限制。</li>
<li>ServiceAccount：实现了自动化添加 ServiceAccount。</li>
<li>ResourceQuota：确保请求的资源不会超过资源的 ResourceQuota 限制。</li>
</ul>

    </div>

    
    
    

      <div>
        
          <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

        
      </div>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2021/06/06/MySQL/" rel="next" title="MySQL">
      MySQL <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81K8S%E6%A6%82%E5%BF%B5"><span class="nav-text">一、K8S概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFKubernetes"><span class="nav-text">1. 什么是Kubernetes ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%83%EF%BC%9F%E4%BB%96%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9F"><span class="nav-text">2. 为什么需要它？他的功能？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E6%88%91%E4%BF%AE%E5%A4%8D"><span class="nav-text">自我修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="nav-text">弹性伸缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="nav-text">自动部署和回滚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E7%BC%96%E6%8E%92"><span class="nav-text">存储编排</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">服务发现和负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%BA%E5%AF%86%E5%92%8C%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-text">机密和配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="nav-text">资源监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BE%9B%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="nav-text">提供认证和授权</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Kubernetes%E6%9E%B6%E6%9E%84"><span class="nav-text">3. Kubernetes架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Kubernetes%E7%BB%84%E4%BB%B6"><span class="nav-text">4. Kubernetes组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Master-%E7%BB%84%E4%BB%B6"><span class="nav-text">4.1 Master 组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#API-Server"><span class="nav-text">API Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Scheduler"><span class="nav-text">Scheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Controller-manager"><span class="nav-text">Controller manager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ETCD"><span class="nav-text">ETCD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Node%E7%BB%84%E4%BB%B6"><span class="nav-text">4.2 Node组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kube-proxy"><span class="nav-text">Kube-proxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flannel%E7%BD%91%E7%BB%9C"><span class="nav-text">Flannel网络</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E9%87%8D%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="nav-text">4.3 重要组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Coredns"><span class="nav-text">Coredns</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dashboard"><span class="nav-text">Dashboard</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingress-Controller"><span class="nav-text">Ingress Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Federation"><span class="nav-text">Federation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus"><span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ELK"><span class="nav-text">ELK</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-k8s%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E6%A6%82%E5%BF%B5"><span class="nav-text">5. k8s网络架构概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">6. Kubernetes核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-container"><span class="nav-text">6.1 container</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-namespace"><span class="nav-text">6.2 namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-labels"><span class="nav-text">6.3 labels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-pod"><span class="nav-text">6.4 pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-Controller-Manager"><span class="nav-text">6.5 Controller Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-services"><span class="nav-text">6.6 services</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2K8S%E9%9B%86%E7%BE%A4%EF%BC%88kubeadm%EF%BC%89"><span class="nav-text">二、部署K8S集群（kubeadm）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">1. 系统环境初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%8D%87%E7%BA%A7%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E5%B9%B6%E4%BC%98%E5%8C%96"><span class="nav-text">2. 升级系统内核并优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%83%A8%E7%BD%B2Docker%E3%80%81kubeadm%E3%80%81kubectl"><span class="nav-text">3. 部署Docker、kubeadm、kubectl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-text">4. 初始化主节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%8A%A0%E5%85%A5%E4%B8%BB%E8%8A%82%E7%82%B9%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BD%99%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9"><span class="nav-text">5. 加入主节点以及其余工作节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E9%83%A8%E7%BD%B2-CNI-flannel%E7%BD%91%E7%BB%9C"><span class="nav-text">6. 部署 CNI - flannel网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-%E5%92%8C%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="nav-text">7. 查看集群状态 和相关的容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AEharbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93"><span class="nav-text">8. 搭建配置harbor私有仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E5%9F%BA%E6%9C%AC%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8BK8S"><span class="nav-text">9. 基本的使用下K8S</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81Kubectl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">三、Kubectl常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-text">1. 查看集群状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="nav-text">2. 创建资源对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E6%9F%A5%E7%9C%8B%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="nav-text">3、查看资源对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E6%89%93%E5%8D%B0%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="nav-text">4、打印容器中日志信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">5、在容器中执行命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="nav-text">6、删除资源对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="nav-text">7、更新资源对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81%E5%B0%86%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E5%87%BA%E5%8E%BB-%E5%88%9B%E5%BB%BAService"><span class="nav-text">8、将服务暴露出去(创建Service)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9%E3%80%81%E6%89%A9%E5%AE%B9%E5%92%8C%E7%BC%A9%E5%AE%B9"><span class="nav-text">9、扩容和缩容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10%E3%80%81%E6%9F%A5%E7%9C%8BAPI%E7%89%88%E6%9C%AC"><span class="nav-text">10、查看API版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11%E3%80%81%E5%9C%A8%E6%9C%AC%E5%9C%B0%E4%B8%BB%E6%9C%BA%E4%B8%8A%E4%B8%BAAPI-Server%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3"><span class="nav-text">11、在本地主机上为API Server启动一个代理网关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12%E3%80%81%E5%BD%93%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%97%B6%EF%BC%8C%E4%B8%8D%E7%9F%A5%E9%81%93%E6%80%8E%E4%B9%88%E5%AE%9A%E4%B9%89%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%E6%9F%90%E7%B1%BB%E5%9E%8B%E8%B5%84%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE%E5%AD%97%E6%AE%B5%E8%A7%A3%E9%87%8A"><span class="nav-text">12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13%E3%80%81%E6%9F%A5%E7%9C%8B%E6%9F%90%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">13、查看某资源对象的配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14%E3%80%81%E6%A0%87%E7%AD%BE%E7%AE%A1%E7%90%86%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-text">14、标签管理相关命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15%E3%80%81%E6%B3%A8%E8%A7%A3%E7%AE%A1%E7%90%86%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-text">15、注解管理相关命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16%E3%80%81patch%E4%BF%AE%E6%94%B9Deployment%E6%8E%A7%E5%88%B6%E5%99%A8%E8%BF%9B%E8%A1%8C%E6%8E%A7%E5%88%B6%E5%99%A8%E5%8D%87%E7%BA%A7"><span class="nav-text">16、patch修改Deployment控制器进行控制器升级</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81k8s%E7%9A%84%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">四、k8s的资源清单（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B"><span class="nav-text">1. 资源类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E7%BA%A7%E5%88%AB"><span class="nav-text">1.1 名称空间级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E9%9B%86%E7%BE%A4%E7%BA%A7%E8%B5%84%E6%BA%90%E7%BA%A7%E5%88%AB"><span class="nav-text">1.2 集群级资源级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%85%83%E6%95%B0%E6%8D%AE%E5%9E%8B%E8%B5%84%E6%BA%90"><span class="nav-text">1.3 元数据型资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="nav-text">2. 资源清单</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-yaml%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="nav-text">2.1 yaml语法格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-k8s%E5%89%A7%E6%9C%AC%E7%9A%84%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5"><span class="nav-text">2.2 k8s剧本的常用字段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81pod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">3、pod的生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Init-C"><span class="nav-text">3.1 Init C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%AE%B9%E5%99%A8%E6%8E%A2%E9%92%88"><span class="nav-text">3.2 容器探针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Pod-hook"><span class="nav-text">3.3 Pod hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Init-C-amp-%E6%8E%A2%E9%92%88-%E6%95%B4%E5%90%88%E4%BD%BF%E7%94%A8"><span class="nav-text">3.4 Init C &amp; 探针 整合使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Pod%E7%9A%84%E7%9B%B8%E4%BD%8D"><span class="nav-text">3.5 Pod的相位</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81controllers-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">4、controllers 控制器 </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-ReplicationController"><span class="nav-text">1. ReplicationController</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ReplicaSet"><span class="nav-text">2. ReplicaSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Deployment"><span class="nav-text">3. Deployment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-deployment-%E5%AF%B9%E8%B1%A1"><span class="nav-text">3.1 创建一个 deployment 对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-Deployment-%E6%89%A9%E5%AE%B9%E7%BC%A9"><span class="nav-text">3.2 Deployment 扩容缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="nav-text">3.3 滚动升级和回滚</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-DaemonSet"><span class="nav-text">4. DaemonSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Jobs-%EF%BC%9A%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BB%BB%E5%8A%A1"><span class="nav-text">5. Jobs ：一次性任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-CronJob-%EF%BC%9A%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-text">6. CronJob ：定时任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-StateFulSet"><span class="nav-text">7. StateFulSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-Horizontal-Pod-Autoscaler"><span class="nav-text">8. Horizontal Pod Autoscaler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81Service"><span class="nav-text">5、Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Service-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">5.1 Service 的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-VIP-%E5%92%8C-Service-%E4%BB%A3%E7%90%86"><span class="nav-text">5.2 VIP 和 Service 代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-ClusterIP"><span class="nav-text">5.3 ClusterIP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-Headless-Service"><span class="nav-text">5.4 Headless Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-NodePort"><span class="nav-text">5.5 NodePort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-LoadBalancer"><span class="nav-text">5.6 LoadBalancer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-ExternalName"><span class="nav-text">5.7 ExternalName</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81Ingress"><span class="nav-text">6、Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E9%83%A8%E7%BD%B2-Ingress-Nginx"><span class="nav-text">6.1 部署 Ingress-Nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81K8S-%E5%AD%98%E5%82%A8"><span class="nav-text">7、K8S - 存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-ConfigMap"><span class="nav-text">7.1 ConfigMap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-1-ConfigMap-%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-text">7.1.1 ConfigMap 的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-Pod-%E4%B8%AD%E4%BD%BF%E7%94%A8-ConfigMap"><span class="nav-text">7.1.2 Pod 中使用 ConfigMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-ConfigMap-%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-text">7.1.3 ConfigMap 的热更新</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Secret"><span class="nav-text">7.2 Secret</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-Service-Account"><span class="nav-text">7.2.1 Service Account</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-Opaque-Secret"><span class="nav-text">7.2.2 Opaque Secret</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-dockerconfigjson"><span class="nav-text">7.2.3 dockerconfigjson</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-Volume"><span class="nav-text">7.3 Volume</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-emptyDir"><span class="nav-text">7.3.1 emptyDir</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-hostPath"><span class="nav-text">7.3.2 hostPath</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-Persistent-Volume%EF%BC%88PV%EF%BC%89"><span class="nav-text">7.4 Persistent Volume（PV）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-1-PV-%E5%92%8C-PVC%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">7.4.1 PV 和 PVC的生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-2-%E8%B5%84%E6%BA%90%E4%BE%9B%E5%BA%94-Provisioning"><span class="nav-text">7.4.2 资源供应 (Provisioning)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-3-%E8%B5%84%E6%BA%90%E7%BB%91%E5%AE%9A-Binding"><span class="nav-text">7.4.3 资源绑定 (Binding)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8-Using"><span class="nav-text">7.4.4 资源使用 (Using)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-5-%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE-Releasing"><span class="nav-text">7.4.5 资源释放 (Releasing)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-6-%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6-Reclaiming"><span class="nav-text">7.4.6 资源回收 (Reclaiming)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-7-%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%B7%E5%A3%B0%E6%98%8E%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="nav-text">7.4.7 持久化卷声明的保护</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-8-PV-%E7%9A%84%E7%B1%BB%E5%9E%8B-%E5%8F%8A-%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="nav-text">7.4.8 PV 的类型 及 访问模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-9-PV-%E7%9A%84%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5-%E5%8F%8A-%E9%98%B6%E6%AE%B5%E7%8A%B6%E6%80%81"><span class="nav-text">7.4.9 PV 的回收策略 及 阶段状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-10-PV-%E7%9A%84%E5%AE%9E%E9%AA%8C%E6%BC%94%E7%BB%83-NFS"><span class="nav-text">7.4.10 PV 的实验演练 - NFS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-11-%E5%85%B3%E4%BA%8E-StatefulSet-%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="nav-text">7.4.11 关于 StatefulSet 的说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-12-PV%E5%8D%B7-%E7%9A%84%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE%E6%B5%81%E7%A8%8B"><span class="nav-text">7.4.12 PV卷 的资源释放流程</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81K8S%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6"><span class="nav-text">五、K8S集群调度</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E8%B0%83%E5%BA%A6%E8%AF%B4%E6%98%8E"><span class="nav-text">1、调度说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E8%BF%87%E7%A8%8B"><span class="nav-text">调度过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-text">自定义调度器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%B0%83%E5%BA%A6%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="nav-text">2、调度亲和性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88nodeAffinity%EF%BC%89"><span class="nav-text">节点亲和性（nodeAffinity）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%88podAffinity%EF%BC%89"><span class="nav-text">Pod 亲和性（podAffinity）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E8%B0%83%E5%BA%A6%E6%B1%A1%E7%82%B9"><span class="nav-text">3、调度污点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9-Taint"><span class="nav-text">污点(Taint)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%BF%8D-Tolerations"><span class="nav-text">容忍(Tolerations)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%9B%BA%E5%AE%9A%E8%8A%82%E7%82%B9"><span class="nav-text">4、固定节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%B0%83%E5%BA%A6%E8%8A%82%E7%82%B9"><span class="nav-text">指定调度节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81K8S-%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8"><span class="nav-text">六、K8S 集群安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E9%9B%86%E7%BE%A4%E8%AE%A4%E8%AF%81"><span class="nav-text">1、集群认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication"><span class="nav-text">Authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTPS-%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="nav-text">HTTPS 证书认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%E7%9A%84%E8%8A%82%E7%82%B9"><span class="nav-text">需要认证的节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeconfig"><span class="nav-text">kubeconfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceAccount"><span class="nav-text">ServiceAccount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Secret-%E4%B8%8E-SA-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">Secret 与 SA 的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E9%9B%86%E7%BE%A4%E9%89%B4%E6%9D%83"><span class="nav-text">2、集群鉴权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="nav-text">3、准入控制</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Armin"
      src="/uploads/armin.png">
  <p class="site-author-name" itemprop="name">Armin</p>
  <div class="site-description" itemprop="description">记录生活中的点点滴滴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://aws.amazon.com/cn/" title="AWS → https:&#x2F;&#x2F;aws.amazon.com&#x2F;cn&#x2F;" rel="noopener" target="_blank"><i class="fab fa-aws fa-fw"></i>AWS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.processon.com/" title="processon → https:&#x2F;&#x2F;www.processon.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-accusoft fa-fw"></i>processon</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.cn-ki.net/" title="知识库 → https:&#x2F;&#x2F;www.cn-ki.net&#x2F;" rel="noopener" target="_blank"><i class="fas fa-book-open fa-fw"></i>知识库</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tophub.today/" title="看新闻 → https:&#x2F;&#x2F;tophub.today&#x2F;" rel="noopener" target="_blank"><i class="far fa-newspaper fa-fw"></i>看新闻</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://m.zxjsq.net/" title="计算器 → http:&#x2F;&#x2F;m.zxjsq.net" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>计算器</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://shijisuishu.bmcx.com/20010314__shijisuishu/" title="计龄器 → https:&#x2F;&#x2F;shijisuishu.bmcx.com&#x2F;20010314__shijisuishu&#x2F;" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>计龄器</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tool.oschina.net/hexconvert" title="进制转换 → https:&#x2F;&#x2F;tool.oschina.net&#x2F;hexconvert" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>进制转换</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.sojson.com/convert/subnetmask.html" title="子网计算 → https:&#x2F;&#x2F;www.sojson.com&#x2F;convert&#x2F;subnetmask.html" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>子网计算</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.baidu.com/" title="百度一下 → https:&#x2F;&#x2F;www.baidu.com&#x2F;" rel="noopener" target="_blank"><i class="fas fa-search fa-fw"></i>百度一下</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Armin</span>
</div>

<div class="powered-by">

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
