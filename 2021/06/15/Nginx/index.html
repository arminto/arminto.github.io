<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="http://example.com/2021/06/15/Nginx/index.html">
<meta property="og:site_name" content="LEMON">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid4v3vwjj30s60gy0v5.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid4zznyxj30xc05adg0.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid52dbu7j30xc05a74o.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid557adcj30xc05awen.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid57z03ej30xc05aaaj.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid5ac1r9j30xc05aaai.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid5d4htkj30xc05agm3.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid5gwp8kj310c0fsjsv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid5k4oxyj616w0cln0w02.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid5nw02tj31c90sun3v.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid694kv0j30rb0kodhn.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid6bwqcmj31540lf0w7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid6e3pa9j31890emq4k.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid7c5keqj31bp0u013s.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sni7ry5j314f0p94by.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7so7k5uij31b10pee84.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sod9i5yj319o0qtkjo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7soiwo8hj31340hejyb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sop7go5j315y0odas7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sozuqmoj30pc0fwq3r.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7spblndjj30u10csaek.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7spiu5oej30on0bdwgx.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7spqmr40j30qr0cn41u.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7spyv97xj30to05mglw.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sq2htlfj30ww0jjtb8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sq6u6r6j30tu0ea3zu.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sv34f1oj61hc0sinph02.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7svbstuxj313z0l44qs.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7svgvf0tj30t80820t3.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7svmwy6hj30pu03d74x.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7svvyiutj31aj0sdu10.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sw0ycd2j61au0rfqv802.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sw5uzz7g310c0c7gm9.gif">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7swahpqrj31610qp4gv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7swidxvcj319a0e97bj.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7swmxm9gj316f0qj4qs.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7swuhc5wj61a80pue8402.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sx06ldjj30tn0lv7wj.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sy86vfej30u404l74g.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sy27w9hj30qh03kgls.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sxfyj9hj31hc0bbgnr.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7syhozhaj30z30bq0y4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sypy5lmj30yd0aw0uo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7syvdbxpj30pi03mmxs.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7sz2mjkyj31hc0rw7m5.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7szkq003j31hc0rth41.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7szpo4npj31gf0s077e.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNly1gr7szvbsb9j31gf0rx77c.jpg">
<meta property="article:published_time" content="2021-06-14T19:04:45.000Z">
<meta property="article:modified_time" content="2021-07-13T13:24:03.280Z">
<meta property="article:author" content="Armin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008i3skNly1grid4v3vwjj30s60gy0v5.jpg">

<link rel="canonical" href="http://example.com/2021/06/15/Nginx/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nginx | LEMON</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">LEMON</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/15/Nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/armin.png">
      <meta itemprop="name" content="Armin">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LEMON">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
      
        <!--toc-->
<span id="more"></span>

<h1 id="Web网站概念"><a href="#Web网站概念" class="headerlink" title="Web网站概念"></a>Web网站概念</h1><h2 id="1-Web网站常识"><a href="#1-Web网站常识" class="headerlink" title="1. Web网站常识"></a>1. Web网站常识</h2><ol>
<li><p>域名：域名是一个IP地址的“面具” ，目的是便于记忆和访问一个或一组服务器的地址（网站，电子邮件，FTP等）。</p>
</li>
<li><p>域名解析：本地HOSTS解析、DNS服务器解析</p>
</li>
<li><p>网站的基本概念：网站、网页、主页；HTTP、URL、HTML、超链接</p>
</li>
<li><p>web网站：有web1.0（以编辑为特征）和web2.0（侧重用户交互）</p>
</li>
<li><p>动态页面与静态页面的差别, 静态页面内容几乎是固定的, 而动态页面的内容会因用户、浏览器、时间等而发生变化</p>
</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid4v3vwjj30s60gy0v5.jpg" alt="image-20200625141505969"></p>
<h2 id="2-URL的组成部分"><a href="#2-URL的组成部分" class="headerlink" title="2. URL的组成部分"></a>2. URL的组成部分</h2><h3 id="2-1-协议-Protocol"><a href="#2-1-协议-Protocol" class="headerlink" title="2.1 协议(Protocol)"></a>2.1 协议(Protocol)</h3><p><em><strong>http://</strong></em> 为协议名, 标明了请求需要使用的协议, 通常使用的就是HTTP协议 或 安全协议 HTTPS。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid4zznyxj30xc05adg0.jpg" alt="image-20200625143705588"></p>
<h3 id="2-2-域名-Domain"><a href="#2-2-域名-Domain" class="headerlink" title="2.2 域名(Domain)"></a>2.2 域名(Domain)</h3><p><em><strong><a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a></strong></em> 为域名, 标明了需要请求的服务器的地址。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid52dbu7j30xc05a74o.jpg" alt="image-20200625143903439"></p>
<h3 id="2-3-端口-Port"><a href="#2-3-端口-Port" class="headerlink" title="2.3 端口(Port)"></a>2.3 端口(Port)</h3><p><em><strong>:80</strong></em> 是端口号, 标明了获取服务器资源的入口, 端口号用于区分服务的端口, 一台拥有公网IP的服务器可以提供许多服务, 比如Web服务、FTP服务、SMTP服务等;  服务器的资源是通过“IP地址+端口号”来区分不同的服务,  如果把服务器比作房子,  端口号就可以看做是通向不同服务的门。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid557adcj30xc05awen.jpg" alt="image-20200625143922623"></p>
<h3 id="2-4-URL文件资源"><a href="#2-4-URL文件资源" class="headerlink" title="2.4 URL文件资源"></a>2.4 URL文件资源</h3><p><em><strong>/path/to/myfile.html</strong></em> 表示服务器上资源的路径, 过去这样的路径标记的是服务器上文件的物理路径, 但是现在路径表示的只是一个抽象地址, 并不指代任何物理地址。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid57z03ej30xc05aaaj.jpg" alt="image-20200625144036536"></p>
<h3 id="2-5-参数-query"><a href="#2-5-参数-query" class="headerlink" title="2.5 参数(query)"></a>2.5 参数(query)</h3><p><em><strong>?key1=value1&amp;key2=value2</strong></em> 是请求里提供的额外参数, 这些参数是以键值对的形式,通过<code>&amp;</code>符号分隔开来,服务器可以通过这些参数进行相应的个性化处理。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid5ac1r9j30xc05aaai.jpg" alt="image-20200625144053593"></p>
<h3 id="2-6-片段-fragment"><a href="#2-6-片段-fragment" class="headerlink" title="2.6 片段(fragment)"></a>2.6 片段(fragment)</h3><p><em><strong>#SomewhereInTheDocument</strong></em> 是对资源的部分补充, <code>fragment</code>可以理解为资源内部的<code>书签</code>, 用来想服务器指明展示的内容所在的<code>书签</code>的点; 例如对于<code>HTML</code>文件来说, 浏览器会滚动到特定的或者上次浏览过的位置.对于音频或者视频资源来说,浏览器又会跳转到对应的时间节点。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid5d4htkj30xc05agm3.jpg" alt="image-20200625144100710"></p>
<h1 id="HTTP协议概念"><a href="#HTTP协议概念" class="headerlink" title="HTTP协议概念"></a>HTTP协议概念</h1><blockquote>
<p>HTTP是超文本传输协议，其定义了客户端与服务器端之间文本传输的规范。HTTP默认使用80端口，这个端口指的是服务端的端口，而客户端使用的端口是动态分配的。当我们没有指定端口访问时，浏览器会默认帮我们添加80端口。我们也可以自己指定访问端口如：<a href="http://www.ip.com:80。">http://www.ip.com:80。</a> </p>
<p>需要注意的是，现在大多数访问都使用了HTTPS协议，而HTTPS的默认端口为443，如果使用80端口访问HTTPS协议的服务器可能会被拒绝。</p>
</blockquote>
<h2 id="1-HTTP协议简介"><a href="#1-HTTP协议简介" class="headerlink" title="1. HTTP协议简介"></a>1. HTTP协议简介</h2><ol>
<li><p>HTTP协议的核心功能是传输Web服务器上的HTML 页面及其他文件；可以理解HTTP协议就是做业务的。</p>
</li>
<li><p>HTTP协议版本 http0.9（已过时）、http1.0和http1.1（目前广泛使用）、http2.0（未普及）</p>
</li>
<li><p>HTTP协议有多种获得 Web 资源的方法，最为常见的就是GET和POST及方法</p>
</li>
<li><p>HTTP请求会有很多的状态码，常看到的有：200、301、404、500等等</p>
</li>
<li><p>HTTP报文格式，一个完整的http访问包含请求（request）和响应（response）</p>
</li>
</ol>
<h2 id="2-HTTP请求的方法"><a href="#2-HTTP请求的方法" class="headerlink" title="2. HTTP请求的方法"></a>2. HTTP请求的方法</h2><blockquote>
<p>根据 HTTP 标准，HTTP 请求可以使用多种请求方法。</p>
<p>HTTP1.0 定义了三种请求方法： GET, POST 和 HEAD方法。</p>
<p>HTTP1.1 新增了六种请求方法：OPTIONS、PUT、PATCH、DELETE、TRACE 和 CONNECT 方法。</p>
</blockquote>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>请求指定的页面信息，并返回实体主体。</td>
</tr>
<tr>
<td>HEAD</td>
<td>类似于 GET 请求，只不过返回的响应中没有具体的内容，用于获取报头</td>
</tr>
<tr>
<td>POST</td>
<td>向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST 请求可能会导致新的资源的建立和/或已有资源的修改。</td>
</tr>
<tr>
<td>PUT</td>
<td>从客户端向服务器传送的数据取代指定的文档的内容。</td>
</tr>
<tr>
<td>DELETE</td>
<td>请求服务器删除指定的页面。</td>
</tr>
<tr>
<td>CONNECT</td>
<td>HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器。</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>允许客户端查看服务器的性能。</td>
</tr>
<tr>
<td>TRACE</td>
<td>回显服务器收到的请求，主要用于测试或诊断。</td>
</tr>
<tr>
<td>PATCH</td>
<td>是对 PUT 方法的补充，用来对已知资源进行局部更新 。</td>
</tr>
</tbody></table>
<h2 id="3-HTTP响应头信息"><a href="#3-HTTP响应头信息" class="headerlink" title="3. HTTP响应头信息"></a>3. HTTP响应头信息</h2><table>
<thead>
<tr>
<th>应答头</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Allow</td>
<td>服务器支持哪些请求方法（如GET、POST等）。</td>
</tr>
<tr>
<td>Content-Encoding</td>
<td>文档的编码（Encode）方法。只有在解码之后才可以得到Content-Type头指定的内容类型。利用gzip压缩文档能够显著地减少HTML文档的下载时间。Java的GZIPOutputStream可以很方便地进行gzip压缩，但只有Unix上的Netscape和Windows上的IE 4、IE  5才支持它。因此，Servlet应该通过查看Accept-Encoding头（即request.getHeader(“Accept-Encoding”)）检查浏览器是否支持gzip，为支持gzip的浏览器返回经gzip压缩的HTML页面，为其他浏览器返回普通页面。</td>
</tr>
<tr>
<td>Content-Length</td>
<td>表示内容长度。只有当浏览器使用持久HTTP连接时才需要这个数据。如果你想要利用持久连接的优势，可以把输出文档写入  ByteArrayOutputStream，完成后查看其大小，然后把该值放入Content-Length头，最后通过byteArrayStream.writeTo(response.getOutputStream()发送内容。</td>
</tr>
<tr>
<td>Content-Type</td>
<td>表示后面的文档属于什么MIME类型。Servlet默认为text/plain，但通常需要显式地指定为text/html。由于经常要设置Content-Type，因此HttpServletResponse提供了一个专用的方法setContentType。</td>
</tr>
<tr>
<td>Date</td>
<td>当前的GMT时间。你可以用setDateHeader来设置这个头以避免转换时间格式的麻烦。</td>
</tr>
<tr>
<td>Expires</td>
<td>应该在什么时候认为文档已经过期，从而不再缓存它？</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>文档的最后改动时间。客户可以通过If-Modified-Since请求头提供一个日期，该请求将被视为一个条件GET，只有改动时间迟于指定时间的文档才会返回，否则返回一个304（Not Modified）状态。Last-Modified也可用setDateHeader方法来设置。</td>
</tr>
<tr>
<td>Location</td>
<td>表示客户应当到哪里去提取文档。Location通常不是直接设置的，而是通过HttpServletResponse的sendRedirect方法，该方法同时设置状态代码为302。</td>
</tr>
<tr>
<td>Refresh</td>
<td>表示浏览器应该在多少时间之后刷新文档，以秒计。除了刷新当前文档之外，你还可以通过setHeader(“Refresh”, “5; URL=<a target="_blank" rel="noopener" href="http://host/path&quot;)%E8%AE%A9%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82">http://host/path&quot;)让浏览器读取指定的页面。</a>  注意这种功能通常是通过设置HTML页面HEAD区的＜META HTTP-EQUIV=”Refresh”  CONTENT=”5;URL=<a target="_blank" rel="noopener" href="http://host/path&quot;%EF%BC%9E%E5%AE%9E%E7%8E%B0%EF%BC%8C%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA%EF%BC%8C%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0%E6%88%96%E9%87%8D%E5%AE%9A%E5%90%91%E5%AF%B9%E4%BA%8E%E9%82%A3%E4%BA%9B%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8CGI%E6%88%96Servlet%E7%9A%84HTML%E7%BC%96%E5%86%99%E8%80%85%E5%8D%81%E5%88%86%E9%87%8D%E8%A6%81%E3%80%82%E4%BD%86%E6%98%AF%EF%BC%8C%E5%AF%B9%E4%BA%8EServlet%E6%9D%A5%E8%AF%B4%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%AE%BE%E7%BD%AERefresh%E5%A4%B4%E6%9B%B4%E5%8A%A0%E6%96%B9%E4%BE%BF%E3%80%82">http://host/path&quot;＞实现，这是因为，自动刷新或重定向对于那些不能使用CGI或Servlet的HTML编写者十分重要。但是，对于Servlet来说，直接设置Refresh头更加方便。</a>   注意Refresh的意义是”N秒之后刷新本页面或访问指定页面”，而不是”每隔N秒刷新本页面或访问指定页面”。因此，连续刷新要求每次都发送一个Refresh头，而发送204状态代码则可以阻止浏览器继续刷新，不管是使用Refresh头还是＜META HTTP-EQUIV=”Refresh” …＞。   注意Refresh头不属于HTTP 1.1正式规范的一部分，而是一个扩展，但Netscape和IE都支持它。</td>
</tr>
<tr>
<td>Server</td>
<td>服务器名字。Servlet一般不设置这个值，而是由Web服务器自己设置。</td>
</tr>
<tr>
<td>Set-Cookie</td>
<td>设置和页面关联的Cookie。Servlet不应使用response.setHeader(“Set-Cookie”, …)，而是应使用HttpServletResponse提供的专用方法addCookie。参见下文有关Cookie设置的讨论。</td>
</tr>
<tr>
<td>WWW-Authenticate</td>
<td>客户应该在Authorization头中提供什么类型的授权信息？在包含401（Unauthorized）状态行的应答中这个头是必需的。例如，response.setHeader(“WWW-Authenticate”, “BASIC realm=＼”executives＼””)。  注意Servlet一般不进行这方面的处理，而是让Web服务器的专门机制来控制受密码保护页面的访问（例如.htaccess）。</td>
</tr>
</tbody></table>
<h2 id="4-HTTP状态代码"><a href="#4-HTTP状态代码" class="headerlink" title="4. HTTP状态代码"></a>4. HTTP状态代码</h2><blockquote>
<p>HTTP状态码的英文为HTTP Status Code。</p>
<p>HTTP状态码由三个十进制数字组成，第一个十进制数字定义了状态码的类型，后两个数字没有分类的作用。HTTP状态码共分为5种类型：1xx   2xx   3xx   4xx   5xx 。</p>
<p>当用户访问一个网页时，浏览器会向网页所在服务器发出请求，当浏览器接收并显示网页前，此网页所在的服务器会返回一个包含HTTP状态码的信息头（server header）用以响应浏览器的请求。</p>
</blockquote>
<p><strong>下面是最常见的HTTP状态码：</strong></p>
<blockquote>
<p>200        服务器成功返回内容</p>
<p>301/2     永久/临时重定向</p>
<p>304        未修改 Not Modified</p>
<p>307        重定向中保留原始数据</p>
<p>404        请求的页面不存在</p>
<p>413        请求实体太大，服务器拒绝处理当前请求</p>
<p>500        服务器内部错误</p>
<p>502        代理请求后端失败</p>
<p>503        服务器暂时不可用</p>
<p>504        请求成功，但是连接超时</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid5gwp8kj310c0fsjsv.jpg" alt="image-20200625162413480"></p>
<p><strong><a target="_blank" rel="noopener" href="https://www.runoob.com/http/http-status-codes.html">其他的一些HTTP状态码</a></strong></p>
<h2 id="5-HTTP-content-type"><a href="#5-HTTP-content-type" class="headerlink" title="5. HTTP  content-type"></a>5. HTTP  content-type</h2><p><strong>简介</strong></p>
<blockquote>
<p>Content-Type（内容类型），一般是指网页中存在的 Content-Type，用于定义网络文件的类型和网页的编码，决定浏览器将以什么形式、什么编码读取这个文件，这就是经常看到一些 PHP 网页点击的结果却是下载一个文件或一张图片的原因。</p>
<p>Content-Type 标头告诉客户端实际返回的内容的内容类型。</p>
</blockquote>
<p><strong>语法</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=something</span><br></pre></td></tr></table></figure>

<p><strong>实例</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid5k4oxyj616w0cln0w02.jpg" alt="image-20200625160438655"></p>
<p><strong>常见的媒体格式类型如下</strong></p>
<ul>
<li>text/html ： HTML格式</li>
<li>text/plain ：纯文本格式</li>
<li>text/xml ： XML格式</li>
<li>image/gif ：gif图片格式</li>
<li>image/jpeg ：jpg图片格式</li>
<li>image/png：png图片格式</li>
</ul>
<p><strong>以application开头的媒体格式类型</strong></p>
<ul>
<li>application/xhtml+xml ：XHTML格式</li>
<li>application/xml： XML数据格式</li>
<li>application/atom+xml ：Atom XML聚合格式</li>
<li>application/json： JSON数据格式</li>
<li>application/pdf：pdf格式</li>
<li>application/msword ： Word文档格式</li>
<li>application/octet-stream ： 二进制流数据（如常见的文件下载）</li>
</ul>
<p><strong>常见的媒体格式是上传文件之时使用的</strong></p>
<ul>
<li>multipart/form-data ： 需要在表单中进行文件上传时，就需要使用该格式</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://www.runoob.com/http/http-content-type.html">更加详细的HTTP  content-type 对照表</a></strong></p>
<h1 id="Nginx原理介绍"><a href="#Nginx原理介绍" class="headerlink" title="Nginx原理介绍"></a>Nginx原理介绍</h1><h2 id="1-1-Nginx-概述"><a href="#1-1-Nginx-概述" class="headerlink" title="1.1 Nginx 概述"></a>1.1 Nginx 概述</h2><blockquote>
<p>Nginx是⼀一个开源且⾼高性能、可靠的HTTP中间件、代理理服务。</p>
<p>开源: 直接获取源代码</p>
<p>⾼高性能: 支持海海量量并发</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid5nw02tj31c90sun3v.jpg" alt="image-2020062420084954569"></p>
<h2 id="1-2-Nginx的优缺点"><a href="#1-2-Nginx的优缺点" class="headerlink" title="1.2 Nginx的优缺点"></a>1.2 Nginx的优缺点</h2><ul>
<li><p><strong>优点</strong></p>
<ul>
<li><strong>高并发量</strong><ul>
<li>根据官方给出的数据，能够支持高达 50000 个<a target="_blank" rel="noopener" href="https://baike.sogou.com/v193462.htm">并发连接数</a>的响应。</li>
</ul>
</li>
<li><strong>内存消耗少</strong><ul>
<li>处理静态文件，同样起web 服务，比apache 占用更少的内存及资源，所以它是轻量级的。</li>
</ul>
</li>
<li><strong>简单稳定</strong><ul>
<li>配置简单，基本在一个conf文件中配置，性能比较稳定，可以7*24小时长时间不间断运行。</li>
</ul>
</li>
<li><strong>支持Rwrite重写规则</strong><ul>
<li>能够根据域名、URL的不同， 将HTTP请求分发到不同的后端服务器群组。</li>
</ul>
</li>
<li><strong>功能多，低成本</strong><ul>
<li>Nginx可以做高并发的负载均衡，且Nginx是开源免费的，如果使用F5等硬件来做负载均衡，硬件成本比较高。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>缺点</strong></p>
<ul>
<li><strong>动态处理差</strong><ul>
<li>Nginx处理静态文件好，耗费内存少，但是处理动态页面则很鸡肋</li>
</ul>
</li>
<li><strong>rewrite弱</strong><ul>
<li>虽然Nginx支持rewrite功能，但是相比于Apache来说，Apache比nginx 的rewrite 要强大。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-3-Nginx应用场景"><a href="#1-3-Nginx应用场景" class="headerlink" title="1.3 Nginx应用场景"></a>1.3 Nginx应用场景</h2><blockquote>
<p>静态处理</p>
<p>反向代理</p>
<p>负载均衡</p>
<p>资源缓存</p>
<p>安全防护</p>
<p>访问限制</p>
<p>访问认证</p>
</blockquote>
<h2 id="1-4-Nginx的进程模型"><a href="#1-4-Nginx的进程模型" class="headerlink" title="1.4 Nginx的进程模型"></a>1.4 Nginx的进程模型</h2><blockquote>
<p><strong>Nginx的启动方式有两种：</strong></p>
</blockquote>
<ul>
<li><p><strong>单进程启动：</strong></p>
<ul>
<li>此时系统中只有一个进程，这个进程既是master进程，也是worker进程。</li>
</ul>
</li>
<li><p><strong>多进程启动：</strong></p>
<ul>
<li>此时系统中有且仅有一个master进程，有多个worker进程，master进程主要是用来管理worker进程的。</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Nginx有两种进程：</strong></p>
</blockquote>
<p><strong>Master主进程：</strong></p>
<ol>
<li>接收客户端的请求，然后在将客户端的请求交给他下面的子进程，子进程返回处理结果后，再将处理结果返回给客户端</li>
<li>监控并管理子进程的运行状态，当子进程出现异常情况下退出后，自动生成新的子进程</li>
</ol>
<p><strong>Worker子进程：</strong></p>
<ol>
<li>将主进程的请求交给内核去处理，然后在继续接收主进程发来的请求，当内核处理完后，返回给子进程处理结果，然后子进程再将结果返回给主进程。</li>
<li>Nginx子进程的数量一般我们会设置与当前服务器的CPU核心数一致，可以使用<code>auto</code>指令让Nginx跟进系统自动设置worker</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid694kv0j30rb0kodhn.jpg" alt="image-20200621181846932"></p>
<h2 id="1-5-Nginx的组成逻辑图"><a href="#1-5-Nginx的组成逻辑图" class="headerlink" title="1.5 Nginx的组成逻辑图"></a>1.5 Nginx的组成逻辑图</h2><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid6bwqcmj31540lf0w7.jpg" alt="image-20200624200849579"></p>
<h2 id="1-6-Nginx的模块是什么"><a href="#1-6-Nginx的模块是什么" class="headerlink" title="1.6 Nginx的模块是什么"></a>1.6 Nginx的模块是什么</h2><blockquote>
<p>Nginx之所以有如此多的特性和功能，就是因为有大量的第三方开发者为其开发第三方模块</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid6e3pa9j31890emq4k.jpg" alt="image-20200624213430515"></p>
<p>上图中都可以在<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/">nginx官方文档</a>中查询，这里就不再叙述了~~</p>
<h1 id="Nginx应用部署"><a href="#Nginx应用部署" class="headerlink" title="Nginx应用部署"></a>Nginx应用部署</h1><h2 id="1-1-进入-nginx-官网，下载"><a href="#1-1-进入-nginx-官网，下载" class="headerlink" title="1.1 进入 nginx 官网，下载"></a>1.1 进入 nginx 官网，下载</h2><blockquote>
<p><strong>Nginx官方网站：<a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org/</a></strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1grid7c5keqj31bp0u013s.jpg" alt="image-20210615024029525"></p>
<h2 id="1-2-安装Nginx依赖"><a href="#1-2-安装Nginx依赖" class="headerlink" title="1.2 安装Nginx依赖"></a>1.2 安装Nginx依赖</h2><blockquote>
<p><strong>安装 openssl、zlib</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make zlib zlib-devel gcc gcc-c++ libtool openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure>



<h2 id="1-3-安装Nginx并修改属主属祖"><a href="#1-3-安装Nginx并修改属主属祖" class="headerlink" title="1.3 安装Nginx并修改属主属祖"></a>1.3 安装Nginx并修改属主属祖</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar xf nginx-1.12.2.tar.gz -C /usr/src/ &amp;&amp; <span class="built_in">cd</span> /usr/src/nginx-1.12.2/</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置、编译、安装</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module &amp;&amp; make &amp;&amp; make install &amp;&amp; <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改属主属组</span></span><br><span class="line">useradd -s /sbin/nologin -M nginx</span><br><span class="line">chown -R nginx:nginx /usr/<span class="built_in">local</span>/nginx/</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>编译参数解释：</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这三个模块是用来做四层负载转发的</span></span><br><span class="line">--with-stream</span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-stream_realip_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定安装位置</span></span><br><span class="line">--prefix=/usr/<span class="built_in">local</span>/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定worker进程运行的用户和组</span></span><br><span class="line">--user=nginx --group=nginx 		  </span><br><span class="line"></span><br><span class="line"><span class="comment">#开启状态监听模块 </span></span><br><span class="line">--with-http_stub_status_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#指向配置文件存放位置</span></span><br><span class="line">--conf-path=/xxx/xxx/</span><br><span class="line"></span><br><span class="line"><span class="comment">#指向错误日志存放位置</span></span><br><span class="line">--error-log-path=/xxx/xxx/</span><br><span class="line"></span><br><span class="line"><span class="comment">#指向pid文件存放位置 </span></span><br><span class="line">--pid-path=/xxx/xxx/</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用rtsig模块支持（实时信号）</span></span><br><span class="line">--with-rtsig_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时缓存⽂文件</span></span><br><span class="line">--http-client-body-temp-path=/xxx/xxx/client_tem</span><br><span class="line">--http-proxy-temp-path=/xxx/xxx/proxy_temp</span><br><span class="line">--http-fastcgi-temp-path=/xxx/xxx/fastcgi_temp</span><br><span class="line">--http-uwsgi-temp-path=/xxx/xxx/uwsgi_temp</span><br><span class="line">--http-scgi-temp-path=/xxx/xxx/scgi_temp</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加模块</span></span><br><span class="line">--add-module=/xxx/xxx/</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用select模块支持（一种轮询模式,不推荐在高载环境下使用）禁用：--without-select_module</span></span><br><span class="line">--with-select_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用ngx_http_ssl_module支持(使支持https请求，需已安装openssl)</span></span><br><span class="line">--with-http_ssl_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用ngx_http_xslt_module支持（过滤转换XML请求）</span></span><br><span class="line">--with-http_xslt_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用ngx_http_image_filter_module支持（传输JPEG/GIF/PNG 图片的一个过滤器）（默认为不启用，要用到gd库） </span></span><br><span class="line">--with-http_image_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用ngx_http_gzip_static_module支持（在线实时压缩输出数据流）</span></span><br><span class="line">--with-http_gzip_static_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用ngx_http_degradation_module支持（允许在内存不足的情况下返回204或444码）</span></span><br><span class="line">--with-http_degradation_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用ngx_http_access_module支持（该模块提供了一个简单的基于主机的访问控制，允许或拒绝基于ip地址）</span></span><br><span class="line">--without-http_access_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用ngx_http_auth_basic_module（该模块是可以使用用户名和密码基于http基本认证方法，来保护你的站点或其部分内容）</span></span><br><span class="line">--without-http_auth_basic_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用ngx_http_rewrite_module支持（该模块允许使用正则表达式改变URL）</span></span><br><span class="line">--without-http_rewrite_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用ngx_http_fastcgi_module支持（该模块允许Nginx 与FastCGI 进程交互，并通过传递参数来控制FastCGI 进程工作。）</span></span><br><span class="line">--without-http_fastcgi_module</span><br></pre></td></tr></table></figure>



<h2 id="1-4-设置防火墙规则"><a href="#1-4-设置防火墙规则" class="headerlink" title="1.4 设置防火墙规则"></a>1.4 设置防火墙规则</h2><blockquote>
<p><strong>开放80端口号</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">查看开放的端口号</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line">设置开放的端口号</span><br><span class="line">firewall-cmd --add-service=http -permanent</span><br><span class="line">sudo firewall-cmd --add-port=80/tcp -permanent</span><br><span class="line"></span><br><span class="line">重启防火墙</span><br><span class="line">firewall-cmd -reload</span><br></pre></td></tr></table></figure>



<h2 id="1-5-Nginx常用命令-及-信号"><a href="#1-5-Nginx常用命令-及-信号" class="headerlink" title="1.5 Nginx常用命令 及 信号"></a>1.5 Nginx常用命令 及 信号</h2><blockquote>
<p><strong>命令</strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sni7ry5j314f0p94by.jpg" alt="image-20200624203124482"></p>
<blockquote>
<p><strong>信号</strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7so7k5uij31b10pee84.jpg" alt="image-202006242333124482"></p>
<p><strong>信号详解：</strong></p>
<p>1、TERM，INT：nginx的主进程马上被关闭，不能完整处理正在使用的nginx的用户的请求，等同于 nginx -s stop。</p>
<p>2、QUIT：优雅的关闭nginx进程，在处理完所有正在使用nginx用户请求后再关闭nginx进程，等同于nginx -s quit。</p>
<p>3、HUP： nginx主进程不变，nginx进程不关闭，但是重新加载配置文件。等同于nginx -s reload。</p>
<p>4、USR1：不用关闭nginx进程就可以重读日志，此命令可以用于nginx的日志定时备份，按月/日等时间间隔分割有用。</p>
<p>5、USR2：nginx的版本需要升级的时候，不需要停止nginx，就能对nginx升级。</p>
<p>6、WINCH：配合USR2对nginx升级，优雅的关闭nginx旧版本的进程，</p>
<blockquote>
<p>reload重载配置文件的过程</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sod9i5yj319o0qtkjo.jpg" alt="image-20200624211822429"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7soiwo8hj31340hejyb.jpg" alt="image-20200624211822429"></p>
<h2 id="1-6-优化Nginx且编写启动脚本"><a href="#1-6-优化Nginx且编写启动脚本" class="headerlink" title="1.6 优化Nginx且编写启动脚本"></a>1.6 优化Nginx且编写启动脚本</h2><blockquote>
<p><strong>两者做一个就行，当然也可以都做</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx软连接</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nginx/sbin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx启动脚本</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt; /lib/systemd/system/nginx.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=nginx</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="string">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span></span><br><span class="line"><span class="string">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给予启动脚本执行权限</span></span><br><span class="line">chmod u+x /lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上述脚本解释</span></span><br><span class="line">[Unit]:服务的说明</span><br><span class="line">Description:描述服务</span><br><span class="line">After:描述服务类别</span><br><span class="line">[Service]服务运行参数的设置，注意：[Service]的启动、重启、停止命令全部要求使用绝对路径</span><br><span class="line">Type=forking是后台运行的形式</span><br><span class="line">ExecStart为服务的具体运行命令</span><br><span class="line">ExecReload为重启命令</span><br><span class="line">ExecStop为停止命令</span><br><span class="line">PrivateTmp=True表示给服务分配独立的临时空间</span><br><span class="line">[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</span><br></pre></td></tr></table></figure>



<h2 id="1-7-启动Nginx服务"><a href="#1-7-启动Nginx服务" class="headerlink" title="1.7 启动Nginx服务"></a>1.7 启动Nginx服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除nginx.conf配置文件所有的注释行和空行（这步可有可无）</span></span><br><span class="line">sed -i /<span class="comment">#.*/d /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">sed -i /^$/d /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">netstat -anptu|grep <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      4827/nginx: master</span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br><span class="line"></span><br><span class="line">ps -aux|grep <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br><span class="line">root 4827  0.0  0.1  46108  1152 ?  Ss  21:56   0:00 nginx: master process /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line">nginx      4830  0.0  0.1  46556  1936 ?        S    21:56   0:00 nginx: worker process</span><br><span class="line">root       4849  0.0  0.0 112676   980 pts/0    R+   21:57   0:00 grep --color=auto nginx</span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看安装Nginx时的编译参数和版本</span></span><br><span class="line">nginx -V</span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br><span class="line">nginx version: nginx/1.12.2</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/<span class="built_in">local</span>/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"><span class="comment">#####################################################################################################</span></span><br></pre></td></tr></table></figure>





<h1 id="Nginx常用模块及内置变量"><a href="#Nginx常用模块及内置变量" class="headerlink" title="Nginx常用模块及内置变量"></a>Nginx常用模块及内置变量</h1><h2 id="1-1-Nginx常用模块"><a href="#1-1-Nginx常用模块" class="headerlink" title="1.1 Nginx常用模块"></a>1.1 Nginx常用模块</h2><blockquote>
<p><strong>Nginx模块分为 Nginx官方模块 以及 Nginx第三方模块</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>Nginx编译选项</th>
<th>模块作用</th>
</tr>
</thead>
<tbody><tr>
<td>ngx_http_core_module</td>
<td>包含⼀些核心的http参数配置，对应Nginx的配置区块部分</td>
</tr>
<tr>
<td>ngx_http_access_module</td>
<td>访问控制模块，用来控制网站用户对Nginx的访问</td>
</tr>
<tr>
<td>ngx_http_gzip_module</td>
<td>压缩模块，对Nginx返回的数据压缩，属于性能优化模块</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>fastci模块，和动态应用相关的模块，例如PHP</td>
</tr>
<tr>
<td>ngx_http_proxy_module</td>
<td>proxy代理模块</td>
</tr>
<tr>
<td>ngx_http_upstream_module</td>
<td>负载均衡模块，可以实现网站的负载均衡功能及节点的健康检查。</td>
</tr>
<tr>
<td>ngx_http_rewrite_module</td>
<td>URL地址重写模块</td>
</tr>
<tr>
<td>ngx_http_limit_conn_module</td>
<td>限制用户并发连接数及请求数模块</td>
</tr>
<tr>
<td>ngx_http_limit_req_module</td>
<td>限制Nginx request processing rate根据定义的key</td>
</tr>
<tr>
<td>ngx_http_log_module</td>
<td>访问日志模块，以指定的格式记录Nginx客户访问日志等信息</td>
</tr>
<tr>
<td>ngx_http_auth_basic_module</td>
<td>Web认证模块，设置Web用户通过账号密码访问Nginx</td>
</tr>
<tr>
<td>nginx_http_ssl_module</td>
<td>ssl模块，用于加密的http连接，如https</td>
</tr>
</tbody></table>
<h2 id="1-2-Nginx内置变量"><a href="#1-2-Nginx内置变量" class="headerlink" title="1.2 Nginx内置变量"></a>1.2 Nginx内置变量</h2><blockquote>
<p><strong>http请求变量</strong></p>
<p><strong>Nginx内置变量</strong></p>
<p><strong>自定义变量</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>$uri</td>
<td>当前请求的uri，不带参数</td>
</tr>
<tr>
<td>$request_uri</td>
<td>请求的uri，带完整参数</td>
</tr>
<tr>
<td>$host</td>
<td>http请求报文中host首部,如果没有则以处理此请求的虚拟主机的主机名代替</td>
</tr>
<tr>
<td>$hostname</td>
<td>nginx服务运行在主机的主机名</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端IP</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端口</td>
</tr>
<tr>
<td>$remote_user</td>
<td>用户认证时客户端用户输入的用户名</td>
</tr>
<tr>
<td>$request_filename</td>
<td>用户请求中的URI经过本地root或alias转换后映射的本地文件路径</td>
</tr>
<tr>
<td>$request_method</td>
<td>请求方法, GET POST PUT</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器地址</td>
</tr>
<tr>
<td>$server_port</td>
<td>服务器端口</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器名称</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>服务器向客户端发送响应时的协议, 如http/1.1 http/1.0</td>
</tr>
<tr>
<td>$scheme</td>
<td>在请求中使用scheme, 如<a target="_blank" rel="noopener" href="http://xxx.com中的http/">http://xxx.com中的http</a></td>
</tr>
<tr>
<td>$http_HEADER</td>
<td>匹配请求报文中指定的HEADER</td>
</tr>
<tr>
<td>$http_host</td>
<td>匹配请求报文中的host首部</td>
</tr>
<tr>
<td>$document_root</td>
<td>当前请求映射到的root配置</td>
</tr>
</tbody></table>
<h1 id="Nginx-conf-配置文件"><a href="#Nginx-conf-配置文件" class="headerlink" title="Nginx.conf 配置文件"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dongye95/p/11096785.html#_label2_0">Nginx.conf 配置文件</a></h1><h2 id="1-1-Nginx配置文件语法"><a href="#1-1-Nginx配置文件语法" class="headerlink" title="1.1 Nginx配置文件语法"></a>1.1 Nginx配置文件语法</h2><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sop7go5j315y0odas7.jpg" alt="image-20200624202639852"></p>
<h2 id="1-2-配置文件整体结构"><a href="#1-2-配置文件整体结构" class="headerlink" title="1.2 配置文件整体结构"></a>1.2 配置文件整体结构</h2><p><strong>Nginx主配置文件 nginx.conf，整个配置文件是以区块的形式组织的；一般，每个区块以一对大括号 {} 来表示开始与结束。</strong></p>
<blockquote>
<ol>
<li><p>Main位于nginx.conf配置文件的最高层；Main层下可以有Event、HTTP层</p>
</li>
<li><p>HTTP层下面允许有多个Server层, 用于对不同的网站做不同的配置</p>
</li>
<li><p>Server层也允许有多个location, 用于对不同的路径资源进行不同模块的配置</p>
</li>
</ol>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sozuqmoj30pc0fwq3r.jpg" alt="image-20200621230154767"></p>
<h3 id="1-2-1-main全局块"><a href="#1-2-1-main全局块" class="headerlink" title="1.2.1 main全局块"></a>1.2.1 main全局块</h3><p>配置影响nginx全局的指令。主要包括：</p>
<ul>
<li>配置运行Nginx服务器用户（组）</li>
<li>worker process数</li>
<li>Nginx进程</li>
<li>PID存放路径错误日志的存放路径</li>
<li>配置文件的引入</li>
</ul>
<h3 id="1-2-2-events块"><a href="#1-2-2-events块" class="headerlink" title="1.2.2 events块"></a>1.2.2 events块</h3><p>配置影响nginx服务器或与用户的网络连接。主要包括：</p>
<ul>
<li>设置网络连接的序列化</li>
<li>是否允许同时接收多个网络连接</li>
<li>事件驱动模型的选择</li>
<li>最大连接数的配置</li>
</ul>
<h3 id="1-2-3-http块"><a href="#1-2-3-http块" class="headerlink" title="1.2.3 http块"></a>1.2.3 http块</h3><p>可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。主要包括：</p>
<ul>
<li>定义MIMI-Type</li>
<li>自定义服务日志</li>
<li>允许sendfile方式传输文件</li>
<li>连接超时时间</li>
<li>单连接请求数上限</li>
</ul>
<h3 id="1-2-4-server块"><a href="#1-2-4-server块" class="headerlink" title="1.2.4 server块"></a>1.2.4 server块</h3><p>配置虚拟主机的相关参数，一个http中可以有多个server。主要包括：</p>
<ul>
<li>配置网络监听</li>
<li>基于名称的虚拟主机配置</li>
<li>基于IP的虚拟主机配置</li>
</ul>
<h3 id="1-2-5-location块"><a href="#1-2-5-location块" class="headerlink" title="1.2.5 location块"></a>1.2.5 location块</h3><p>配置请求的路由，以及各种页面的处理情况。主要包括：</p>
<ul>
<li>location配置</li>
<li>请求根目录配置更改</li>
<li>location的URI</li>
<li>网站默认首页配置</li>
</ul>
<h2 id="1-3-Nginx的默认配置"><a href="#1-3-Nginx的默认配置" class="headerlink" title="1.3 Nginx的默认配置"></a>1.3 Nginx的默认配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### main全局块 ####</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;                           // nginx的worker工作进程，一般数值为cpu核数</span><br><span class="line"></span><br><span class="line"><span class="comment">#### events事件块 ####</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;                  // 每个后台<span class="attribute">worker</span> process进程的最大并发连接数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#### http块 ####</span></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;                  // 文件扩展名与类型映射表</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;    // 默认文件类型</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;                        // 开启高效传输模式，默认为<span class="attribute">off</span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;                     // 连接超时时间，单位是秒</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#### server块 ####</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;                       // 监听端口</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;                // 提供服务的域名或主机名</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#### location块 ####</span></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;                       // 存放网站路径</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;       // 默认访问首⻚文件</span><br><span class="line">        &#125;</span><br><span class="line">        // 指定错误代码, 统一定义错误页面, 错误代码重定向到新的 Locaiton资源上</span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="Nginx日志文件详解"><a href="#Nginx日志文件详解" class="headerlink" title="Nginx日志文件详解"></a>Nginx日志文件详解</h1><h2 id="1-1-Nginx日志配置"><a href="#1-1-Nginx日志配置" class="headerlink" title="1.1 Nginx日志配置"></a>1.1 Nginx日志配置</h2><blockquote>
<p><strong>在学习日志之前, 我们需要先了解下HTTP请求和返回</strong></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v https://www.baidu.com</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7spblndjj30u10csaek.jpg" alt="image-20200621232120269"></p>
<p><strong>log_format语法格式及参数语法说明如下:</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 配置语法: 包括: error.log access.log ###</span></span><br><span class="line">Syntax: <span class="attribute">log_format</span>  &lt;NAME&gt;  &lt;String&gt;;</span><br><span class="line">Default: <span class="attribute">log_format</span> combined <span class="string">&quot;...&quot;</span>;</span><br><span class="line">Context: <span class="attribute">http</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Nginx默认日志格式 ###</span></span><br><span class="line">log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">### Nginx日志变量解释 ###</span></span><br><span class="line"><span class="attribute">log_format</span></span><br><span class="line">    $remote_addr             <span class="comment">#记录访问网站的客户端地址</span></span><br><span class="line">    $remote_user             <span class="comment">#nginx认证用户名</span></span><br><span class="line">    $time_local              <span class="comment">#记录访问时间与时区</span></span><br><span class="line">    $request                 <span class="comment">#用户的http请求行, GET等方法、http协议版本</span></span><br><span class="line">    $status                  <span class="comment">#http状态码，记录请求返回的状态码，例如：200、301、404等</span></span><br><span class="line">    $body_bytes_sent         <span class="comment">#服务器发送给客户端的响应body字节数大小，默认为B(byte)</span></span><br><span class="line">    $http_referer            <span class="comment">#记录此次请求是从哪个连接访问过来的，可以根据该参数进行防盗链设置。</span></span><br><span class="line">    $http_user_agent         <span class="comment">#记录客户端访问信息，例如：浏览器、手机客户端等</span></span><br><span class="line">    $http_x_forwarded_for    <span class="comment">#当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置</span></span><br></pre></td></tr></table></figure>



<h2 id="1-2访问日志段分析"><a href="#1-2访问日志段分析" class="headerlink" title="1.2访问日志段分析"></a>1.2访问日志段分析</h2><p>摘出来一段部分结果：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">120.4.15.223 - <span class="attribute">lemon</span> [<span class="number">22</span>/Jun/<span class="number">2020</span>:<span class="number">12</span>:<span class="number">01</span>:<span class="number">43</span> +<span class="number">0800</span>] <span class="string">&quot;GET /index.php/archives/56/ HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">4865</span> <span class="string">&quot;http://www.lemon-li.cn/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<p>各个字段所对应的变量</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">192.168.2.254                            //$<span class="attribute">remote_addr</span></span><br><span class="line">lemon                                    //$remote_user</span><br><span class="line">[<span class="number">22</span>/Jun/<span class="number">2020</span>:<span class="number">12</span>:<span class="number">01</span>:<span class="number">43</span> +<span class="number">0800</span>]             //$time_local</span><br><span class="line"><span class="string">&quot;GET /index.php/archives/56/ HTTP/1.1&quot;</span>   //$request</span><br><span class="line"><span class="number">200</span>                                      //$status</span><br><span class="line"><span class="number">4865</span>                                     //$body_bytes_sent</span><br><span class="line"><span class="string">&quot;http://www.lemon-li.cn/&quot;</span>                //$http_referer</span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows xx Firefox/77.0&quot;</span>   //$http_user_agent</span><br><span class="line"><span class="string">&quot;-&quot;</span>                                      //$http_x_forwarded_for</span><br></pre></td></tr></table></figure>



<h2 id="1-3-Nginx访问日志统计"><a href="#1-3-Nginx访问日志统计" class="headerlink" title="1.3 Nginx访问日志统计"></a>1.3 Nginx访问日志统计</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##统计tcp连接数</span></span><br><span class="line">netstat -anpt|awk <span class="string">&#x27;NR&gt;=3&#123;print $6&#125;&#x27;</span>|sort -rn|uniq -c</span><br><span class="line"></span><br><span class="line"><span class="comment">##统计访问日志中访问量最多的10个IP地址, 这下面两个都行</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> /usr/<span class="built_in">local</span>/nginx/logs/access.log | sort | uniq -c | sort -nr -k1 | head -n 10</span><br><span class="line">cat /usr/<span class="built_in">local</span>/nginx/logs/access.log|awk <span class="string">&#x27;&#123;a[$1]++&#125; END &#123;for(b in a) print b&quot;\t&quot;a[b]&#125;&#x27;</span>|sort -k2 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment">##统计HTTP状态码次数</span></span><br><span class="line">awk <span class="string">&#x27;&#123;S[$9]++&#125;;END&#123;for(i in S) &#123;print S[i],i&#125;&#125;&#x27;</span> /usr/<span class="built_in">local</span>/nginx/logs/access.log|sort -nr|head</span><br><span class="line"></span><br><span class="line"><span class="comment">##注解：</span></span><br><span class="line">awk <span class="string">&#x27;&#123; print $1&#125;&#x27;</span>：取数据的低1域（第1列）。</span><br><span class="line">sort：对IP部分进行排序。</span><br><span class="line">uniq -c：打印每一重复行出现的次数。（并去掉重复行）。</span><br><span class="line">sort -nr -k1：按照重复行出现的次序倒序排列，-k1以第一列为标准排序。</span><br><span class="line">head -n 10：取排在前5位的IP 。</span><br></pre></td></tr></table></figure>



<h2 id="1-4-http-access-module局限性"><a href="#1-4-http-access-module局限性" class="headerlink" title="1.4 http_access_module局限性"></a>1.4 http_access_module局限性</h2><blockquote>
<p>下图是没有使用 http_x_forwarded_for 记录真实客户端IP地址以及代理服务器IP</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7spiu5oej30on0bdwgx.jpg" alt="image-20200623102751786"></p>
<blockquote>
<p>下图是使用 http_x_forwarded_for 记录真实客户端IP地址以及代理服务器IP</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7spqmr40j30qr0cn41u.jpg" alt="image-20200623104731498"></p>
<p><strong>解决方式</strong></p>
<ol>
<li><p>采用HTTP头信息控制访问, 代理以及web服务开启 http_x_forwarded_for</p>
</li>
<li><p>结合geo模块作</p>
</li>
<li><p>通过HTTP自动以变量传递</p>
</li>
</ol>
<h1 id="Nginx常用的基本配置"><a href="#Nginx常用的基本配置" class="headerlink" title="Nginx常用的基本配置"></a>Nginx常用的基本配置</h1><h2 id="1-1-Nginx-虚拟主机"><a href="#1-1-Nginx-虚拟主机" class="headerlink" title="1.1 Nginx 虚拟主机"></a>1.1 Nginx 虚拟主机</h2><blockquote>
<p>所谓虚拟主机，在web服务器里就是一个独立的网站 站点，这个站点对应独立的域名(也可能是IP或端口)，具有独立的程序及资源目录，可以独立地对外提供服务供用户访问。</p>
</blockquote>
<h3 id="1-1-1-配置基于域名虚拟主机（最常用的）"><a href="#1-1-1-配置基于域名虚拟主机（最常用的）" class="headerlink" title="1.1.1 配置基于域名虚拟主机（最常用的）"></a>1.1.1 配置基于域名虚拟主机（最常用的）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1.创建web站点⽬目录</span><br><span class="line">[root@<span class="attribute">nginx</span> conf]<span class="comment"># mkdir -p /soft/code/&#123;www,bbs&#125;</span></span><br><span class="line">[root@nginx conf]<span class="comment"># echo &quot;www&quot; &gt; /soft/code/www/index.html</span></span><br><span class="line">[root@nginx conf]<span class="comment"># echo &quot;bbs&quot; &gt; /soft/code/bbs/index.html</span></span><br><span class="line">[root@nginx conf]<span class="comment"># tree /soft/</span></span><br><span class="line">/soft/</span><br><span class="line">└── code</span><br><span class="line">    ├── bbs</span><br><span class="line">    │   └── index.html</span><br><span class="line">    └── www</span><br><span class="line">        └── index.html</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.配置虚拟主机</span><br><span class="line">[root@nginx conf]<span class="comment"># cat vhosts/&#123;www,bbs&#125;.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.lemon-li.cn;</span><br><span class="line">    <span class="attribute">root</span> /soft/code/www;</span><br><span class="line">    <span class="attribute">index</span>    index.html;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> bbs.lemon-li.cn;</span><br><span class="line">    <span class="attribute">root</span> /soft/code/bbs;</span><br><span class="line">    <span class="attribute">index</span>    index.html;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3.访问</span><br><span class="line">[root@<span class="attribute">nginx</span> conf]<span class="comment"># curl www.lemon-li.cn</span></span><br><span class="line">www</span><br><span class="line"></span><br><span class="line">[root@nginx conf]<span class="comment"># curl bbs.lemon-li.cn</span></span><br><span class="line">bbs</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-配置不同端口访问不同虚拟主机"><a href="#1-1-2-配置不同端口访问不同虚拟主机" class="headerlink" title="1.1.2 配置不同端口访问不同虚拟主机"></a>1.1.2 配置不同端口访问不同虚拟主机</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 仅修改 <span class="attribute">listen</span> 监听端口即可 , 但不能和系统端口发生冲突!</span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8001</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8002</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-3-配置虚拟主机别名"><a href="#1-1-3-配置虚拟主机别名" class="headerlink" title="1.1.3 配置虚拟主机别名"></a>1.1.3 配置虚拟主机别名</h3><blockquote>
<p>所谓虚拟主机别名，就是虚拟主机设置除了主域名以外的一个域名，实现用户访问的多个域名对应同一个虚拟主机网站的功能</p>
<p>这里以bbs.lemon-li.cn域名的虚拟主机为例，为其增加一个别名lemon.com时，出现网站内容和访问bbs.lemon-li.cn是一样的</p>
<p>具体配置如下：</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 默认配置</span><br><span class="line">[root@<span class="attribute">nginx</span> conf]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> bbs.lemon-li.cn;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 别名配置</span><br><span class="line">[root@<span class="attribute">nginx</span> conf]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> bbs.lemon-li.cn lemon-li-cn;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用 <span class="attribute">Linux</span> 下 curl 测试结果</span><br><span class="line">[root@nginx conf]<span class="comment"># curl lemon-li.cn</span></span><br><span class="line">bbs.lemon-li.cn</span><br><span class="line"></span><br><span class="line">[root@nginx conf]<span class="comment"># curl bbs.lemon-li.cn</span></span><br><span class="line">bbs.lemon-li.cn</span><br><span class="line"></span><br><span class="line">// 访问带 bbs 和不带 bbs 是一样的, 当然除了别名实现也可以通过 rewrite 实现</span><br></pre></td></tr></table></figure>



<h2 id="1-2-Nginx-状态监控"><a href="#1-2-Nginx-状态监控" class="headerlink" title="1.2 Nginx 状态监控"></a>1.2 Nginx 状态监控</h2><blockquote>
<p>–with-http_stub_status_module             记录 Nginx 客户端基本访问状态信息</p>
</blockquote>
<p><strong>默认用法：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: stub_status;</span><br><span class="line">Default: <span class="attribute">off</span></span><br><span class="line">Context: server, location</span><br></pre></td></tr></table></figure>

<p><strong>具体配置：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /status &#123;</span><br><span class="line">	<span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>提供了以下状态信息：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 1</span><br><span class="line"><span class="comment">## Nginx 当前活跃连接数, 有多少人在请求</span></span><br><span class="line"></span><br><span class="line">server accepts handled requests</span><br><span class="line"> 1 1 1</span><br><span class="line"><span class="comment">## server表示Nginx处理接收握⼿总次数。</span></span><br><span class="line"><span class="comment">## accepts表示Nginx处理接收总连接数。</span></span><br><span class="line"><span class="comment">## 请求丢失数=(握⼿数-连接数)可以看出,本次状态显示没有丢失请求。</span></span><br><span class="line"><span class="comment">## handled requests，表示总共处理了了1次请求。</span></span><br><span class="line"></span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br><span class="line"><span class="comment">## Reading表示Nginx读取数据</span></span><br><span class="line"><span class="comment">## Writing表示Nginx写的情况</span></span><br><span class="line"><span class="comment">## Waiting表示Nginx开启keep-alive长连接情况下, 既没有读也没有写, 建立连接情况</span></span><br></pre></td></tr></table></figure>

<p><strong>使用ab命令测试压力</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ab -c 10 -n 100 http://192.168.2.1:80/index.html</span><br><span class="line">-c  并发数</span><br><span class="line">-n  总的请求数</span><br><span class="line">-k  是否开启长连接</span><br></pre></td></tr></table></figure>

<p><strong>访问查看</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7spyv97xj30to05mglw.jpg" alt="image-20200622162405702"></p>
<h2 id="1-3-Nginx下载站点"><a href="#1-3-Nginx下载站点" class="headerlink" title="1.3 Nginx下载站点"></a>1.3 Nginx下载站点</h2><blockquote>
<p>Nginx默认是不允许列出整个目录浏览下载的 !</p>
</blockquote>
<p><strong>默认用法：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">autoindex</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default: off;</span><br><span class="line">Context: http, server, <span class="attribute">location</span></span><br><span class="line"></span><br><span class="line">//autoindex常⽤用参数</span><br><span class="line">autoindex_exact_size <span class="literal">off</span>;</span><br><span class="line">默认为on， 显示出文件的确切大小，单位是bytes。</span><br><span class="line">修改为off，显示出文件的大概大小，单位是kB或者MB或者GB。</span><br><span class="line"></span><br><span class="line"><span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line">默认为off，显示的文件时间为GMT时间。</span><br><span class="line">修改为on， 显示的文件时间为文件的服务器时间。</span><br><span class="line"></span><br><span class="line"><span class="attribute">charset</span> utf-<span class="number">8</span>,gbk;</span><br><span class="line">默认中文目录乱码，添加上解决乱码。</span><br></pre></td></tr></table></figure>

<p><strong>具体配置：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//开启目录浏览</span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>  /download;</span><br><span class="line">    <span class="attribute">autoindex</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>,gbk;</span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建站点资源</span><br><span class="line">[root@<span class="attribute">nginx</span> /]<span class="comment"># mkdir -p /download</span></span><br><span class="line">[root@nginx /]<span class="comment"># cd download/</span></span><br><span class="line">[root@nginx download]<span class="comment"># touch lemon&#123;1..20&#125;.txt</span></span><br></pre></td></tr></table></figure>

<p><strong>展示效果：</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sq2htlfj30ww0jjtb8.jpg" alt="image-20200624125401798"></p>
<h2 id="1-4-Nginx-访问控制"><a href="#1-4-Nginx-访问控制" class="headerlink" title="1.4 Nginx 访问控制"></a>1.4 Nginx 访问控制</h2><blockquote>
<p><strong>基于IP的访问控制 http_access_module</strong></p>
<p><strong>基于⽤用户登陆认证 http_auth_basic_module</strong></p>
</blockquote>
<h3 id="1-4-1-基于IP的访问控制"><a href="#1-4-1-基于IP的访问控制" class="headerlink" title="1.4.1 基于IP的访问控制"></a>1.4.1 基于IP的访问控制</h3><p><strong>语法格式如下：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 允许配置语法</span><br><span class="line">Syntax: <span class="attribute">allow</span> address | CIDR | unix: | all;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location, <span class="attribute">limit_except</span></span><br><span class="line"></span><br><span class="line">// 拒绝配置语法</span><br><span class="line">Syntax: deny address | CIDR | unix: | all;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location, limit_except</span><br></pre></td></tr></table></figure>

<p><strong>具体配置如下：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 配置拒绝某一个 IP, 其他全部允许</span><br><span class="line"><span class="attribute">location</span> /status &#123;</span><br><span class="line">    <span class="attribute">deny</span> <span class="number">192.168.2.254</span>;</span><br><span class="line">    <span class="attribute">allow</span> all;</span><br><span class="line">    <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 只允许某一个网段访问 , 其它全部拒绝</span><br><span class="line"><span class="attribute">location</span> /status &#123;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">192.168.2.0</span>/<span class="number">24</span>;</span><br><span class="line">    <span class="attribute">deny</span> all;</span><br><span class="line">    <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-2-基于用户登陆认证"><a href="#1-4-2-基于用户登陆认证" class="headerlink" title="1.4.2 基于用户登陆认证"></a>1.4.2 基于用户登陆认证</h3><p><strong>语法格式如下：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 配置语法</span><br><span class="line">Syntax:  <span class="attribute">auth_basic</span> string | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">auth_basic</span> <span class="literal">off</span>;</span><br><span class="line">Context: http, server, location, <span class="attribute">limit_except</span></span><br><span class="line"></span><br><span class="line">// ⽤户密码记录配置文件</span><br><span class="line">Syntax:  auth_basic_user_file file;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location, limit_except</span><br></pre></td></tr></table></figure>

<p><strong>具体配置如下：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 需要安装依赖组件</span><br><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># yum install httpd-tools</span></span><br><span class="line">[root@nginx ~]<span class="comment"># htpasswd -c /usr/local/nginx/conf/user.conf lemon</span></span><br><span class="line">[root@nginx ~]<span class="comment"># cat /usr/local/nginx/conf/user.conf</span></span><br><span class="line">lemon:$apr1$TLvI5fjG$vOFaI7v3AxSFD/M/NO3TP/</span><br><span class="line"></span><br><span class="line">// 可在 http,server,location 里添加如下信息</span><br><span class="line">auth_basic <span class="string">&quot;Auth access Blog Input your Passwd!&quot;</span>;</span><br><span class="line"><span class="attribute">auth_basic_user_file</span> /usr/local/nginx/conf/user.conf;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-3-上面两者也可以一起用"><a href="#1-4-3-上面两者也可以一起用" class="headerlink" title="1.4.3 上面两者也可以一起用"></a>1.4.3 上面两者也可以一起用</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//想对哪个网页进行加密就在哪个里面加入以下配置：</span><br><span class="line"><span class="attribute">auth_basic</span> <span class="string">&quot;Auth access Blog Input your Passwd!&quot;</span>;</span><br><span class="line"><span class="attribute">auth_basic_user_file</span> /usr/local/nginx/conf/user.conf;</span><br><span class="line"><span class="attribute">allow</span> <span class="number">192.168.2.254</span>;</span><br><span class="line"><span class="attribute">deny</span> all;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-Nginx-访问限制"><a href="#1-5-Nginx-访问限制" class="headerlink" title="1.5 Nginx 访问限制"></a>1.5 Nginx 访问限制</h2><h3 id="1-5-1-http协议的连接与请求"><a href="#1-5-1-http协议的连接与请求" class="headerlink" title="1.5.1 http协议的连接与请求"></a>1.5.1 http协议的连接与请求</h3><blockquote>
<p>HTTP是建立在TCP,  在完成HTTP请求需要先建立TCP三次握手（称为TCP连接），在连接的基础上在HTTP请求。</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sq6u6r6j30tu0ea3zu.jpg" alt="image-20200622000823214"></p>
<h3 id="1-5-2-HTTP-协议的连接与请求"><a href="#1-5-2-HTTP-协议的连接与请求" class="headerlink" title="1.5.2 HTTP 协议的连接与请求"></a>1.5.2 HTTP 协议的连接与请求</h3><ul>
<li><p>HTTP 请求建立在一次 TCP 连接基础上</p>
</li>
<li><p>一次 TCP 请求至少产生一次 HTTP 请求</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>HTTP协议版本</th>
<th>连接关系</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP1.0</td>
<td>TCP不能复用</td>
</tr>
<tr>
<td>HTTP1.1</td>
<td>顺序性TCP复用</td>
</tr>
<tr>
<td>HTTP2.0</td>
<td>多路复用TCP复用</td>
</tr>
</tbody></table>
<h3 id="1-5-3-Nginx-连接限制"><a href="#1-5-3-Nginx-连接限制" class="headerlink" title="1.5.3 Nginx 连接限制"></a>1.5.3 Nginx 连接限制</h3><blockquote>
<p><strong>连接频率限制  limit_conn_module</strong></p>
</blockquote>
<p><strong>连接限制语法：</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sv34f1oj61hc0sinph02.jpg" alt="image-20200622000823214"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7svbstuxj313z0l44qs.jpg" alt="image-20200624225455880"></p>
<p><strong>具体配置如下 :</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    //<span class="attribute">http</span> 段配置连接限制 , 同一时刻只允许一个客户端 IP 连接</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=conn_zone:<span class="number">10m</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            // 限制向客户端返回的速度，每秒钟速率50字节，这个配置仅仅只是为了能看到效果</span><br><span class="line">            <span class="attribute">limit_rate</span> <span class="number">50</span>;</span><br><span class="line">        	// 同一时刻只允许一个客户端 <span class="attribute">IP</span> 连接</span><br><span class="line">            limit_conn conn_zone <span class="number">1</span>;</span><br><span class="line">            // 修改限制发生时向客户端返回的错误码，可做可不做</span><br><span class="line">            <span class="attribute">limit_conn_status</span> <span class="number">500</span>;</span><br><span class="line">            // 修改限制发生时的日志级别，可做可不做</span><br><span class="line">            <span class="attribute">limit_conn_log_level</span> <span class="literal">warn</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>打开两个终端同时请求</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ttk.lemon-li.cn/</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7svgvf0tj30t80820t3.jpg" alt="image-20200624231652524"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7svmwy6hj30pu03d74x.jpg" alt="image-20200624231848233"></p>
<h3 id="1-5-4-Nginx-请求限制"><a href="#1-5-4-Nginx-请求限制" class="headerlink" title="1.5.4 Nginx 请求限制"></a>1.5.4 Nginx 请求限制</h3><blockquote>
<p>请求频率限制 limit_req_module</p>
</blockquote>
<p><strong>请求限制语法：</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7svvyiutj31aj0sdu10.jpg" alt="image-20200624231848233"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sw0ycd2j61au0rfqv802.jpg" alt="image-20200624231848233"></p>
<p><strong>具体配置如下：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    //<span class="attribute">http</span> 段配置请求限制, rate 限制速率，限制一秒钟最多一个 IP 请求</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=req_zone:<span class="number">10m</span> rate=1r/s;</span><br><span class="line">    ...</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">		...</span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">// 1r/<span class="attribute">s</span> 内只接收一个请求, 剩下的将被延迟处理, 请求数超过 burst 定义的数量, 多余请求拒绝处理并返回<span class="number">503</span>错误码给客户端</span><br><span class="line">            limit_req zone=req_zone burst=<span class="number">3</span> nodelay;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ab压力测试：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ab -c 10 -n 100 http://192.168.2.1:80/index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Benchmarking ttk.lemon-li.cn (be patient).....<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx</span><br><span class="line">Server Hostname:        ttk.lemon-li.cn</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        25 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      20</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   0.033 seconds</span><br><span class="line">Complete requests:      50</span><br><span class="line">Failed requests:        46         <span class="comment"># 可以看到这里，失败了46次，也就是说50次请求只成功了4次，也就是1 + 3 = 4</span></span><br><span class="line">   (Connect: 0, Receive: 0, Length: 46, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Non-2xx responses:      46</span><br><span class="line">Total transferred:      18062 bytes</span><br><span class="line">HTML transferred:       9576 bytes</span><br><span class="line">Requests per second:    1503.17 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       13.305 [ms] (mean)</span><br><span class="line">Time per request:       0.665 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          530.28 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        3    4   0.6      4       5</span><br><span class="line">Processing:     3    4   0.6      4       5</span><br><span class="line">Waiting:        3    4   0.6      4       5</span><br><span class="line">Total:          6    8   1.1      8      10</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      8</span><br><span class="line">  66%      8</span><br><span class="line">  75%      9</span><br><span class="line">  80%      9</span><br><span class="line">  90%      9</span><br><span class="line">  95%      9</span><br><span class="line">  98%     10</span><br><span class="line">  99%     10</span><br><span class="line"> 100%     10 (longest request)</span><br></pre></td></tr></table></figure>

<p><strong>使用浏览器测试狂点刷新5次就会报503</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sw5uzz7g310c0c7gm9.gif" alt="image-20200621205106691"></p>
<p><strong>查看错误日志信息</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020/06/24 16:27:04 [error] 960<span class="comment">#0: *1903 limiting requests, excess: 3.486 by zone &quot;req_zone&quot;, client: 101.200.227.38, server: ttk.lemon-li.cn, request: &quot;GET / HTTP/1.0&quot;, host: &quot;ttk.lemon-li.cn&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-5-整体总结"><a href="#1-5-5-整体总结" class="headerlink" title="1.5.5 整体总结"></a>1.5.5 整体总结</h3><blockquote>
<p><strong>连接限制 没有 请求限制有效?</strong></p>
</blockquote>
<ul>
<li><p>前面说过, 多个请求可以建立在一次的TCP连接之上,  那么我们对请求的精度限制，当然比对一个连接的限制会更加的有效。</p>
</li>
<li><p>因为同一时刻只允许一个连接请求进入。</p>
</li>
<li><p>但是同一时刻多个请求可以通过一个连接进入。</p>
</li>
<li><p>所以请求限制才是比较合理的限制解决方案。</p>
</li>
</ul>
<h2 id="1-6-Nginx日志分割"><a href="#1-6-Nginx日志分割" class="headerlink" title="1.6 Nginx日志分割"></a>1.6 Nginx日志分割</h2><blockquote>
<p><strong>技术要点：</strong></p>
<ol>
<li><p>剪切日志后，使用 kill -USR1 发送信号重新生成日志文件，同时还不影响网站请求处理进程。</p>
</li>
<li><p>错误时通过echo和tee -a命令将错误显示的同时写入到日志文件/var/log/messages。</p>
</li>
</ol>
</blockquote>
<h3 id="1-6-1-手动日志分割"><a href="#1-6-1-手动日志分割" class="headerlink" title="1.6.1 手动日志分割"></a>1.6.1 手动日志分割</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 查看nginx日志文件</span><br><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># ll -h /usr/local/nginx/logs/</span></span><br><span class="line">总用量 <span class="number">60K</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">52K</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">41</span> access.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">478</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">39</span> <span class="literal">error</span>.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">4</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">33</span> nginx.pid</span><br><span class="line"></span><br><span class="line">// 先备份日志文件</span><br><span class="line">[root@nginx logs]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/nginx/logs</span><br><span class="line">[root@nginx logs]<span class="comment"># cp access.log access.log.bak</span></span><br><span class="line">[root@nginx logs]<span class="comment"># ll -h</span></span><br><span class="line">总用量 <span class="number">60K</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> nginx root <span class="number">52K</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">51</span> access.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root  root <span class="number">52K</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">41</span> access.log.bak</span><br><span class="line">-rw-r--r-- <span class="number">1</span> nginx root <span class="number">829</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">52</span> <span class="literal">error</span>.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root  root   <span class="number">4</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">33</span> nginx.pid</span><br><span class="line"></span><br><span class="line">// 手动执行日志切割命令 或 发送信号</span><br><span class="line">[root@nginx logs]<span class="comment"># nginx -s reopen</span></span><br><span class="line">[root@nginx logs]<span class="comment"># ll -h</span></span><br><span class="line">总用量 <span class="number">60K</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> nginx root   <span class="number">0</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">51</span> access.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root  root <span class="number">52K</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">41</span> access.log.bak</span><br><span class="line">-rw-r--r-- <span class="number">1</span> nginx root <span class="number">829</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">52</span> <span class="literal">error</span>.log</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root  root   <span class="number">4</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">00</span>:<span class="number">33</span> nginx.pid</span><br></pre></td></tr></table></figure>

<h3 id="1-6-2-自动日志分割"><a href="#1-6-2-自动日志分割" class="headerlink" title="1.6.2 自动日志分割"></a>1.6.2 自动日志分割</h3><blockquote>
<p><strong>就是写一个脚本，然后放到计划任务当中按时间自动切割日志</strong></p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 编写日志切割脚本</span><br><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># vi /root/cut_nginx_log.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">datetime=$(date -d <span class="string">&quot;-1 day&quot;</span> <span class="string">&quot;+%Y%m%d&quot;</span>)</span><br><span class="line">log_path=<span class="string">&quot;/usr/local/nginx/logs&quot;</span></span><br><span class="line">pid_path=<span class="string">&quot;/usr/local/nginx/logs/nginx.pid&quot;</span></span><br><span class="line">mkdir -p $log_path/backup</span><br><span class="line">if [ -f $pid_path ];<span class="attribute">then</span></span><br><span class="line">    mv $log_path/access.log $log_path/backup/access.log-$datetime</span><br><span class="line">    kill -USR1 $(cat $pid_path)  <span class="comment">#USR1通常被用来告知应用程序重载配置文件</span></span><br><span class="line">    find $log_path/backup -mtime +<span class="number">30</span> | xargs rm -f</span><br><span class="line">else</span><br><span class="line">    echo <span class="string">&quot;Error,Nginx is not working!&quot;</span>  &gt;&gt; /var/log/messages</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">// 给予脚本执行权限</span><br><span class="line">[root@nginx ~]<span class="comment"># chmod +x /root/cut_nginx_log.sh</span></span><br><span class="line"></span><br><span class="line">//添加至计划任务，每天的<span class="number">00</span>:<span class="number">00</span>点执行</span><br><span class="line">[root@nginx ~]<span class="comment"># echo &quot;0 0 * * * /root/cut_nginx_log.sh&quot; &gt;&gt; /var/spool/cron/root</span></span><br><span class="line">[root@nginx ~]<span class="comment"># crontab –l</span></span><br><span class="line"></span><br><span class="line">//手动执行一下这个脚本验证下效果</span><br><span class="line">[root@nginx ~]<span class="comment"># bash -x /root/cut_nginx_log.sh</span></span><br><span class="line">++ date -d <span class="string">&#x27;-1 day&#x27;</span> +%Y%m%d</span><br><span class="line">+ datetime=<span class="number">20200624</span></span><br><span class="line">+ log_path=/usr/local/nginx/logs</span><br><span class="line">+ pid_path=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">+ mkdir -p /usr/local/nginx/logs/backup</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -f /usr/local/nginx/logs/nginx.pid <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ mv /usr/local/nginx/logs/access.log /usr/local/nginx/logs/backup/access.log-<span class="number">20200624</span></span><br><span class="line">++ cat /usr/local/nginx/logs/nginx.pid</span><br><span class="line">+ kill -USR1 <span class="number">968</span></span><br><span class="line">+ find /usr/local/nginx/logs/backup -mtime +<span class="number">30</span></span><br><span class="line">+ xargs rm -f</span><br><span class="line"></span><br><span class="line">// 查看日志是否被切割及备份</span><br><span class="line">[root@nginx ~]<span class="comment"># ls /usr/local/nginx/logs/backup/</span></span><br><span class="line">access.log-<span class="number">20200624</span></span><br></pre></td></tr></table></figure>

<h2 id="1-7-Nginx平滑升级部署"><a href="#1-7-Nginx平滑升级部署" class="headerlink" title="1.7 Nginx平滑升级部署"></a>1.7 Nginx平滑升级部署</h2><blockquote>
<ul>
<li><strong>作用：在不影响客户端业务的情况下升级Nginx服务</strong></li>
<li><strong>切记，这里一定要使用绝对路径启动Nginx，才能够作热升级</strong></li>
</ul>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7swahpqrj31610qp4gv.jpg" alt="image-20200624212307459"></p>
<p><strong>Nginx信号详解：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.TERM，INT：nginx的主进程马上被关闭，不能完整处理正在使用的nginx的用户的请求，等同于 <span class="attribute">nginx</span> -s stop。</span><br><span class="line"><span class="number">2</span>.QUIT：优雅的关闭nginx进程，在处理完所有正在使用nginx用户请求后再关闭nginx进程，等同于nginx -s quit。</span><br><span class="line"><span class="number">3</span>.HUP： nginx主进程不变，nginx进程不关闭，但是重新加载配置文件。等同于nginx -s reload。</span><br><span class="line"><span class="number">4</span>.USR1：不用关闭nginx进程就可以重读日志，此命令可以用于nginx的日志定时备份，按月/日等时间间隔分割有用。</span><br><span class="line"><span class="number">5</span>.USR2：nginx的版本需要升级的时候，不需要停止nginx，就能对nginx升级。</span><br><span class="line"><span class="number">6</span>.WINCH：配合USR2对nginx升级，优雅的关闭nginx旧版本的进程</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7swidxvcj319a0e97bj.jpg" alt="image-20200624212511817"></p>
<blockquote>
<p><strong>具体操作如下：</strong></p>
<ul>
<li>当前版本为：nginx-1.12.2</li>
<li>升级版本为：nginx-1.16.1</li>
</ul>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">// 查看旧的nginx都编译了什么模块，一会编译新版本时就照着加就行了</span><br><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1</span>.<span class="number">12</span>.<span class="number">2</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span>-<span class="number">39</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1</span>.<span class="number">0</span>.<span class="number">2k</span>-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">// 查看旧版本nginx的后台进程PID，一会升级nginx时会用到</span><br><span class="line">[root@nginx ~]<span class="comment"># ps -aux|grep nginx</span></span><br><span class="line">root  <span class="number">2241</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56316</span>  <span class="number">1156</span> ?  Ss  <span class="number">01</span>:<span class="number">53</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx <span class="number">2242</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56700</span>  <span class="number">1932</span> ?  S   <span class="number">01</span>:<span class="number">53</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line"></span><br><span class="line">// 备份旧nginx的二进制命令文件</span><br><span class="line">[root@nginx ~]<span class="comment"># cp -r /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span></span><br><span class="line">[root@nginx ~]<span class="comment"># ll /usr/local/nginx/sbin/</span></span><br><span class="line">总用量 <span class="number">14888</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> nginx nginx <span class="number">7621776</span> <span class="number">6</span>月  <span class="number">21</span> <span class="number">21</span>:<span class="number">53</span> nginx</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root  root  <span class="number">7621776</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">02</span>:<span class="number">01</span> nginx.old</span><br><span class="line"></span><br><span class="line">// 准备nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>源码包</span><br><span class="line">[root@nginx ~]<span class="comment"># wget http://nginx.org/download/nginx-1.16.1.tar.gz</span></span><br><span class="line"></span><br><span class="line">// 解压、配置、编译nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>源码包。注：<span class="comment">#不能加make install，如若添加，则覆盖了!</span></span><br><span class="line">[root@nginx ~]<span class="comment"># tar xf nginx-1.16.1.tar.gz  -C /usr/src/</span></span><br><span class="line">[root@nginx ~]<span class="comment"># cd /usr/src/nginx-1.16.1/</span></span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module &amp;&amp; make</span></span><br><span class="line"></span><br><span class="line">// 进入编译好的objs目录中将编译好的nginx1.<span class="number">16</span>.<span class="number">1</span>的二进制命令文件拷贝至对应位置</span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># cd objs/ &amp;&amp; ll</span></span><br><span class="line">总用量 <span class="number">7976</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">18617</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> autoconf.err</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">56144</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> Makefile</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root <span class="number">7961952</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">56</span> nginx</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root    <span class="number">5341</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">56</span> nginx.<span class="number">8</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root    <span class="number">7651</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> ngx_auto_config.h</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root     <span class="number">657</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> ngx_auto_headers.h</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root    <span class="number">9435</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> ngx_modules.c</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">93664</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">56</span> ngx_modules.o</span><br><span class="line">drwxr-xr-x <span class="number">9</span> root root      <span class="number">91</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">01</span>:<span class="number">55</span> src</span><br><span class="line">[root@nginx objs]<span class="comment"># cp -rf nginx /usr/local/nginx/sbin/</span></span><br><span class="line">cp：是否覆盖<span class="string">&quot;/usr/local/nginx/sbin/nginx&quot;</span>？ y</span><br><span class="line">[root@nginx objs]<span class="comment"># ll /usr/local/nginx/sbin/</span></span><br><span class="line">总用量 <span class="number">15220</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root <span class="number">7961952</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">02</span>:<span class="number">04</span> nginx</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root <span class="number">7621776</span> <span class="number">6</span>月  <span class="number">25</span> <span class="number">02</span>:<span class="number">01</span> nginx.old</span><br><span class="line"></span><br><span class="line">// 开始使用信号实现热升级nginx</span><br><span class="line"><span class="comment">## 发送 USR2 信号，向主进程（ master）发送 USR2 信号，Nginx 会启动一个新版本的 master 进程和对应工作进程，和旧版一起处理请求。</span></span><br><span class="line">[root@nginx objs]<span class="comment"># kill -USR2 2241</span></span><br><span class="line">[root@nginx objs]<span class="comment"># ps -aux|grep nginx</span></span><br><span class="line">root  <span class="number">2241</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56316</span>  <span class="number">1340</span> ?  Ss  <span class="number">01</span>:<span class="number">53</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx <span class="number">2242</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56700</span>  <span class="number">1932</span> ?  S   <span class="number">01</span>:<span class="number">53</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process     <span class="comment">#老版本进程</span></span><br><span class="line">root  <span class="number">5361</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">3</span>  <span class="number">56348</span>  <span class="number">3336</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx <span class="number">5362</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56744</span>  <span class="number">1928</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process     <span class="comment">#新版本进程</span></span><br><span class="line"></span><br><span class="line">[root@nginx objs]<span class="comment"># kill -WINCH 2242      # 关闭老版本进程的worker进程</span></span><br><span class="line">[root@nginx objs]<span class="comment"># ps -aux|grep nginx</span></span><br><span class="line">root  <span class="number">2241</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56316</span>  <span class="number">1340</span> ?  Ss  <span class="number">01</span>:<span class="number">53</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">root  <span class="number">5361</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">3</span>  <span class="number">56348</span>  <span class="number">3336</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx <span class="number">5362</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56744</span>  <span class="number">1928</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">nginx <span class="number">5366</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56700</span>  <span class="number">1928</span> ?  S   <span class="number">02</span>:<span class="number">10</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process  <span class="comment">#这是关掉老版本woker之后新生成的woker进程</span></span><br><span class="line"></span><br><span class="line">[root@nginx objs]<span class="comment"># kill -QUIT 2241      # 关闭老版本进程的master进程</span></span><br><span class="line">[root@nginx objs]<span class="comment"># ps -aux|grep nginx</span></span><br><span class="line">root  <span class="number">5361</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">3</span>  <span class="number">56348</span>  <span class="number">3336</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line">nginx <span class="number">5362</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>  <span class="number">56744</span>  <span class="number">1928</span> ?  S   <span class="number">02</span>:<span class="number">07</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line"></span><br><span class="line">[root@nginx objs]<span class="comment"># nginx -V             # 至此，nginx就算是热升级成功了</span></span><br><span class="line">nginx version: nginx/<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span>-<span class="number">39</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1</span>.<span class="number">0</span>.<span class="number">2k</span>-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br></pre></td></tr></table></figure>

<h2 id="1-8-index-和-autoindex的区别"><a href="#1-8-index-和-autoindex的区别" class="headerlink" title="1.8 index 和 autoindex的区别"></a>1.8 index 和 autoindex的区别</h2><blockquote>
<p><strong>index模块</strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7swmxm9gj316f0qj4qs.jpg" alt="image-20200624212307459"></p>
<blockquote>
<p><strong>autoindex模块</strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7swuhc5wj61a80pue8402.jpg" alt="image-20200624212307459"></p>
<p><strong>autoindex 主要有下面四个指令：</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sx06ldjj30tn0lv7wj.jpg" alt="image-20200625013255522"></p>
<h2 id="1-9-root-和-alias-的区别（重点）"><a href="#1-9-root-和-alias-的区别（重点）" class="headerlink" title="1.9 root 和 alias 的区别（重点）"></a>1.9 root 和 alias 的区别（重点）</h2><blockquote>
<p><strong>root属性指定的值是要加入到最终路径的，所以访问的位置变成了 root的值/locaiton的值。而我不想把访问的URI加入到路径中。所以就需要使用alias属性，其会抛弃URI，直接访问alias指定的位置</strong></p>
</blockquote>
<h3 id="1-9-1-root属性"><a href="#1-9-1-root属性" class="headerlink" title="1.9.1 root属性"></a>1.9.1 root属性</h3><blockquote>
<p><strong>结论： root属性，会把root的值（这里是yyy）加入到访问路径（locaition）之前</strong></p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> xxx &#123;</span><br><span class="line">    <span class="attribute">root</span> yyy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/aaa.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/aaa.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/xxx/aaa.html">http://URL/yyy/xxx/aaa.html</a></p>
<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/xxx/abc.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/xxx/abc.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/xxx/abc.html">http://URL/yyy/xxx/abc.html</a></p>
<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/xxx/ccc/abc.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/xxx/ccc/abc.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/xxx/ccc/abc.html">http://URL/yyy/xxx/ccc/abc.html</a></p>
<h3 id="1-9-2-alias属性（别名）"><a href="#1-9-2-alias属性（别名）" class="headerlink" title="1.9.2 alias属性（别名）"></a>1.9.2 alias属性（别名）</h3><blockquote>
<p><strong>结论：alias属性，会把alias的值（这里是yyy）替代访问路径匹配的部分（这里是xxx）</strong></p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">locaiton</span> xxx &#123;</span><br><span class="line">    <span class="comment"># alias必须以 / 结束，否则无效!!!</span></span><br><span class="line">    <span class="attribute">alias</span> /yyy/; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/xxx.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/xxx.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/xxx.html">http://URL/yyy/xxx.html</a></p>
<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/xxx/abc.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/xxx/abc.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/abc.html">http://URL/yyy/abc.html</a></p>
<p>浏览器访问 <a target="_blank" rel="noopener" href="http://url/xxx/ccc/abc.html%EF%BC%8C%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AF">http://URL/xxx/ccc/abc.html，实际访问的是</a>  <a target="_blank" rel="noopener" href="http://url/yyy/ccc/abc.html">http://URL/yyy/ccc/abc.html</a></p>
<h2 id="1-10-定义错误页面"><a href="#1-10-定义错误页面" class="headerlink" title="1.10 定义错误页面"></a>1.10 定义错误页面</h2><blockquote>
<p><strong>模块：</strong>error_page，作用是根据客户端的访问网站的返回状态码，为其指定到特定的错误页面</p>
</blockquote>
<p>语法：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page <span class="keyword">code</span> [ <span class="keyword">code</span>... ] [ = | =answer-<span class="keyword">code</span> ] uri | @named_location </span><br></pre></td></tr></table></figure>

<p><strong>简单示例：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 编写错误页面</span><br><span class="line"><span class="attribute">echo</span> <span class="string">&#x27;client_4xx_error&#x27;</span> &gt; /www/test/400_error.html</span><br><span class="line">echo <span class="string">&#x27;client_5xx_error&#x27;</span> &gt; /www/test/500_error.html</span><br><span class="line"></span><br><span class="line">// 定义客户端错误页面</span><br><span class="line">error_page <span class="number">400</span> <span class="number">401</span> <span class="number">402</span> <span class="number">403</span> <span class="number">404</span> /400_error.html;</span><br><span class="line"><span class="attribute">location</span> /400_error.html &#123;</span><br><span class="line">	<span class="attribute">root</span> /www/test;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义服务端错误页面</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">501</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /500_error.html;</span><br><span class="line"><span class="attribute">location</span> /500_error.html &#123;</span><br><span class="line">	<span class="attribute">root</span> /www/test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>验证一下效果</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sy86vfej30u404l74g.jpg" alt="image-20200625104239563"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sy27w9hj30qh03kgls.jpg" alt="image-20200625104314946"></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sxfyj9hj31hc0bbgnr.jpg" alt="image-20200625104456679"></p>
<h2 id="1-11-设置Nginx防盗链"><a href="#1-11-设置Nginx防盗链" class="headerlink" title="1.11 设置Nginx防盗链"></a>1.11 设置Nginx防盗链</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">zhen主机配置防盗链</span><br><span class="line">[root@zhen ~]<span class="comment"># vi /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">在server&#123;&#125;区域里添加以下配置：</span><br><span class="line">        location ~* \.(wma|wmv|asf|mp3|mmf|zip|rar|gif|png|swf|flv|jpeg) &#123;</span><br><span class="line">            valid_referers nonde blocked  *.zhen.com  zhen.com;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">               rewrite  ^/  http://www.zhen.com/error.jpg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">#注意：不能存在以下缓存配置：</span></span><br><span class="line">     55         location  ~  \.(gif|jpg|jpeg|png|bmp|ico)$   &#123;</span><br><span class="line">     56             expires 1d;</span><br><span class="line">     57         &#125;</span><br><span class="line">wq!</span><br><span class="line">[root@zhen html]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">解释：</span><br><span class="line">第一行： wma|wmv|asf|mp3|mmf|zip|rar|jpg|gif|png|swf|flv 表示对这些后缀的文件进行防盗链。</span><br><span class="line">第二行：valid_referers表示被允许的URL，none表示浏览器中 referer（Referer 是 header 的一部分，当浏览器向 web 服务器发送请求时，一般会带上 Referer，告诉服务器我是从哪个页面链接过来的，服务器基此可以获得一些信息用于处理） 为空的情况，就直接在浏览器访问图片，blocked referer 不为空的情况，但是值被代理或防火墙删除了，这些值不以http://或 https://开头，*.zhen是匹配URL的域名。</span><br><span class="line">第三行：<span class="keyword">if</span>&#123;&#125;判断如果是来自于invalid_referer（不被允许的URL）链接，即不是来自第二行指定的URL,就强制跳转到错误页面，当然直接返回 404 （<span class="built_in">return</span> 404）也是可以的，也可以是图片。</span><br><span class="line">注意：防盗链测试时，不要和expires配置一起使用。</span><br></pre></td></tr></table></figure>



<h2 id="1-12-如何在已经安装好的nginx中添加模块"><a href="#1-12-如何在已经安装好的nginx中添加模块" class="headerlink" title="1.12 如何在已经安装好的nginx中添加模块"></a>1.12 如何在已经安装好的nginx中添加模块</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// 原已经安装好的nginx，现在需要添加一个未被编译安装的模块:</span><br><span class="line"></span><br><span class="line">// 查看原来编译时都带了哪些参数</span><br><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -V</span></span><br><span class="line"><span class="attribute">nginx</span> version: nginx/<span class="number">1</span>.<span class="number">12</span>.<span class="number">2</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">4</span>.<span class="number">7</span> <span class="number">20120313</span> (Red Hat <span class="number">4</span>.<span class="number">4</span>.<span class="number">7</span>-<span class="number">16</span>) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --with-http_realip_module --with-http_sub_module --with-http_gzip_static_module --with-http_stub_status_module --with-pcre</span><br><span class="line"></span><br><span class="line">进入nginx源码目录</span><br><span class="line"><span class="comment"># cd nginx-1.12.2</span></span><br><span class="line"></span><br><span class="line">// 添加的参数 （要加之前已经过的编译模块，不然最后只有新编译模块）</span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_realip_module --with-http_sub_module --with-http_gzip_static_module --with-http_stub_status_module --with-pcre --with-http_ssl_module</span></span><br><span class="line"></span><br><span class="line">// 编译，make完之后在objs目录下就多了个nginx，这个就是新版本的程序了。注意 &#123;不要<span class="attribute">make</span> install，否则就是覆盖安装&#125;</span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"></span><br><span class="line">// 替换nginx二进制文件</span><br><span class="line"><span class="comment"># cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak    (备份之前的nginx二进文件)</span></span><br><span class="line"><span class="comment"># cp ./objs/nginx  /usr/local/nginx/sbin/ </span></span><br><span class="line"></span><br><span class="line">// 测试新的nginx程序是否正确</span><br><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: theconfiguration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx:configuration file /usr/local/nginx/conf/nginx.conf test issuccessful</span><br><span class="line"></span><br><span class="line">// 重新加载nginx</span><br><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -s reload</span></span><br><span class="line"></span><br><span class="line">// 查看ngixn版本极其编译参数</span><br><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1</span>.<span class="number">12</span>.<span class="number">2</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">4</span>.<span class="number">7</span> <span class="number">20120313</span> (Red Hat <span class="number">4</span>.<span class="number">4</span>.<span class="number">7</span>-<span class="number">16</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1</span>.<span class="number">0</span>.1e-fips <span class="number">11</span> Feb <span class="number">2013</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --with-http_realip_module --with-http_sub_module --with-http_gzip_static_module --with-http_stub_status_module --with-pcre --with-http_ssl_module</span><br></pre></td></tr></table></figure>

<h2 id="1-13-Nginx中的location指令（重点）"><a href="#1-13-Nginx中的location指令（重点）" class="headerlink" title="1.13 Nginx中的location指令（重点）"></a>1.13 Nginx中的location指令（重点）</h2><blockquote>
<p>location的作用是根据用户请求的URI来执行不同的应用，就是根据用户请求的网站URL进行匹配，匹配成功即进行相关的操作</p>
</blockquote>
<h3 id="1-13-1-安装第三方的模块"><a href="#1-13-1-安装第三方的模块" class="headerlink" title="1.13.1 安装第三方的模块"></a>1.13.1 安装第三方的模块</h3><ul>
<li><strong>下载第三方模块echo</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># wget https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>重新编译添加三方echo模块</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="attribute">nginx</span> ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span>-<span class="number">39</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1</span>.<span class="number">0</span>.<span class="number">2k</span>-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">[root@nginx ~]<span class="comment"># tar -xf  v0.61.tar.gz -C /usr/src/</span></span><br><span class="line">[root@nginx ~]<span class="comment"># cd /usr/src/nginx-1.16.1/</span></span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/src/echo-nginx-module-0.61/ &amp;&amp; make</span></span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span></span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># cp -rf objs/nginx /usr/local/nginx/sbin/</span></span><br><span class="line"></span><br><span class="line">[root@nginx nginx-<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span>]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1</span>.<span class="number">16</span>.<span class="number">1</span></span><br><span class="line">built by gcc <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4</span>.<span class="number">8</span>.<span class="number">5</span>-<span class="number">39</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1</span>.<span class="number">0</span>.<span class="number">2k</span>-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-threads --with-file-aio --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/src/echo-nginx-module-<span class="number">0</span>.<span class="number">61</span>/</span><br></pre></td></tr></table></figure>

<h3 id="1-13-2-location语法-及-符号规则"><a href="#1-13-2-location语法-及-符号规则" class="headerlink" title="1.13.2 location语法 及 符号规则"></a>1.13.2 location语法 及 符号规则</h3><ul>
<li><strong>location语法格式：</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">location</span> [ = | <span class="regexp">~ |</span> <span class="regexp">~* |</span><span class="regexp"> ^~</span> ] uri &#123; ... &#125;</span><br><span class="line">Syntax: <span class="attribute">location</span> @name &#123; ... &#125;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>location的符号：</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">=</td>
<td align="left">表示精确匹配</td>
</tr>
<tr>
<td align="left">^~</td>
<td align="left">表示uri以指定字符或字符串开头</td>
</tr>
<tr>
<td align="left">~</td>
<td align="left">表示区分大小写的正则匹配</td>
</tr>
<tr>
<td align="left">~*</td>
<td align="left">表示不区分大小写的正则匹配</td>
</tr>
<tr>
<td align="left">/</td>
<td align="left">通用匹配，任何请求都会匹配到</td>
</tr>
</tbody></table>
<ul>
<li><strong>注意事项：</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">有些资料上介绍location支持 不匹配 !~，</span><br><span class="line">如： <span class="attribute">location</span> !<span class="regexp">~ &#x27;png&#x27;</span>&#123; ... &#125;</span><br><span class="line">这是错误的，location不支持 !~</span><br><span class="line"></span><br><span class="line">如果有这样的需求，可以通过if来实现，</span><br><span class="line">如： <span class="attribute">if</span> ($uri !<span class="regexp">~ &#x27;png&#x27;)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">注意：location优先级小于if</span><br></pre></td></tr></table></figure>

<h3 id="1-13-4-location优先级及案例"><a href="#1-13-4-location优先级及案例" class="headerlink" title="1.13.4 location优先级及案例"></a>1.13.4 location优先级及案例</h3><blockquote>
<p>总结一句话：= 符号优先级最高，/ 符号优先级最低</p>
</blockquote>
<ul>
<li><strong>规则优先级：</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=  高于  ^~  高于  ~* 等于 ~  高于  /</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对比 / 和 ~</strong></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">示例1：</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>    <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  location;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span>  /abc &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">测试命令：<span class="attribute">curl</span> http://127.0.0.1/abc/1.html</span><br><span class="line">结果是：~</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对比 ~ 和 ~</strong>*</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">示例1：</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>    <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  location;</span><br><span class="line">    <span class="attribute">root</span>  html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* /abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~*&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">测试命令：<span class="attribute">curl</span> http://127.0.0.1/abc/1.html</span><br><span class="line">结果是：<span class="regexp">~</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">示例2：把他们两个的顺序调整一下</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span>    <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  location;</span><br><span class="line">    <span class="attribute">root</span>  html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* /abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~*&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">测试命令：<span class="attribute">curl</span> http://127.0.0.1/abc/1.html</span><br><span class="line">结果是：<span class="regexp">~*</span></span><br><span class="line"><span class="regexp">结论是：~和~*优先级其实是一样的，如果两个同时出现，配置文件中哪个location靠前，哪个生效。</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>对比 ^~ 和 ~</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">示例1：</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>    <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  location;</span><br><span class="line">    <span class="attribute">root</span>  html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /abc</span> &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /abc &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;^~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">测试命令：<span class="attribute">curl</span> http://127.0.0.1/abc/1.html</span><br><span class="line">结果是：^~</span><br></pre></td></tr></table></figure></li>
<li><p><strong>对比 = 和 ^~</strong></p>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">示例1：</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> location;</span><br><span class="line">    <span class="attribute">root</span>  html;</span><br><span class="line"> </span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /abc.html &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;^~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> = /abc.html &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">测试命令：<span class="attribute">curl</span> http://127.0.0.1/abc.html</span><br><span class="line">结果是：=</span><br></pre></td></tr></table></figure>

<h1 id="Nginx静态资源控制"><a href="#Nginx静态资源控制" class="headerlink" title="Nginx静态资源控制"></a>Nginx静态资源控制</h1><h2 id="1-静态资源类型"><a href="#1-静态资源类型" class="headerlink" title="1. 静态资源类型"></a>1. 静态资源类型</h2><blockquote>
<p>Nginx 作为静态资源 Web 服务器部署配置, 传输非常的高效, 常常用于静态资源处理,  请求,  动静分离</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7syhozhaj30z30bq0y4.jpg" alt="image-20200625134655267"></p>
<blockquote>
<p><em><strong>非服务器动态运行 生成的文件就属于静态资源！</strong></em></p>
<ul>
<li><p><strong>静态资源：</strong>可以理解为前端的固定页面，这里面包含HTML、CSS、JS、图片等等，不需要查数据库也不需要程序处理，直接就能够显示的页面，如果想修改内容则必须修改页面，但是访问效率相当高。</p>
</li>
<li><p><strong>动态资源：</strong>需要程序处理或者从数据库中读数据，能够根据不同的条件在页面显示不同的数据，内容更新不需要修改页面但是访问速度不及静态页面。</p>
</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th>种类</th>
</tr>
</thead>
<tbody><tr>
<td>浏览器端渲染</td>
<td>HTML、CSS、JS</td>
</tr>
<tr>
<td>图片</td>
<td>JPEG、GIF、PNG</td>
</tr>
<tr>
<td>音频</td>
<td>FLV、Mp4</td>
</tr>
<tr>
<td>文件</td>
<td>TXT、任意下载文件</td>
</tr>
</tbody></table>
<h2 id="2-静态资源基本配置"><a href="#2-静态资源基本配置" class="headerlink" title="2. 静态资源基本配置"></a>2. 静态资源基本配置</h2><h3 id="2-1-文件读取高效-sendfile"><a href="#2-1-文件读取高效-sendfile" class="headerlink" title="2.1 文件读取高效 sendfile"></a>2.1 文件读取高效 sendfile</h3><p><strong>作用简介：</strong></p>
<blockquote>
<p>sendfile可以让Nginx在传输文件时直接在磁盘和tcp socket之间传输数据；开启这个参数后可以让数据不用经过用户buffer。如果这个参数不开启，会先在用户空间（Nginx进程空间）申请一个buffer，用read函数把数据从磁盘读到cache，再从cache读取到用户空间的buffer，再用write函数把数据从用户空间的buffer写入到内核的buffer，最后到tcp socket。</p>
</blockquote>
<p><strong>语法格式：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">sendfile</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">sendfile</span> <span class="literal">off</span>;</span><br><span class="line">Context: http, server, location, <span class="attribute">if</span> in location</span><br></pre></td></tr></table></figure>

<h3 id="2-2-提高网络传输效率-tcp-nopush"><a href="#2-2-提高网络传输效率-tcp-nopush" class="headerlink" title="2.2 提高网络传输效率 tcp_nopush"></a>2.2 提高网络传输效率 tcp_nopush</h3><p><strong>作用简介：</strong></p>
<blockquote>
<p>告诉nginx在一个数据包里发送所有头文件，而不一个接一个的发送。就是说数据包不会马上传送出去，等到数据包最大时，一次性的传输出去，这样有助于解决网络堵塞。</p>
</blockquote>
<p><strong>语法格式：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">tcp_nopush</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">tcp_nopush</span> <span class="literal">off</span>;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<h3 id="2-3-与-tcp-nopush-对应的配置-tcp-nodelay"><a href="#2-3-与-tcp-nopush-对应的配置-tcp-nodelay" class="headerlink" title="2.3 与 tcp_nopush 对应的配置 tcp_nodelay"></a>2.3 与 tcp_nopush 对应的配置 tcp_nodelay</h3><p><strong>作用简介：</strong></p>
<blockquote>
<p>告诉nginx不要缓存数据，而是一段一段的发送—当需要及时发送数据时，就应该给应用设置这个属性，这样发送一小块数据信息时就不能立即得到返回值。作用: 在keepalive连接下,提高网络的传输 ‘实时性’</p>
</blockquote>
<p><strong>语法格式：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">tcp_nodelay</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<h3 id="2-4-注意事项"><a href="#2-4-注意事项" class="headerlink" title="2.4 注意事项"></a>2.4 注意事项</h3><ol>
<li><p>tcp_nopush配置 与 tcp_nodelay 互斥。</p>
</li>
<li><p>在nginx中tcp_nopush必须和sendfile配合使用。</p>
</li>
</ol>
<h2 id="3-静态资源文件压缩配置"><a href="#3-静态资源文件压缩配置" class="headerlink" title="3. 静态资源文件压缩配置"></a>3. 静态资源文件压缩配置</h2><blockquote>
<p>Nginx 将响应报文发送至客户端之前可以启用压缩功能，这能够有效的节约带宽，并提高响应至客户端的速度。</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sypy5lmj30yd0aw0uo.jpg" alt="image-20200625215739171"></p>
<h3 id="3-1-gzip-压缩配置语法"><a href="#3-1-gzip-压缩配置语法" class="headerlink" title="3.1 gzip 压缩配置语法"></a>3.1 gzip 压缩配置语法</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">gzip</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">gzip</span> <span class="literal">off</span>;</span><br><span class="line">Context: http, server, location, <span class="attribute">if</span> in location</span><br><span class="line"></span><br><span class="line">作用: 数据传输时压缩</span><br></pre></td></tr></table></figure>

<h3 id="3-2-gzip-压缩比率配置语法"><a href="#3-2-gzip-压缩比率配置语法" class="headerlink" title="3.2 gzip 压缩比率配置语法"></a>3.2 gzip 压缩比率配置语法</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">gzip_comp_level</span> level;</span><br><span class="line">Default: <span class="attribute">gzip_comp_level</span> <span class="number">1</span>;</span><br><span class="line">Context: http, server, <span class="attribute">location</span></span><br><span class="line"></span><br><span class="line">作用: 压缩本身比较耗费服务端性能</span><br></pre></td></tr></table></figure>

<h3 id="3-3-gzip-压缩协议版本"><a href="#3-3-gzip-压缩协议版本" class="headerlink" title="3.3 gzip 压缩协议版本"></a>3.3 gzip 压缩协议版本</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span> | <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">Default: <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">Context: http, server, <span class="attribute">location</span></span><br><span class="line"></span><br><span class="line">作用: 压缩使用在http哪个协议, 主流版本<span class="number">1</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-图片压缩案例（不建议开启图片压缩）"><a href="#3-4-图片压缩案例（不建议开启图片压缩）" class="headerlink" title="3.4 图片压缩案例（不建议开启图片压缩）"></a>3.4 图片压缩案例（不建议开启图片压缩）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@lemon-<span class="attribute">min</span> vhosts]<span class="comment"># mkdir -p /www/images</span></span><br><span class="line">[root@lemon-min vhosts]<span class="comment"># cat ttl.lemon-li.cn.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">     <span class="attribute">listen</span>    <span class="number">80</span>;</span><br><span class="line">     <span class="attribute">server_name</span>  ttl.lemon-li.cn;</span><br><span class="line">     <span class="attribute">access_log</span>   logs/ttl_logs/access_ttl.lemon.cn.log    main;</span><br><span class="line">     <span class="attribute">error_log</span>    logs/ttl_logs/error_ttl.lemon.cn.log     <span class="literal">info</span>;</span><br><span class="line">     <span class="attribute">location</span> <span class="regexp">~ .*\.(gif|jpg|jpeg)$</span> &#123;</span><br><span class="line">     	 <span class="attribute">root</span> /www/images;</span><br><span class="line">         <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">         <span class="attribute">gzip</span>   <span class="literal">on</span>;</span><br><span class="line">         <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">         <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">         <span class="attribute">gzip_types</span> text/plain application/json application/x-javascript application/css application/xml application/xml+rss text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7syvdbxpj30pi03mmxs.jpg" alt="image-20200625225001698"></p>
<p>没有开启 gzip 图片压缩时</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7sz2mjkyj31hc0rw7m5.jpg" alt="image-20200625225811631"></p>
<p>开启 gzip 图片压缩时(关于图片的压缩比率不是太过明显)</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7szkq003j31hc0rth41.jpg" alt="image-20200625230007749"></p>
<h3 id="3-5-文本压缩案例"><a href="#3-5-文本压缩案例" class="headerlink" title="3.5 文本压缩案例"></a>3.5 文本压缩案例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@lemon-min vhosts]<span class="comment"># mkdir -p /www/doc</span></span><br><span class="line">[root@lemon-min vhosts]<span class="comment"># for i in &#123;1..20000&#125;;do echo &quot;asdabnvfgf&quot; &gt;&gt; /www/doc/test.txt ; done</span></span><br><span class="line">[root@lemon-min vhosts]<span class="comment"># ll -h /www/doc/</span></span><br><span class="line">总用量 216K</span><br><span class="line">-rw-r--r-- 1 root root 215K 6月  25 23:15 test.txt</span><br><span class="line">[root@lemon-min vhosts]<span class="comment"># cat ttl.lemon-li.cn.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">     listen    80;</span><br><span class="line">     server_name  ttl.lemon-li.cn;</span><br><span class="line">     access_log   logs/ttl_logs/access_ttl.lemon.cn.log    main;</span><br><span class="line">     error_log    logs/ttl_logs/error_ttl.lemon.cn.log     info;</span><br><span class="line">     location ~ .*\.(txt|xml)$ &#123;</span><br><span class="line">     	root /www/doc;</span><br><span class="line">	    sendfile on;</span><br><span class="line">        gzip   on;</span><br><span class="line">        gzip_comp_level 2;</span><br><span class="line">        gzip_http_version 1.1;</span><br><span class="line">        gzip_types text/plain application/json application/x-javascript application/css application/xml application/xml+rss text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有启用 gzip 文件压缩时</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7szpo4npj31gf0s077e.jpg" alt="image-20200625231806340"></p>
<p>启用 gzip 文件压缩时（可见压缩的重要性）</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gr7szvbsb9j31gf0rx77c.jpg" alt="image-20200625231931243"></p>
<h2 id="4-静态资源浏览器缓存"><a href="#4-静态资源浏览器缓存" class="headerlink" title="4. 静态资源浏览器缓存"></a>4. 静态资源浏览器缓存</h2><p><em><strong>HTTP协议定义的缓存机制 (如: Expires; Cache-control 等)</strong></em></p>
<blockquote>
<p><strong>1、浏览器无缓存</strong></p>
<p>浏览器请求-&gt;无缓存-&gt;请求WEB服务器-&gt;请求响应-&gt;呈现</p>
<p><strong>2、浏览器有缓存</strong></p>
<p>浏览器请求-&gt;有缓存-&gt;校验过期-&gt;是否有更新-&gt;呈现</p>
<p>校验是否过期 Expires HTTP1.0, Cache-Control(max-age) HTTP1.1</p>
<p>协议中Etag头信息校验 Etag ()</p>
<p>Last-Modified头信息校验 Last-Modified (具体时间)</p>
</blockquote>
<p><strong>1.缓存配置语法 expires</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">expires</span> [modified] time;</span><br><span class="line"><span class="attribute">expires</span> epoch | max | <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">expires</span> <span class="literal">off</span>;</span><br><span class="line">Context: http, server, location, <span class="attribute">if</span> in location</span><br></pre></td></tr></table></figure>

<p><strong>2.配置静态资源缓存</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(js|css|html)$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /soft/code/js;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1h</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(jpg|gif|png)$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /soft/code/images;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1d</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.开发代码没有正式上线时, 希望静态文件不被缓存</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//取消<span class="attribute">js</span> css html等静态文件缓存</span><br><span class="line">location <span class="regexp">~ .*\.(css|js|swf|json|mp4|htm|html)$</span> &#123;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-store;</span><br><span class="line">    <span class="attribute">add_header</span> Pragma <span class="literal">no</span>-cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-静态资源防盗链"><a href="#5-静态资源防盗链" class="headerlink" title="5. 静态资源防盗链"></a>5. 静态资源防盗链</h2><blockquote>
<p><strong>防盗链就是防止别人盗用服务器中的图片、文件、视频等相关资源。防盗链：是通过location + rewrite + http_refer实现的。</strong></p>
</blockquote>
<p><strong>1. 基于 http_refer 防盗链配置模块</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">valid_referers</span> <span class="literal">none</span> | <span class="literal">blocked</span> | server_names | string ...;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location</span><br></pre></td></tr></table></figure>

<p><strong>2. 准备html文件</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>pachong<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">&quot;background-color:red;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://192.168.69.113/test.jpg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 启动防盗链</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(wma|wmv|asf|mp3|mmf|zip|rar|gif|png|swf|flv|jpeg)</span> &#123;</span><br><span class="line">    <span class="attribute">valid_referers</span> nonde <span class="literal">blocked</span>  <span class="regexp">*.zhen.com</span>  zhen.com;</span><br><span class="line">    <span class="attribute">if</span> ($invalid_referer) &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> <span class="regexp"> ^/</span>  http://www.zhen.com/error.jpg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：不能存在以下缓存配置：</span></span><br><span class="line"><span class="attribute">location</span>  <span class="regexp">~  \.(gif|jpg|jpeg|png|bmp|ico)$</span>   &#123;</span><br><span class="line">    <span class="attribute">expires</span> xxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. 验证</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 伪造协议头访问</span><br><span class="line">[root@C-<span class="attribute">Server</span> ~]<span class="comment"># curl -e &quot;http://www.baidu.com&quot; -I http://192.168.69.113/test.jpg</span></span><br><span class="line">HTTP/<span class="number">1</span>.<span class="number">1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Server: nginx/<span class="number">1</span>.<span class="number">12</span>.<span class="number">2</span></span><br><span class="line">Date: Tue, <span class="number">17</span> Apr <span class="number">2018</span> <span class="number">04</span>:<span class="number">55</span>:<span class="number">18</span> GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: <span class="number">169</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">// 伪造协议头访问</span><br><span class="line">[root@C-Server ~]<span class="comment"># curl -e &quot;http://www.xuliangwei.com&quot; -I http://192.168.69.113/tes</span></span><br><span class="line">t.jpg</span><br><span class="line">HTTP/<span class="number">1</span>.<span class="number">1</span> <span class="number">200</span> OK</span><br><span class="line">Server: nginx/<span class="number">1</span>.<span class="number">12</span>.<span class="number">2</span></span><br><span class="line">Date: Tue, <span class="number">17</span> Apr <span class="number">2018</span> <span class="number">04</span>:<span class="number">55</span>:<span class="number">27</span> GMT</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line">Content-Length: <span class="number">174315</span></span><br><span class="line">Last-Modified: Wed, <span class="number">29</span> Nov <span class="number">2017</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">08</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5a1e2678-2a8eb&quot;</span></span><br><span class="line">Expires: Tue, <span class="number">17</span> Apr <span class="number">2018</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">27</span> GMT</span><br><span class="line">Cache-Control: max-age=<span class="number">43200</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <div>
        
          <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

        
      </div>

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/15/Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%88%97%E8%A1%A8/" rel="prev" title="Linux系统调用列表">
      <i class="fa fa-chevron-left"></i> Linux系统调用列表
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/15/Tomcat/" rel="next" title="Tomcat">
      Tomcat <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Web%E7%BD%91%E7%AB%99%E6%A6%82%E5%BF%B5"><span class="nav-text">Web网站概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Web%E7%BD%91%E7%AB%99%E5%B8%B8%E8%AF%86"><span class="nav-text">1. Web网站常识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-URL%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="nav-text">2. URL的组成部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%8D%8F%E8%AE%AE-Protocol"><span class="nav-text">2.1 协议(Protocol)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%9F%9F%E5%90%8D-Domain"><span class="nav-text">2.2 域名(Domain)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%AB%AF%E5%8F%A3-Port"><span class="nav-text">2.3 端口(Port)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-URL%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90"><span class="nav-text">2.4 URL文件资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E5%8F%82%E6%95%B0-query"><span class="nav-text">2.5 参数(query)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E7%89%87%E6%AE%B5-fragment"><span class="nav-text">2.6 片段(fragment)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP%E5%8D%8F%E8%AE%AE%E6%A6%82%E5%BF%B5"><span class="nav-text">HTTP协议概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-HTTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B"><span class="nav-text">1. HTTP协议简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-HTTP%E8%AF%B7%E6%B1%82%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">2. HTTP请求的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-HTTP%E5%93%8D%E5%BA%94%E5%A4%B4%E4%BF%A1%E6%81%AF"><span class="nav-text">3. HTTP响应头信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-HTTP%E7%8A%B6%E6%80%81%E4%BB%A3%E7%A0%81"><span class="nav-text">4. HTTP状态代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-HTTP-content-type"><span class="nav-text">5. HTTP  content-type</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="nav-text">Nginx原理介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Nginx-%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1 Nginx 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-Nginx%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">1.2 Nginx的优缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Nginx%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.3 Nginx应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-Nginx%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-text">1.4 Nginx的进程模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-Nginx%E7%9A%84%E7%BB%84%E6%88%90%E9%80%BB%E8%BE%91%E5%9B%BE"><span class="nav-text">1.5 Nginx的组成逻辑图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-Nginx%E7%9A%84%E6%A8%A1%E5%9D%97%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">1.6 Nginx的模块是什么</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="nav-text">Nginx应用部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E8%BF%9B%E5%85%A5-nginx-%E5%AE%98%E7%BD%91%EF%BC%8C%E4%B8%8B%E8%BD%BD"><span class="nav-text">1.1 进入 nginx 官网，下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%AE%89%E8%A3%85Nginx%E4%BE%9D%E8%B5%96"><span class="nav-text">1.2 安装Nginx依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%AE%89%E8%A3%85Nginx%E5%B9%B6%E4%BF%AE%E6%94%B9%E5%B1%9E%E4%B8%BB%E5%B1%9E%E7%A5%96"><span class="nav-text">1.3 安装Nginx并修改属主属祖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E8%AE%BE%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="nav-text">1.4 设置防火墙规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-Nginx%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-%E5%8F%8A-%E4%BF%A1%E5%8F%B7"><span class="nav-text">1.5 Nginx常用命令 及 信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E4%BC%98%E5%8C%96Nginx%E4%B8%94%E7%BC%96%E5%86%99%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-text">1.6 优化Nginx且编写启动脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-%E5%90%AF%E5%8A%A8Nginx%E6%9C%8D%E5%8A%A1"><span class="nav-text">1.7 启动Nginx服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="nav-text">Nginx常用模块及内置变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Nginx%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-text">1.1 Nginx常用模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-Nginx%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="nav-text">1.2 Nginx内置变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-conf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">Nginx.conf 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95"><span class="nav-text">1.1 Nginx配置文件语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="nav-text">1.2 配置文件整体结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-main%E5%85%A8%E5%B1%80%E5%9D%97"><span class="nav-text">1.2.1 main全局块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-events%E5%9D%97"><span class="nav-text">1.2.2 events块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-http%E5%9D%97"><span class="nav-text">1.2.3 http块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-server%E5%9D%97"><span class="nav-text">1.2.4 server块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-5-location%E5%9D%97"><span class="nav-text">1.2.5 location块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Nginx%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="nav-text">1.3 Nginx的默认配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="nav-text">Nginx日志文件详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Nginx%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="nav-text">1.1 Nginx日志配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%E6%AE%B5%E5%88%86%E6%9E%90"><span class="nav-text">1.2访问日志段分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Nginx%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1"><span class="nav-text">1.3 Nginx访问日志统计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-http-access-module%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-text">1.4 http_access_module局限性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%B8%B8%E7%94%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="nav-text">Nginx常用的基本配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Nginx-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-text">1.1 Nginx 虚拟主机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E9%85%8D%E7%BD%AE%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%EF%BC%88%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84%EF%BC%89"><span class="nav-text">1.1.1 配置基于域名虚拟主机（最常用的）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E9%85%8D%E7%BD%AE%EF%A5%A7%E5%90%8C%E7%AB%AF%E5%8F%A3%E8%AE%BF%E9%97%AE%EF%A5%A7%E5%90%8C%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-text">1.1.2 配置不同端口访问不同虚拟主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E5%88%AB%E5%90%8D"><span class="nav-text">1.1.3 配置虚拟主机别名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-Nginx-%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="nav-text">1.2 Nginx 状态监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Nginx%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9"><span class="nav-text">1.3 Nginx下载站点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-Nginx-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">1.4 Nginx 访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-%E5%9F%BA%E4%BA%8EIP%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">1.4.1 基于IP的访问控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-2-%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86%E8%AE%A4%E8%AF%81"><span class="nav-text">1.4.2 基于用户登陆认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-3-%E4%B8%8A%E9%9D%A2%E4%B8%A4%E8%80%85%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%B8%80%E8%B5%B7%E7%94%A8"><span class="nav-text">1.4.3 上面两者也可以一起用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-Nginx-%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6"><span class="nav-text">1.5 Nginx 访问限制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-1-http%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E8%AF%B7%E6%B1%82"><span class="nav-text">1.5.1 http协议的连接与请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-2-HTTP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E8%AF%B7%E6%B1%82"><span class="nav-text">1.5.2 HTTP 协议的连接与请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-3-Nginx-%E8%BF%9E%E6%8E%A5%E9%99%90%E5%88%B6"><span class="nav-text">1.5.3 Nginx 连接限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-4-Nginx-%E8%AF%B7%E6%B1%82%E9%99%90%E5%88%B6"><span class="nav-text">1.5.4 Nginx 请求限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-5-%E6%95%B4%E4%BD%93%E6%80%BB%E7%BB%93"><span class="nav-text">1.5.5 整体总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-Nginx%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2"><span class="nav-text">1.6 Nginx日志分割</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-1-%E6%89%8B%E5%8A%A8%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2"><span class="nav-text">1.6.1 手动日志分割</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-2-%E8%87%AA%E5%8A%A8%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2"><span class="nav-text">1.6.2 自动日志分割</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-Nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E9%83%A8%E7%BD%B2"><span class="nav-text">1.7 Nginx平滑升级部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-8-index-%E5%92%8C-autoindex%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">1.8 index 和 autoindex的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-9-root-%E5%92%8C-alias-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">1.9 root 和 alias 的区别（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-1-root%E5%B1%9E%E6%80%A7"><span class="nav-text">1.9.1 root属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-2-alias%E5%B1%9E%E6%80%A7%EF%BC%88%E5%88%AB%E5%90%8D%EF%BC%89"><span class="nav-text">1.9.2 alias属性（别名）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-10-%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="nav-text">1.10 定义错误页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-11-%E8%AE%BE%E7%BD%AENginx%E9%98%B2%E7%9B%97%E9%93%BE"><span class="nav-text">1.11 设置Nginx防盗链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-12-%E5%A6%82%E4%BD%95%E5%9C%A8%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E5%A5%BD%E7%9A%84nginx%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97"><span class="nav-text">1.12 如何在已经安装好的nginx中添加模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-13-Nginx%E4%B8%AD%E7%9A%84location%E6%8C%87%E4%BB%A4%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">1.13 Nginx中的location指令（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-1-%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="nav-text">1.13.1 安装第三方的模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-2-location%E8%AF%AD%E6%B3%95-%E5%8F%8A-%E7%AC%A6%E5%8F%B7%E8%A7%84%E5%88%99"><span class="nav-text">1.13.2 location语法 及 符号规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-4-location%E4%BC%98%E5%85%88%E7%BA%A7%E5%8F%8A%E6%A1%88%E4%BE%8B"><span class="nav-text">1.13.4 location优先级及案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6"><span class="nav-text">Nginx静态资源控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B"><span class="nav-text">1. 静态资源类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="nav-text">2. 静态资源基本配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E9%AB%98%E6%95%88-sendfile"><span class="nav-text">2.1 文件读取高效 sendfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%8F%90%E9%AB%98%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E6%95%88%E7%8E%87-tcp-nopush"><span class="nav-text">2.2 提高网络传输效率 tcp_nopush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E4%B8%8E-tcp-nopush-%E5%AF%B9%E5%BA%94%E7%9A%84%E9%85%8D%E7%BD%AE-tcp-nodelay"><span class="nav-text">2.3 与 tcp_nopush 对应的配置 tcp_nodelay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">2.4 注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%8E%8B%E7%BC%A9%E9%85%8D%E7%BD%AE"><span class="nav-text">3. 静态资源文件压缩配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-gzip-%E5%8E%8B%E7%BC%A9%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="nav-text">3.1 gzip 压缩配置语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-gzip-%E5%8E%8B%E7%BC%A9%E6%AF%94%E7%8E%87%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="nav-text">3.2 gzip 压缩比率配置语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-gzip-%E5%8E%8B%E7%BC%A9%E5%8D%8F%E8%AE%AE%E7%89%88%E6%9C%AC"><span class="nav-text">3.3 gzip 压缩协议版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9%E6%A1%88%E4%BE%8B%EF%BC%88%E4%B8%8D%E5%BB%BA%E8%AE%AE%E5%BC%80%E5%90%AF%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9%EF%BC%89"><span class="nav-text">3.4 图片压缩案例（不建议开启图片压缩）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E6%96%87%E6%9C%AC%E5%8E%8B%E7%BC%A9%E6%A1%88%E4%BE%8B"><span class="nav-text">3.5 文本压缩案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%B5%8F%E8%A7%88%EF%A8%B8%E7%BC%93%E5%AD%98"><span class="nav-text">4. 静态资源浏览器缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%98%B2%E7%9B%97%E9%93%BE"><span class="nav-text">5. 静态资源防盗链</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Armin"
      src="/uploads/armin.png">
  <p class="site-author-name" itemprop="name">Armin</p>
  <div class="site-description" itemprop="description">记录生活中的点点滴滴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://aws.amazon.com/cn/" title="AWS → https:&#x2F;&#x2F;aws.amazon.com&#x2F;cn&#x2F;" rel="noopener" target="_blank"><i class="fab fa-aws fa-fw"></i>AWS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.processon.com/" title="processon → https:&#x2F;&#x2F;www.processon.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-accusoft fa-fw"></i>processon</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.cn-ki.net/" title="知识库 → https:&#x2F;&#x2F;www.cn-ki.net&#x2F;" rel="noopener" target="_blank"><i class="fas fa-book-open fa-fw"></i>知识库</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tophub.today/" title="看新闻 → https:&#x2F;&#x2F;tophub.today&#x2F;" rel="noopener" target="_blank"><i class="far fa-newspaper fa-fw"></i>看新闻</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://m.zxjsq.net/" title="计算器 → http:&#x2F;&#x2F;m.zxjsq.net" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>计算器</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://shijisuishu.bmcx.com/20010314__shijisuishu/" title="计龄器 → https:&#x2F;&#x2F;shijisuishu.bmcx.com&#x2F;20010314__shijisuishu&#x2F;" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>计龄器</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tool.oschina.net/hexconvert" title="进制转换 → https:&#x2F;&#x2F;tool.oschina.net&#x2F;hexconvert" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>进制转换</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.sojson.com/convert/subnetmask.html" title="子网计算 → https:&#x2F;&#x2F;www.sojson.com&#x2F;convert&#x2F;subnetmask.html" rel="noopener" target="_blank"><i class="fas fa-calculator fa-fw"></i>子网计算</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.baidu.com/" title="百度一下 → https:&#x2F;&#x2F;www.baidu.com&#x2F;" rel="noopener" target="_blank"><i class="fas fa-search fa-fw"></i>百度一下</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Armin</span>
</div>

<div class="powered-by">

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
