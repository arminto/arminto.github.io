<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>kubernetes | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="article">
<meta property="og:title" content="kubernetes">
<meta property="og:url" content="http://example.com/2020/10/07/Kubernetes/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglt0l5jvj30ys0mdjsy.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglu5k2llj31cc0rogoj.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglv10q8ej31090qz778.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgly1v3asj319g0kz0uv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglvwxv5pj30lu0gzdgt.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglwk0498j30w30g3gme.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglym7jbuj30wp0hgjrp.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglz5snizj30su0jcdhd.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglzqspuwj30ey09yaa7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm020wzzj30fc07s74g.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm0eaoz8j30fg0fzt9c.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm178kjnj30of052jrw.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm1jnakwj30nc03omxb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm2atmxgj30o808kaaw.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm4akwr4j30le06kjry.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm4y1036j30qr03r74d.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm5jwjd9j30ns02emx8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm62gqcyj30vd0l9mye.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm6lmwiuj30p704o74k.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm6zy1o2j30zh0mk3yy.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm79wsubj30zg0d1t9b.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm7nmx5cj30yw08omym.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm85j7q6j31020bgjru.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm8ns17tj30zh0cygm7.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmaouhauj30ut03wdg0.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmb48c6tj30uq0453yo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmb9bl07j30uv04d3yo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmbf0b5tj30uy03o74g.jpg">
<meta property="article:published_time" content="2020-10-07T03:18:00.000Z">
<meta property="article:modified_time" content="2021-06-05T14:44:25.503Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglt0l5jvj30ys0mdjsy.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Kubernetes" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/07/Kubernetes/" class="article-date">
  <time class="dt-published" datetime="2020-10-07T03:18:00.000Z" itemprop="datePublished">2020-10-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      kubernetes
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <!--toc-->
<span id="more"></span>

<h1 id="一、Kubernetes-概念"><a href="#一、Kubernetes-概念" class="headerlink" title="一、Kubernetes 概念"></a>一、Kubernetes 概念</h1><blockquote>
<p>k8s是一组服务器集群，K8s所管理的集群节点上的容器。<a target="_blank" rel="noopener" href="https://kubernetes.io/">官方网站</a></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglt0l5jvj30ys0mdjsy.jpg"></p>
<h2 id="1、什么是Kubernetes"><a href="#1、什么是Kubernetes" class="headerlink" title="1、什么是Kubernetes ?"></a>1、什么是Kubernetes ?</h2><p>Kubernetes是一个可移植的，可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。它拥有一个庞大且快速增长的生态系统。Kubernetes的服务，支持和工具广泛可用。</p>
<p>Kubernetes这个名字起源于希腊语，意思是舵手或飞行员。Google在2014年开源了Kubernetes项目。Kubernetes将超过15年的Google在大规模生产工作负载方面的经验与社区中最好的想法和实践相结合。</p>
<h2 id="2、为什么需要它？他的功能？"><a href="#2、为什么需要它？他的功能？" class="headerlink" title="2、为什么需要它？他的功能？"></a>2、为什么需要它？他的功能？</h2><p>容器是捆绑和运行应用程序的好方法。在生产环境中，您需要管理运行应用程序的容器，并确保没有停机时间。例如，如果一个容器发生故障，则需要启动另一个容器。如果由系统处理此行为，会不会更容易？</p>
<p>这就是Kubernetes的救援方法！Kubernetes为您提供了一个可弹性运行分布式系统的框架。它负责应用程序的扩展和故障转移，提供部署模式等。例如，Kubernetes可以轻松管理系统的Canary部署。</p>
<h3 id="2-1-自我修复"><a href="#2-1-自我修复" class="headerlink" title="2.1 自我修复"></a>2.1 自我修复</h3><p>在节点故障时重新启动失败的容器，替换和重新部署容器，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保线上服务不中断。</p>
<h3 id="2-2-弹性伸缩"><a href="#2-2-弹性伸缩" class="headerlink" title="2.2 弹性伸缩"></a>2.2 弹性伸缩</h3><p>使用命令、UI或者基于CPU使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。</p>
<h3 id="2-3-自动部署和回滚"><a href="#2-3-自动部署和回滚" class="headerlink" title="2.3 自动部署和回滚"></a>2.3 自动部署和回滚</h3><p>Kubernetes采用滚动更新策略更新应用，一次更新一个Pod，而不是同时删除所有Pod，如果更新过程中出现问题，Kubernetes将回滚更改，升级保证业务不受影响。</p>
<h3 id="2-4-存储编排"><a href="#2-4-存储编排" class="headerlink" title="2.4 存储编排"></a>2.4 存储编排</h3><p>挂载外部存储系统，无论是来自本地存储，公有云（如AWS），还是网络存储（如NFS、iSCSI、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性。</p>
<h3 id="2-5-服务发现和负载均衡"><a href="#2-5-服务发现和负载均衡" class="headerlink" title="2.5 服务发现和负载均衡"></a>2.5 服务发现和负载均衡</h3><p>Kubernetes为多个容器提供一个统一访问入口（内部IP地址和一个DNS名称），并且负载均衡关联的所有容器，使得用户无需考虑容器IP问题。集群内应用可以通过DNS名称访问另一个应用，方便微服务之间通信。</p>
<h3 id="2-6-机密和配置管理"><a href="#2-6-机密和配置管理" class="headerlink" title="2.6 机密和配置管理"></a>2.6 机密和配置管理</h3><p>管理机密数据和应用程序配置，而不需要把敏感数据暴露在镜像里，提高敏感数据安全性。</p>
<h3 id="2-7-资源监控"><a href="#2-7-资源监控" class="headerlink" title="2.7 资源监控"></a>2.7 资源监控</h3><p>Node节点组件集成cAdvisor资源收集工具，可通过Heapster汇总整个集群节点资源数据，然后存储到InfluxDB时序数据库，再由Grafana展示，可以快速实现对集群资源监控，满足基本监控需求。</p>
<h3 id="2-8-提供认证和授权"><a href="#2-8-提供认证和授权" class="headerlink" title="2.8 提供认证和授权"></a>2.8 提供认证和授权</h3><p>支持属性访问控制 (ABAC)、角色访问控制（RBAC）认证授权策略，控制用户是否有权限使用Kubernetes API做某些事情，精细化权限分配。</p>
<h2 id="3、Kubernetes架构"><a href="#3、Kubernetes架构" class="headerlink" title="3、Kubernetes架构"></a>3、Kubernetes架构</h2><blockquote>
<p>kubernetes分别有两种角色：1、master 管理节点     2、worker 工作节点</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglu5k2llj31cc0rogoj.jpg"></p>
<blockquote>
<p><strong>生产k8s集群图构</strong></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglv10q8ej31090qz778.jpg"></p>
<h2 id="4、Kubernetes组件"><a href="#4、Kubernetes组件" class="headerlink" title="4、Kubernetes组件"></a>4、Kubernetes组件</h2><blockquote>
<p>kubernetes分为 Master节点和 Node节点，前者是管理节点，后者是容器运行的节点。其中Master节点主要有3个重要组件，分别是APIServer，sheduler 和 controller manager。<br>Node节点 有两个组件 kubelet 和 kubelet （有时候master节点也可以既是管理节点也是工作节点）</p>
</blockquote>
<h3 id="4-1-Master-组件"><a href="#4-1-Master-组件" class="headerlink" title="4.1 Master 组件"></a>4.1 Master 组件</h3><h4 id="4-1-1-API-Server"><a href="#4-1-1-API-Server" class="headerlink" title="4.1.1 API Server"></a>4.1.1 API Server</h4><p>APIServer组件负责响应用户的管理请求、进行指挥协调工作，所有服务访问统一入口。</p>
<h4 id="4-1-2-Scheduler"><a href="#4-1-2-Scheduler" class="headerlink" title="4.1.2 Scheduler"></a>4.1.2 Scheduler</h4><p>scheduler组件是将待调度的pod按照一定的调度算法绑定到合适的工作节点上，负责介绍任务，选择合适的点进行分配任务。</p>
<h4 id="4-1-3-Controller-manager"><a href="#4-1-3-Controller-manager" class="headerlink" title="4.1.3 Controller manager"></a>4.1.3 Controller manager</h4><p>是一组控制器的合集，负责控制控制管理对应的资源，如副本（replication）和工作节点（node）等。维持副本期望数目</p>
<h4 id="4-1-4-ETCD"><a href="#4-1-4-ETCD" class="headerlink" title="4.1.4 ETCD"></a>4.1.4 ETCD</h4><p>etcd 负责以K/V的形式保存 Kubernetes Cluster 的配置信息和各种资源的状态信息。当数据发生变化时，etcd 会快速地通知 Kubernetes 相关组件。键值对数据库储存K8S集群所有重要信息（持久化）</p>
<h3 id="4-2-Node组件"><a href="#4-2-Node组件" class="headerlink" title="4.2 Node组件"></a>4.2 Node组件</h3><h4 id="4-2-1-Kubelet"><a href="#4-2-1-Kubelet" class="headerlink" title="4.2.1 Kubelet"></a>4.2.1 Kubelet</h4><p>管理维护pod运行的agent，直接跟容器引擎交互实现容器的生命周期管理</p>
<h4 id="4-2-2-Kube-proxy"><a href="#4-2-2-Kube-proxy" class="headerlink" title="4.2.2 Kube-proxy"></a>4.2.2 Kube-proxy</h4><p>将service的流量转发到对应endpoint，负责写入规则至 IPTABLES、IPvs实现服务映射访间的</p>
<h4 id="4-2-3-Flannel网络"><a href="#4-2-3-Flannel网络" class="headerlink" title="4.2.3 Flannel网络"></a>4.2.3 Flannel网络</h4><p>维持各个节点上pod之间的通信。</p>
<h3 id="4-3-重要组件"><a href="#4-3-重要组件" class="headerlink" title="4.3 重要组件"></a>4.3 重要组件</h3><h4 id="4-3-1-Coredns"><a href="#4-3-1-Coredns" class="headerlink" title="4.3.1 Coredns"></a>4.3.1 Coredns</h4><p>可以为集群中的Svc创建一个域名IP的对应关系解析</p>
<h4 id="4-3-2-Dashboard"><a href="#4-3-2-Dashboard" class="headerlink" title="4.3.2 Dashboard"></a>4.3.2 Dashboard</h4><p>给K8S集群提供一个B/S结构访问体系</p>
<h4 id="4-3-3-Ingress-Controller"><a href="#4-3-3-Ingress-Controller" class="headerlink" title="4.3.3 Ingress Controller"></a>4.3.3 Ingress Controller</h4><p>官方只能实现四层代理， INGRESS可以实现七层代理</p>
<h4 id="4-3-4-Federation"><a href="#4-3-4-Federation" class="headerlink" title="4.3.4 Federation"></a>4.3.4 Federation</h4><p>提供一个可以跨集群中心多K8S统一管理功能</p>
<h4 id="4-3-5-Prometheus"><a href="#4-3-5-Prometheus" class="headerlink" title="4.3.5 Prometheus"></a>4.3.5 Prometheus</h4><p>提供K8sS集群的监控能力</p>
<h4 id="4-3-6-ELK"><a href="#4-3-6-ELK" class="headerlink" title="4.3.6 ELK"></a>4.3.6 ELK</h4><p>提供K8s集群旦志统一分析介入平台</p>
<h2 id="5、k8s网络架构概念"><a href="#5、k8s网络架构概念" class="headerlink" title="5、k8s网络架构概念"></a>5、k8s网络架构概念</h2><h3 id="5-1-CNI（容器网络接口）"><a href="#5-1-CNI（容器网络接口）" class="headerlink" title="5.1 CNI（容器网络接口）"></a>5.1 CNI（容器网络接口）</h3><p>CNI是Container Network Interface的是一个标准的，通用的接口。现在容器平台：docker，kubernetes，mesos，容器网络解决方案：flannel，calico，weave。只要提供一个标准的接口，就能为同样满足该协议的所有容器平台提供网络功能，而CNI正是这样的一个标准接口协议。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgly1v3asj319g0kz0uv.jpg"></p>
<h3 id="5-2-pod的通信分类"><a href="#5-2-pod的通信分类" class="headerlink" title="5.2 pod的通信分类"></a>5.2 pod的通信分类</h3><ul>
<li>同一个Pod内的多个容器之间：lo Network</li>
<li>各Pod之间 或 不同主机各Pod 的通讯：Over lay Network</li>
<li>Pod 与 Service之间的通讯：各节点的 Iptables规则 或者 IPVS</li>
</ul>
<h3 id="5-3-K8S整体网络模型图"><a href="#5-3-K8S整体网络模型图" class="headerlink" title="5.3 K8S整体网络模型图"></a>5.3 K8S整体网络模型图</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglvwxv5pj30lu0gzdgt.jpg"></p>
<h3 id="5-4-K8S中的三种网络"><a href="#5-4-K8S中的三种网络" class="headerlink" title="5.4 K8S中的三种网络"></a>5.4 K8S中的三种网络</h3><ul>
<li><strong>node网络：</strong>负责不同主机之间的pod通信的入口和出口（物理网络）</li>
<li><strong>service网络：</strong>负责对外提供服务（暴露网络）</li>
<li><strong>pod网络：</strong>负责pod内部容器之间的通信 和 pod 与 pod之间的通信（内部网络）</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglwk0498j30w30g3gme.jpg"></p>
<h3 id="5-5-K8S的网络通讯原理"><a href="#5-5-K8S的网络通讯原理" class="headerlink" title="5.5 K8S的网络通讯原理"></a>5.5 K8S的网络通讯原理</h3><p><strong>同一个Pod内部通讯：</strong></p>
<ul>
<li>同一个Pod共享同一个网络命名空间，共享同一个 Linux协议栈。</li>
</ul>
<p><strong>Pod1 至 Pod2：</strong></p>
<ul>
<li>Pod1至Pod2不在同一台主机：Pod的地址是与 docker0在同一个网段的，但 docker0网段与宿主机网卡是两个完全不同的IP网段，并且不同Node之间的通信只能通过宿主机的物理网卡进行。将PoIP和所在 Node’MJIP关联起来，通过这个关联让Pod可以互相访问。</li>
<li>Pod1与Pod2在同一台机器：由Docker0网桥直接转发请求至Pod2，不需要经过 Flannel</li>
</ul>
<p><strong>Pod 至 Service的网络：</strong></p>
<ul>
<li>iptables 或者 IPVS维护和转发</li>
</ul>
<p><strong>Pod到外网：</strong></p>
<ul>
<li>Pod向外网发送请求，查找路由表，转发数据包到宿主机的网卡，宿主网卡完成路由选择后， iptables执行 Masquerade，把源IP更改为宿主网卡的IP，然后向外网服务器发送请求</li>
</ul>
<p><strong>外网访问Pod：</strong></p>
<ul>
<li>访问对应的Service即可</li>
</ul>
<h2 id="6、Kubernetes核心概念"><a href="#6、Kubernetes核心概念" class="headerlink" title="6、Kubernetes核心概念"></a>6、Kubernetes核心概念</h2><h3 id="6-1-container"><a href="#6-1-container" class="headerlink" title="6.1 container"></a>6.1 container</h3><p>容器可以运行服务和程序，容器是独立运行的一个或一组应用。容器可以进行启动、开始、停止、删除等操作，每个容器都是相互隔离的。可以把容器看作是一个简易版的linux环境（包括root用户权限、进程空间、用户空间和网络空间等）和运行其中的应用程序。</p>
<h3 id="6-2-namespace"><a href="#6-2-namespace" class="headerlink" title="6.2 namespace"></a>6.2 namespace</h3><p>可以将一个物理的cluster逻辑上划分成多个虚拟cluster，每个cluster就是一个namespace。不同的namespace里的资源是完全隔离的。</p>
<h3 id="6-3-labels"><a href="#6-3-labels" class="headerlink" title="6.3 labels"></a>6.3 labels</h3><p>标签用于区分对象（比如pod和services）, kubernetes中的任意对象都是通过label进行标识，label的实质是一系列的key/value键值对，其中key与value由用户自己指定。label可以附加到各种资源对象上，如node、pod、service、RC等，一个资源对象可以定义任意数量的label，可以通过label selector（标签选择器）查询和筛选资源对象。label是rc和service运行的基础，两者通过label来进行关联node上运行的pod</p>
<h3 id="6-4-pod"><a href="#6-4-pod" class="headerlink" title="6.4 pod"></a>6.4 pod</h3><p>在kubernetes系统中, pod是最小部署单元, 一个pod包含一个或多个容器（一组容器的集合）,<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">pod</a> 是一个可以被创建、销毁、调度、管理的最小部署单元。kubernates为每个pod都分配了唯一的ip地址, 称之为PodIP, 一个pod里的多个容器共享podip地址，它负责外部跟容器之间进行通信。<br>Pod主要分为两种类型：1、自主式pod，2、控制器管理pod<br>pod是kubernetes最重要的基本概念，也是k8s中的最小运行单元，一个pod中可以运行一个或多个的container及一个管理 container——pause</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglym7jbuj30wp0hgjrp.jpg"></p>
<h3 id="6-5-controllers-控制器"><a href="#6-5-controllers-控制器" class="headerlink" title="6.5 controllers 控制器"></a>6.5 controllers 控制器</h3><blockquote>
<p>kubernetes不会直接创建pod，而是通过controller来管理pod的，所以controller负责维护集群的状态，比如故障检测、自动扩展、滚动更新。</p>
</blockquote>
<p><strong>控制器有：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployments（无状态，守护进程类，只关注群体不关注个体）</a><ul>
<li>一个Deployment控制器为 Pods和 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/">ReplicaSets</a> 提供声明式的更新能力。</li>
<li>虽然 ReplicaSet可以独立使用，但一般还是建议使用 Deployment来自动管理ReplicaSe，这样就无需担心跟其他机制的不兼容问题（比如 ReplicaSe不支持rolling-update 但 Deployment支持）。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/">ReplicaSet（RS）</a><ul>
<li>ReplicaSe 跟 Replication Controller没有本质的不同，只是名字不一样，并且ReplicaSe支持集合式的 selector。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicationcontroller/">ReplicationController（RC）</a><ul>
<li>ReplicationController用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退出，会自动创建新的Pod来替代；而如果异常多出来的容器也会自动回收。在新版本的 Kubernetes中建议使用 ReplicaSe来取代 Replication Controlle。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler</a><ul>
<li>Horizontal Pod Autoscaling仅适用于 Deployment和 ReplicaSet，在Ⅵ1版本中仅支持根据Pod的CPU利用率扩所容，在 vlalpha版本中，支持根据内存和用户自定义的 metric扩缩容。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">StatefulSets（管理有状态应用）</a><ul>
<li>StatefulSet是为了解决有状态服务的问题（对应 Deployments和 ReplicaSets是为无状态服务而设计）。</li>
<li>其应用场景包括：<ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PvC来实现</li>
<li>稳定的网络标志，即Pod重新调度后其 PodName和 HostName不变，基于 Headless Service（即没有 Cluster Ip的 Service）来实现</li>
<li>有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是 Running和 Ready状态），基于 init containers来实现</li>
<li>有序收缩，有序删除（即从N1到0）</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a><ul>
<li>Daemon Set确保全部（或者一些）Node上运行一个Pod的副本。当有Node加入集群时，也会为他们新增一个Pod。当有Node从集群移除时，这些Pod也会被回收。删除 Daemon Set将会删除它创建的所有Pod。</li>
<li>使用 Daemon Set的一些典型用法：<ul>
<li>运行集群存储 daemon，例如在每个Node上运行 glusterd、ceph。</li>
<li>在每个Node上运行日志收集 daemon，例如 fluent、 logstash</li>
<li>在每个Node上运行监控 daemon，例如 Prometheus Node Exporter</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/job/">Jobs</a> &amp;&amp; <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">CronJob</a><ul>
<li>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束。</li>
<li>Cron Job 管理基于时间的Job，即：1、在给定时间点只运行一次    2、周期性地在给定时间点运行</li>
</ul>
</li>
</ul>
<h3 id="6-6-services"><a href="#6-6-services" class="headerlink" title="6.6 services"></a>6.6 services</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxk/p/9605901.html">services</a> 是kubernetes最外围的单元，通过虚拟一个访问ip及服务端口，可以访问我们定义好的pod资源，是通过iptables的nat转发来实现，转发的目标端口为kube_proxy生成的随机端口。services代理pod集合对外表现是一个访问入口，分配一个集群ip地址，来自这个ip的请求将负载均衡转发后端pod中的容器，service通过lable selector选择一组pod提供服务。</p>
<p>deployment可以部署多个副本，每个pod 都有自己的IP，外界如何访问这些副本那？</p>
<ul>
<li>答案是：service</li>
</ul>
<p>k8s的 service定义了外界访问一组特定pod的方式。service有自己的IP和端口，service为pod提供了负载均衡。<br>k8s运行容器pod与访问容器这两项任务分别由controller和service执行。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglz5snizj30su0jcdhd.jpg"></p>
<blockquote>
<p><strong>K8S-Service类型：</strong></p>
</blockquote>
<p>ClusterIp：默认类型，自动分配一个仅Cluster内部可以访问的虚拟IP</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjglzqspuwj30ey09yaa7.jpg"></p>
<p>NodePort：在ClusterIP基础上为Service在每台机器上绑定一个端口，这样可以通过NodeIP:NodePort来访问服务<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm020wzzj30fc07s74g.jpg"></p>
<p>LoadBalancer：在NodePort基础上，借助cloud provider创建一个外部负载均衡器，并将请求转发到NodeIP:NodePort<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm0eaoz8j30fg0fzt9c.jpg"></p>
<h1 id="二、部署K8S集群（kubeadm）"><a href="#二、部署K8S集群（kubeadm）" class="headerlink" title="二、部署K8S集群（kubeadm）"></a>二、部署K8S集群（kubeadm）</h1><blockquote>
<p>准备三台Linux虚拟机（K8S集群三台起步），系统用CentOS7.4，虚拟机配置是2颗CPU和2G内存（K8S最低要求的配置），网络使用桥接网卡方式并使用静态IP</p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>角色描述</th>
</tr>
</thead>
<tbody><tr>
<td>Master</td>
<td>ens32:192.168.2.1</td>
<td>K8S Master节点/ETCD节点</td>
</tr>
<tr>
<td>Node1</td>
<td>ens32:192.168.2.2</td>
<td>K8S Node节点</td>
</tr>
<tr>
<td>Node2</td>
<td>ens32:192.168.2.3</td>
<td>K8S Node节点</td>
</tr>
<tr>
<td>harbor</td>
<td>ens32:192.168.2.4</td>
<td>docker 镜像仓库节点</td>
</tr>
</tbody></table>
<h2 id="1、系统环境初始化"><a href="#1、系统环境初始化" class="headerlink" title="1、系统环境初始化"></a>1、系统环境初始化</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改主机名</span></span><br><span class="line">hostnamectl set-hostname master1</span><br><span class="line">hostnamectl set-hostname node1</span><br><span class="line">hostnamectl set-hostname node2</span><br><span class="line">hostnamectl set-hostname harbor</span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置系统时区为中国/上海</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前的 UTC 时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启依赖于系统时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载阿里源</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装相关依赖</span></span><br><span class="line">yum install -y epel-release conntrack ntpdate ntp ipvsadm ipset iptables-services iptables curl sysstat libseccomp wget unzip net-tools git yum-utils jq  device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步时间</span></span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加hosts</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="string">192.168.2.1 master1</span></span><br><span class="line"><span class="string">192.168.2.2 node1</span></span><br><span class="line"><span class="string">192.168.2.3 node2</span></span><br><span class="line"><span class="string">192.168.2.4 hub.lemon.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置防火墙为 Iptables 并设置空规则</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">systemctl  start iptables</span><br><span class="line">systemctl  <span class="built_in">enable</span> iptables</span><br><span class="line">iptables -F  &amp;&amp;  service iptables save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭swap、selinux</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭系统不需要服务</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl <span class="built_in">disable</span> postfix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 rsyslogd 和 systemd journald</span></span><br><span class="line"><span class="comment"># 持久化保存日志的目录</span></span><br><span class="line">mkdir /var/<span class="built_in">log</span>/journal</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Journal]</span></span><br><span class="line"><span class="string"># 持久化保存到磁盘</span></span><br><span class="line"><span class="string">Storage=persistent</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 压缩历史日志</span></span><br><span class="line"><span class="string">Compress=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SyncIntervalSec=5m</span></span><br><span class="line"><span class="string">RateLimitInterval=30s</span></span><br><span class="line"><span class="string">RateLimitBurst=1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 最大占用空间 10G</span></span><br><span class="line"><span class="string">SystemMaxUse=10G</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 单日志文件最大 200</span></span><br><span class="line"><span class="string">MSystemMaxFileSize=200M</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 日志保存时间 2 周</span></span><br><span class="line"><span class="string">MaxRetentionSec=2week</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 不将日志转发到 syslog</span></span><br><span class="line"><span class="string">ForwardToSyslog=no</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<h2 id="2、升级系统内核并优化"><a href="#2、升级系统内核并优化" class="headerlink" title="2、升级系统内核并优化"></a>2、升级系统内核并优化</h2><blockquote>
<p>CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如：</p>
<p>高版本的 docker(1.13 以后) 启用了 3.10 kernel 实验支持的 kernel memory account 功能(无法关闭)，当节点压力大如频繁启动和停止容器时会导致 cgroup memory leak；网络设备引用计数泄漏, 会导致类似于报错：”kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1”;</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方案：升级内核到 4.4.X 以上；</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载内核源</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最新版本内核</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用内核</span></span><br><span class="line">cat /boot/grub2/grub.cfg |grep menuentry</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核启动项</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级系统文件</span></span><br><span class="line">yum update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 设置开机从新内核启动 &amp; 重启系统</span></span><br><span class="line">grub2-set-default <span class="string">&quot;CentOS Linux (4.4.236-1.el7.elrepo.x86_64) 7 (Core)&quot;</span> &amp;&amp; reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核</span></span><br><span class="line">uname -r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-proxy开启ipvs的前置条件</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自加载</span></span><br><span class="line">chmod a+x /etc/rc.d/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash /etc/sysconfig/modules/ipvs.modules&#x27;</span> &gt;&gt; /etc/rc.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化内核参数</span></span><br><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># 关闭IPV6协议</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启网桥模式</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启路由转发</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 不检查物理内存是否够用</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启 OOM</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=1048576</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances=8192</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启的文件句柄数目</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 开启对大的文件数目</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ~~~</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=2310720</span></span><br><span class="line"><span class="string">vm.dirty_bytes=15728640</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自动加载</span></span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<h2 id="3、部署Docker、kubeadm、kubectl"><a href="#3、部署Docker、kubeadm、kubectl" class="headerlink" title="3、部署Docker、kubeadm、kubectl"></a>3、部署Docker、kubeadm、kubectl</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载阿里的docker源、Centos7源、kubernetes源</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">yum clean all &amp;&amp; yum makecache &amp;&amp; <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docke，记给docker换镜像源</span></span><br><span class="line">yum -y install docker-ce-18.09.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 /etc/docker 目录</span></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 daemon配置文件</span></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;: [&quot;https://p8hkkij9.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Kubeadm （主从配置）</span></span><br><span class="line"><span class="comment"># 这里正常情况下，master上安装kubeadm、kubectl，node只安装kubelet就行，不过都装上也没事。</span></span><br><span class="line">yum -y install kubeadm-1.15.1 kubectl-1.15.1 kubelet-1.15.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机启动kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>

<h2 id="4、初始化主节点"><a href="#4、初始化主节点" class="headerlink" title="4、初始化主节点"></a>4、初始化主节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前下载k8s镜像</span></span><br><span class="line"><span class="comment">## master</span></span><br><span class="line">cat image-k8s-v1_15_1.sh </span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">    kube-apiserver:v1.15.1</span><br><span class="line">    kube-controller-manager:v1.15.1</span><br><span class="line">    kube-scheduler:v1.15.1</span><br><span class="line">    kube-proxy:v1.15.1</span><br><span class="line">    pause:3.1</span><br><span class="line">    etcd:3.3.10</span><br><span class="line">    coredns:1.3.1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## node</span></span><br><span class="line">cat image-k8s-v1_15_1.sh </span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">    kube-proxy:v1.15.1</span><br><span class="line">    pause:3.1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">bash image-k8s-v1_15_1.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## master</span></span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k8s.gcr.io/kube-apiserver            v1.15.1             68c3eb07bfc3        14 months ago       207MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager   v1.15.1             d75082f1d121        14 months ago       159MB</span><br><span class="line">k8s.gcr.io/kube-scheduler            v1.15.1             b0b3c4c404da        14 months ago       81.1MB</span><br><span class="line">k8s.gcr.io/kube-proxy                v1.15.1             89a062da739d        14 months ago       82.4MB</span><br><span class="line">k8s.gcr.io/coredns                   1.3.1               eb516548c180        20 months ago       40.3MB</span><br><span class="line">k8s.gcr.io/etcd                      3.3.10              2c4adeb21b4f        21 months ago       258MB</span><br><span class="line">k8s.gcr.io/pause                     3.1                 da86e6ba6ca1        2 years ago         742kB</span><br><span class="line"></span><br><span class="line"><span class="comment">## node</span></span><br><span class="line">docker images</span><br><span class="line">REPOSITORY              TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k8s.gcr.io/kube-proxy   v1.15.1             89a062da739d        14 months ago       82.4MB</span><br><span class="line">k8s.gcr.io/pause        3.1                 da86e6ba6ca1        2 years ago         742kB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改kubeadm默认初始化配置模板</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubeadm config print init-defaults &gt; kubeadm-config.yaml</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># cat kubeadm-config.yaml </span></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  <span class="comment"># 填写好master1的IP地址</span></span><br><span class="line">  advertiseAddress: 192.168.2.1</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: master1</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line"><span class="comment"># 选择初始化的k8s集群版本镜像</span></span><br><span class="line">kubernetesVersion: v1.15.1</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  <span class="comment"># 原因是一会要用的flannel来解决pod的扁平化网络，而flannel默认的网段就是10.244.0.0/16，所以这就将pod的IP段设置为和flannel相同的IP段，免得后期再做修改</span></span><br><span class="line">  podSubnet: <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line"><span class="comment"># 下面这一段的意思是将默认的iptables调度方式改为为IPVS</span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">featureGates:</span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span></span><br><span class="line">mode: ipvs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化k8s集群</span></span><br><span class="line"><span class="comment"># --experimental-upload-certs：可以让后来加入的主节点自动加入证书；注：v1.15以上版本的参数已改为--upload-certs</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubeadm init --config=kubeadm-config.yaml --experimental-upload-certs | tee kubeadm-init.log</span></span><br></pre></td></tr></table></figure>

<h2 id="5、加入主节点以及其余工作节点"><a href="#5、加入主节点以及其余工作节点" class="headerlink" title="5、加入主节点以及其余工作节点"></a>5、加入主节点以及其余工作节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># cat kubeadm-init.log</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.2.1:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4dc6790b3232bc4fd7f80e614d38e21b15cfd3d318f09b596b68336375b381e4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查kubelet服务是否已经打开</span></span><br><span class="line">systemctl status kubelet | grep running</span><br><span class="line">   Active: active (running) since 日 2020-09-13 01:53:32 CST; 6min ago</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是会发现节点的状态是NotReady</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1   NotReady   master   11m     v1.15.1</span><br><span class="line">node1     NotReady   &lt;none&gt;   2m13s   v1.15.1</span><br><span class="line">node2     NotReady   &lt;none&gt;   2m10s   v1.15.1</span><br></pre></td></tr></table></figure>

<p><em><strong>这就需要下面来部署flannel来解决扁平化网络问题</strong></em></p>
<h2 id="6、部署-CNI-flannel网络"><a href="#6、部署-CNI-flannel网络" class="headerlink" title="6、部署 CNI - flannel网络"></a>6、部署 CNI - flannel网络</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master</span></span><br><span class="line">docker ps | wc -l</span><br><span class="line">11</span><br><span class="line"></span><br><span class="line"><span class="comment"># node</span></span><br><span class="line">docker ps | wc -l</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署flannel全覆盖网络</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再来检查节点状态</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS   ROLES    AGE     VERSION</span><br><span class="line">master1   Ready    master   18m     v1.15.1</span><br><span class="line">node1     Ready    &lt;none&gt;   8m38s   v1.15.1</span><br><span class="line">node2     Ready    &lt;none&gt;   8m35s   v1.15.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># master</span></span><br><span class="line">docker ps | wc -l</span><br><span class="line">17</span><br><span class="line"></span><br><span class="line"><span class="comment"># node</span></span><br><span class="line">docker ps | wc -l</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<h2 id="7、查看集群状态-和相关的容器"><a href="#7、查看集群状态-和相关的容器" class="headerlink" title="7、查看集群状态 和相关的容器"></a>7、查看集群状态 和相关的容器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br><span class="line">NAME      STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME</span><br><span class="line">master1   Ready    master   20m   v1.15.1   192.168.2.1   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line">node1     Ready    &lt;none&gt;   10m   v1.15.1   192.168.2.2   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line">node2     Ready    &lt;none&gt;   10m   v1.15.1   192.168.2.3   &lt;none&gt;        CentOS Linux 7 (Core)   4.4.236-1.el7.elrepo.x86_64   docker://18.9.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># master</span></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">84dd17529257        eb516548c180           <span class="string">&quot;/coredns -conf /etc…&quot;</span>   2 minutes ago       Up 2 minutes                            k8s_coredns_coredns-5c98db65d4-57czz_kube-system_606e4e6b-4449-47e6-825e-ae277240c234_0</span><br><span class="line">82f76a769c7b        eb516548c180           <span class="string">&quot;/coredns -conf /etc…&quot;</span>   2 minutes ago       Up 2 minutes                            k8s_coredns_coredns-5c98db65d4-s9fsm_kube-system_12ba7f81-4f21-4779-96a6-321eb13277e7_0</span><br><span class="line">f247e960197c        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago       Up 2 minutes                            k8s_POD_coredns-5c98db65d4-57czz_kube-system_606e4e6b-4449-47e6-825e-ae277240c234_0</span><br><span class="line">92493172808b        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago       Up 2 minutes                            k8s_POD_coredns-5c98db65d4-s9fsm_kube-system_12ba7f81-4f21-4779-96a6-321eb13277e7_0</span><br><span class="line">b3aee006a16e        4e9f801d2217           <span class="string">&quot;/opt/bin/flanneld -…&quot;</span>   3 minutes ago       Up 3 minutes                            k8s_kube-flannel_kube-flannel-ds-amd64-hj7wr_kube-system_65d6bc4c-0ff9-4db2-b399-2f4439b1d245_0</span><br><span class="line">9a23d4285f5d        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 3 minutes ago       Up 3 minutes                            k8s_POD_kube-flannel-ds-amd64-hj7wr_kube-system_65d6bc4c-0ff9-4db2-b399-2f4439b1d245_0</span><br><span class="line">f190f2f7c2ad        89a062da739d           <span class="string">&quot;/usr/local/bin/kube…&quot;</span>   20 minutes ago      Up 20 minutes                           k8s_kube-proxy_kube-proxy-lwjps_kube-system_a82e0f18-4f77-4380-981b-fa0f1d184c58_0</span><br><span class="line">914464411c16        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 20 minutes ago      Up 20 minutes                           k8s_POD_kube-proxy-lwjps_kube-system_a82e0f18-4f77-4380-981b-fa0f1d184c58_0</span><br><span class="line">e2601a55e5ed        68c3eb07bfc3           <span class="string">&quot;kube-apiserver --ad…&quot;</span>   20 minutes ago      Up 20 minutes                           k8s_kube-apiserver_kube-apiserver-master1_kube-system_861772be00785c7580d2ba6e448af71a_0</span><br><span class="line">2d7c1b43fbfc        2c4adeb21b4f           <span class="string">&quot;etcd --advertise-cl…&quot;</span>   20 minutes ago      Up 20 minutes                           k8s_etcd_etcd-master1_kube-system_ca97e003da80dbb3e55de2bf12f554a4_0</span><br><span class="line">607152ea68c6        d75082f1d121           <span class="string">&quot;kube-controller-man…&quot;</span>   20 minutes ago      Up 20 minutes                           k8s_kube-controller-manager_kube-controller-manager-master1_kube-system_5a1fa432561d9745fe013857ccb566c1_0</span><br><span class="line">295ac6621d3d        b0b3c4c404da           <span class="string">&quot;kube-scheduler --bi…&quot;</span>   20 minutes ago      Up 20 minutes                           k8s_kube-scheduler_kube-scheduler-master1_kube-system_ecae9d12d3610192347be3d1aa5aa552_0</span><br><span class="line">497472fb767f        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 20 minutes ago      Up 20 minutes                           k8s_POD_kube-apiserver-master1_kube-system_861772be00785c7580d2ba6e448af71a_0</span><br><span class="line">745f579f6862        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 20 minutes ago      Up 20 minutes                           k8s_POD_kube-scheduler-master1_kube-system_ecae9d12d3610192347be3d1aa5aa552_0</span><br><span class="line">1c13551500b1        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 20 minutes ago      Up 20 minutes                           k8s_POD_kube-controller-manager-master1_kube-system_5a1fa432561d9745fe013857ccb566c1_0</span><br><span class="line">e1c11f2c4405        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 20 minutes ago      Up 20 minutes                           k8s_POD_etcd-master1_kube-system_ca97e003da80dbb3e55de2bf12f554a4_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># node</span></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">006e0852ef90        4e9f801d2217           <span class="string">&quot;/opt/bin/flanneld -…&quot;</span>   3 minutes ago       Up 3 minutes                            k8s_kube-flannel_kube-flannel-ds-amd64-wc96r_kube-system_551bdfe3-27cb-4ad7-9ac0-ac4e374e622c_0</span><br><span class="line">80826dcd6e4d        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 4 minutes ago       Up 3 minutes                            k8s_POD_kube-flannel-ds-amd64-wc96r_kube-system_551bdfe3-27cb-4ad7-9ac0-ac4e374e622c_0</span><br><span class="line">4a6ce5f0b30c        89a062da739d           <span class="string">&quot;/usr/local/bin/kube…&quot;</span>   11 minutes ago      Up 11 minutes                           k8s_kube-proxy_kube-proxy-r77pb_kube-system_b0f20b0f-3b4e-4f83-a250-a7658a37f67f_0</span><br><span class="line">82dd3545add5        k8s.gcr.io/pause:3.1   <span class="string">&quot;/pause&quot;</span>                 11 minutes ago      Up 11 minutes                           k8s_POD_kube-proxy-r77pb_kube-system_b0f20b0f-3b4e-4f83-a250-a7658a37f67f_0</span><br></pre></td></tr></table></figure>

<h2 id="8、搭建配置harbor私有仓库"><a href="#8、搭建配置harbor私有仓库" class="headerlink" title="8、搭建配置harbor私有仓库"></a>8、搭建配置harbor私有仓库</h2><blockquote>
<p>安装Harbor需要先安装docker和docker-compose，上面的系统初始化、系统升级和优化、安装Docker的步骤这里不再陈述</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在所有docker节点的daemon.json文件上添加下面信任配置</span></span><br><span class="line">cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://p8hkkij9.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;https://hub.lemon.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#~~ 这里先不急着重启docker，等一会颁发完证书之后在重启</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Harbor节点上安装docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.14.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># chmod a+x docker-compose</span></span><br><span class="line">[root@harbor ~]<span class="comment"># mv docker-compose /usr/local/bin/</span></span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.23.2, build 1110ad01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Harbor私有hub，创建CA证书</span></span><br><span class="line">[root@harbor ~]<span class="comment"># which openssl</span></span><br><span class="line">/usr/bin/openssl</span><br><span class="line">[root@harbor ~]<span class="comment"># mkdir -p /data/ssl &amp;&amp; cd /data/ssl/</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm178kjnj30of052jrw.jpg"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm1jnakwj30nc03omxb.jpg"></p>
<figure class="highlight sh"><figcaption><span># 创建生成证书签名请求</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout hub.lemon.com.key -out hub.lemon.com.csr</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm2atmxgj30o808kaaw.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成注册表主机证书</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># openssl x509 -req -days 365 -in hub.lemon.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out hub.lemon.com.crt</span></span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=CN/ST=Beijing/L=Beijing/O=lemon/OU=hub/CN=hub.lemon.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的证书</span></span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm4akwr4j30le06kjry.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 信任自签发的域名证书</span></span><br><span class="line"><span class="comment"># 由于linux操作系统不信任自签发的CA证书，所以需要把证书加入到系统的信任证书里</span></span><br><span class="line"><span class="comment"># 添加自签证书到系统</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># cp hub.lemon.com.crt /etc/pki/ca-trust/source/anchors/</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># ls -lh /etc/pki/ca-trust/source/anchors/</span></span><br><span class="line">总用量 4.0K</span><br><span class="line">-rw-r--r-- 1 root root 1.9K 9月  13 02:23 hub.lemon.com.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让系统CA信任立刻生效</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># update-ca-trust enable</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># update-ca-trust extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果已经启动Docker了，必须要重启；如果安装过Harbor以后再重启的话，有可能会出现harbor连不上的情况，需要重新把Harbor启动的容器和镜像删除后，重新install一遍</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建harbor的证.目录</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># mkdir -p /usr/local/harbor/ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制域名证到harbor要安装的路径</span></span><br><span class="line">[root@harbor ssl]<span class="comment"># cp hub.lemon.com.crt hub.lemon.com.key /usr/local/harbor/ssh/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装测试，上传harbor安装包并解压到相应路径</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm4y1036j30qr03r74d.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># tar xf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line">[root@harbor ~]<span class="comment"># mv harbor/* /usr/local/harbor/</span></span><br><span class="line">[root@harbor ~]<span class="comment"># cd /usr/local/harbor/ &amp;&amp; ls</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm5jwjd9j30ns02emx8.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># harbor配置备份 &amp; 修改配置文件</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># cp harbor.yml harbor.yml.bak</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># vim harbor.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm62gqcyj30vd0l9mye.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成配置 &amp; 安装（需联网）</span></span><br><span class="line"><span class="comment"># 下载harbor所需镜像</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># ./prepare</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/prepare    v1.9.0              aa594772c1e8        12 months ago       147MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Harbor</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># ./install.sh --with-notary --with-clair --with-chartmuseum</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor日志文件存放路径为/var/log/harbor/</span></span><br><span class="line"><span class="comment"># 如果需要修改Harbor的配置文件harbor.yml，因为Harbor是基于docker-compose服务编排的，我们可以使用docker-compose命令重启Harbor。不修改配置文件，重启Harbor命令：docker-compose start | stop | restart</span></span><br><span class="line">1、停止Harbor</span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose -f /usr/local/harbor/docker-compose.yml down</span></span><br><span class="line"></span><br><span class="line">2、启动Harbor</span><br><span class="line">[root@harbor ~]<span class="comment"># docker-compose -f /usr/local/harbor/docker-compose.yml up -d</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm6lmwiuj30p704o74k.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开机自运行</span></span><br><span class="line">[root@harbor ~]<span class="comment"># cat &lt;&lt;END&gt;&gt; /etc/rc.local </span></span><br><span class="line">docker-compose -f /usr/<span class="built_in">local</span>/harbor/docker-compose.yml up -d</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">[root@harbor ~]<span class="comment"># chmod u+x /etc/rc.d/rc.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录Harbor仓库</span></span><br><span class="line">[root@harbor harbor]<span class="comment"># docker login https://hub.lemon.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: Harbor12345</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端测试是否能够访问（须在客户端加入hosts）</span></span><br><span class="line">https://hub.lemon.com/</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm6zy1o2j30zh0mk3yy.jpg"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm79wsubj30zg0d1t9b.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便在一个节点上测试docker是否能使用harbor库</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker login https://hub.lemon.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># docker pull httpd</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker tag httpd:latest hub.lemon.com/library/httpd:v1  #打好标签</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker rmi httpd:latest</span></span><br><span class="line">Untagged: httpd:latest</span><br><span class="line">Untagged: httpd@sha256:0fce91cc167634ede639701b7dd1d8093f4ad2f2d9d0d5a8f4be2eaef8a570fb</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm7nmx5cj30yw08omym.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># docker push hub.lemon.com/library/httpd:v1    #推送至harbor仓库</span></span><br><span class="line">The push refers to repository [hub.lemon.com/library/httpd]</span><br><span class="line">f1fee4547086: Pushed </span><br><span class="line">a6a46c0268b1: Pushed </span><br><span class="line">951b1be5cf2d: Pushed </span><br><span class="line">d37da03a9458: Pushed </span><br><span class="line">07cab4339852: Pushed </span><br><span class="line">v1: digest: sha256:8c9bc11ca46ffd0b6b8a00e30aa670abef6c0d5d308e318a5cb8cf9e23931649 size: 1367</span><br><span class="line"><span class="comment"># 回到浏览器查看</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm85j7q6j31020bgjru.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes拉取harbor库镜像创建pod</span></span><br><span class="line"><span class="comment"># 在此之前先将打标签的镜像删除</span></span><br><span class="line">[root@master1 ~]<span class="comment"># docker rmi hub.lemon.com/library/httpd:v1</span></span><br><span class="line">Untagged: hub.lemon.com/library/httpd:v1</span><br><span class="line">Untagged: hub.lemon.com/library/httpd@sha256:8c9bc11ca46ffd0b6b8a00e30aa670abef6c0d5d308e318a5cb8cf9e23931649</span><br><span class="line">Deleted: sha256:6d82971d37d087be9917ab2015a4dc807569c736d3f2017c0821ddc4ed126617</span><br><span class="line">Deleted: sha256:59a897aaa844713f078ea9234bd61b0f4885598a9ffb1267b4c59983813abb52</span><br><span class="line">Deleted: sha256:6942605f2c5a8ba622491e369f2585daafe749a645835f5abb4fb9d11803664d</span><br><span class="line">Deleted: sha256:0f44970c8ecb7e1107f45ff7d5a7f7f3799a9821dce5cd30c51f2f7641339665</span><br><span class="line">Deleted: sha256:97635989e45ed57deef09cd09be52d008a073f2e1e045a1ba91956fbc2db2961</span><br><span class="line">Deleted: sha256:07cab433985205f29909739f511777a810f4a9aff486355b71308bb654cdc868</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于harbor仓库的镜像启动Pod</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl run httpd-01 --image=hub.lemon.com/library/httpd:v1 --port=80 --replicas=1</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/httpd-01 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有deployment</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   1/1     1            1           21s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有rs（RESTARTS副本）</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">httpd-01-6c9fbcfb65   1         1         1       47s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有pod</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   0          58s</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   0          69s   10.244.1.2   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互式执行容器命令</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-9hlhv ls</span></span><br><span class="line">bin  build  cgi-bin  conf  error  htdocs  icons  include  logs	modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问这个pod的IP</span></span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.244.1.2</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有已经退出的容器</span></span><br><span class="line">docker rm -v $(docker ps -qa -f status=exited)</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgm8ns17tj30zh0cygm7.jpg"></p>
<h2 id="9、基本的使用下K8S"><a href="#9、基本的使用下K8S" class="headerlink" title="9、基本的使用下K8S"></a>9、基本的使用下K8S</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pod的详细信息</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-jvmc8   1/1     Running   1          12h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试删除这个pod容器后，k8s会不会重新策划这个pod</span></span><br><span class="line">kubectl -n default delete pod httpd-01-6c9fbcfb65-jvmc8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证, 可以看到k8s看到副本的期望值不符合之后，就会马上新起来一个pod来满足这个期望值</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在生产环境下发现一个副本的pod已经不够用了，需要扩容</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl -n default scale --replicas=3  deployment/httpd-01</span></span><br><span class="line">deployment.extensions/httpd-01 scaled</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   3/3     3            3           12h</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          51s</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          51s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          12h    10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          2m8s   10.244.2.3   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          2m8s   10.244.2.2   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment"># 能够看到，已经扩容成功了，没错，就是这么简单~~</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是现在又引来了一个新的问题，我有三个容器，端口一样，但ip确是不一样的，外界该要怎么访问这个pod呢？</span></span><br><span class="line"><span class="comment"># 答：使用SVC来实现</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl expose --help|grep -A 1 &#x27;Create a service for an nginx&#x27;</span></span><br><span class="line">  <span class="comment"># Create a service for an nginx deployment, which serves on port 80 and connects to the containers on port 8000.</span></span><br><span class="line">  kubectl expose deployment nginx --port=80 --target-port=8000</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看一下deployment名称</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">httpd-01   3/3     3            3           13h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建svc</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl expose deployment httpd-01 --port=88 --target-port=80</span></span><br><span class="line"> service/httpd-01 exposed</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看一下svc地址</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">httpd-01     ClusterIP   10.99.191.162   &lt;none&gt;        88/TCP    30s   run=httpd-01</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   13h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里为了好验证负载均衡，在访问之前先修改容器网页</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">httpd-01-6c9fbcfb65-9hlhv   1/1     Running   1          13h   10.244.1.3   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-hjhjn   1/1     Running   0          23m   10.244.2.3   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">httpd-01-6c9fbcfb65-x52hh   1/1     Running   0          23m   10.244.2.2   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-9hlhv bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-9hlhv:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node1-10.244.1.3&#x27; &gt; htdocs/index.html </span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-hjhjn bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-hjhjn:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node2-10.244.2.3&#x27; &gt; htdocs/index.html</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it httpd-01-6c9fbcfb65-x52hh bash</span></span><br><span class="line">root@httpd-01-6c9fbcfb65-x52hh:/usr/<span class="built_in">local</span>/apache2<span class="comment"># echo &#x27;node2-10.244.2.2&#x27; &gt; htdocs/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问SVC从而以负载均衡的方式访问到pod副本</span></span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.3</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.2</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node1-10.244.1.3</span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.99.191.162:88</span></span><br><span class="line">node2-10.244.2.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原理：查看下ipvsadm规则</span></span><br><span class="line">[root@master1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.2.1:6443             Masq    1      3          0         </span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.6:53                Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:53                Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line">  -&gt; 10.244.0.6:9153              Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:9153              Masq    1      0          0         </span><br><span class="line"><span class="comment"># 这就是刚才创建的SVC，实际上他就是一个转发规则</span></span><br><span class="line">TCP  10.99.191.162:88 rr</span><br><span class="line">  -&gt; 10.244.1.3:80                Masq    1      0          1         </span><br><span class="line">  -&gt; 10.244.2.2:80                Masq    1      0          1         </span><br><span class="line">  -&gt; 10.244.2.3:80                Masq    1      0          2         </span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.0.6:53                Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.0.7:53                Masq    1      0          0</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面做的其实只能在内部访问，如果像对外开放的话，需将原本svc的type类型改为NodePort类型，因为默认的ClusterIP类型只是针对这个集群，封闭不对外暴露的。</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl edit svc httpd-01</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2020-09-13T07:50:56Z&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    run: httpd-01</span><br><span class="line">  name: httpd-01</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;21567&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/services/httpd-01</span><br><span class="line">  uid: 624c99c1-b27f-4990-aa5b-d381e0a37755</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.99.191.162</span><br><span class="line">  ports:</span><br><span class="line">  - port: 88</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    run: httpd-01</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再来查看这个svc的类型</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get svc -o wide</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">httpd-01     NodePort    10.99.191.162   &lt;none&gt;        88:32552/TCP   28m   run=httpd-01</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        14h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会发现它基于上面的88端口对外打开了一个随机端口32552提供服务，而且是将所有k8s节点都打开了这个端口号对外服务</span></span><br><span class="line">[root@master1 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1945/kube-proxy</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1568/kube-proxy</span><br><span class="line"></span><br><span class="line">[root@node2 ~]<span class="comment"># netstat -antpu | grep 32552</span></span><br><span class="line">tcp6       0      0 :::32552                :::*                    LISTEN      1601/kube-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 外界访问</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmaouhauj30ut03wdg0.jpg"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmb48c6tj30uq0453yo.jpg"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmb9bl07j30uv04d3yo.jpg"><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjgmbf0b5tj30uy03o74g.jpg"><br><em><strong>至此整体kubernetes集群架构搭建完成</strong></em></p>
<h1 id="三、Kubectl常用命令"><a href="#三、Kubectl常用命令" class="headerlink" title="三、Kubectl常用命令"></a>三、Kubectl常用命令</h1><blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">kubectl官方详细命令</a></strong></p>
</blockquote>
<h2 id="1、查看集群状态"><a href="#1、查看集群状态" class="headerlink" title="1、查看集群状态"></a>1、查看集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看客户端及服务端程序版本信息</span></span><br><span class="line">kubectl version --short=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">kubectl cluster-info </span><br></pre></td></tr></table></figure>

<h2 id="2、创建资源对象"><a href="#2、创建资源对象" class="headerlink" title="2、创建资源对象"></a>2、创建资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod资源</span></span><br><span class="line">kubectl run name --image=(镜像名) --replicas=(副本数) --port=(容器要暴露的端口) --labels=(设定自定义标签)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 陈述式对象配置管理方式</span></span><br><span class="line">kubectl create -f **.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明式对象配置管理方式（也适用于更新等）</span></span><br><span class="line">kubectl apply -f **.yaml</span><br></pre></td></tr></table></figure>

<h2 id="3、查看资源对象"><a href="#3、查看资源对象" class="headerlink" title="3、查看资源对象"></a>3、查看资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间</span></span><br><span class="line">kubectl get namespace</span><br><span class="line"></span><br><span class="line"><span class="comment"># -o 输出格式, wide表示plain-text</span></span><br><span class="line">kubectl get pods,services -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># -l 标签选择器(多个的话是与逻辑)，-n 指定命名空间，不指定默认default</span></span><br><span class="line">kubectl get pod -l <span class="string">&quot;key=value,key=value&quot;</span> -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># -l 基于集合的标签选择器, -L查询结果显示标签</span></span><br><span class="line"><span class="comment"># 注意: 为了避免和shell解释器解析!, 必须要为此类表达式使用单引号</span></span><br><span class="line">kubectl get pod -l <span class="string">&quot;key1 in (val1,val2),!key2&quot;</span> -L key </span><br><span class="line"></span><br><span class="line"><span class="comment"># -w 监视资源变动信息</span></span><br><span class="line">kubectl get pod -w</span><br></pre></td></tr></table></figure>

<h2 id="4、打印容器中日志信息"><a href="#4、打印容器中日志信息" class="headerlink" title="4、打印容器中日志信息"></a>4、打印容器中日志信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f 持续监控，-c如果pod中只有一个容器不用加</span></span><br><span class="line">kubectl logs name -f -c container_name -n kube-system</span><br></pre></td></tr></table></figure>

<h2 id="5、在容器中执行命令"><a href="#5、在容器中执行命令" class="headerlink" title="5、在容器中执行命令"></a>5、在容器中执行命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器外部执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> name -c container_name -n kube-system -- 具体命令</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器内部执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod_name /bin/sh 进入容器的交互式shell</span><br></pre></td></tr></table></figure>

<h2 id="6、删除资源对象"><a href="#6、删除资源对象" class="headerlink" title="6、删除资源对象"></a>6、删除资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除指定资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除kube-system下指定标签的资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] -l key=value -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除kube-system下所有资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] --all -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制删除Terminating的资源对象</span></span><br><span class="line">kubectl delete [pods/services/deployments/...] source_name --force --grace-period=0 -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般不用这种方式删除</span></span><br><span class="line">kubectl delete -f xx.yaml</span><br><span class="line">kubectl apply -f xx.yaml --prune -l &lt;labels&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认删除控制器会同时删除其管控的所有Pod对象，加上cascade=false就只删除rs</span></span><br><span class="line">kubectl delete rs rs_name --cascade=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="7、更新资源对象"><a href="#7、更新资源对象" class="headerlink" title="7、更新资源对象"></a>7、更新资源对象</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --force 如果需要基于此前的配置文件进行替换，需要加上force</span></span><br><span class="line">kubectl replace -f xx.yaml --force</span><br></pre></td></tr></table></figure>

<h2 id="8、将服务暴露出去-创建Service"><a href="#8、将服务暴露出去-创建Service" class="headerlink" title="8、将服务暴露出去(创建Service)"></a>8、将服务暴露出去(创建Service)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployments/deployment_name --<span class="built_in">type</span>=<span class="string">&quot;NodePort&quot;</span> --port=(要暴露的容器端口) --name=(Service对象名字)</span><br></pre></td></tr></table></figure>

<h2 id="9、扩容和缩容"><a href="#9、扩容和缩容" class="headerlink" title="9、扩容和缩容"></a>9、扩容和缩容</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment/deployment_name --replicas=N</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有当前副本数等于M时才会执行扩容或者缩容</span></span><br><span class="line">kubectl scale deployment/deployment_name --replicas=N --current-replicas=M</span><br></pre></td></tr></table></figure>

<h2 id="10、查看API版本"><a href="#10、查看API版本" class="headerlink" title="10、查看API版本"></a>10、查看API版本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-versions</span><br></pre></td></tr></table></figure>

<h2 id="11、在本地主机上为API-Server启动一个代理网关"><a href="#11、在本地主机上为API-Server启动一个代理网关" class="headerlink" title="11、在本地主机上为API Server启动一个代理网关"></a>11、在本地主机上为API Server启动一个代理网关</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 之后就可以通过curl来对此套字节发起访问请求</span></span><br><span class="line">kubectl proxy --port=8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># jq可以对json进行过滤)</span></span><br><span class="line">curl localhost:8080/api/v1/namespaces/ | jq .items[].metadata.name</span><br></pre></td></tr></table></figure>

<h2 id="12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释"><a href="#12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释" class="headerlink" title="12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释"></a>12、当定义资源配置文件时，不知道怎么定义的时候，可以查看某类型资源的配置字段解释</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二级对象可用类似于pods.spec这种方式查看</span></span><br><span class="line">kubectl explain pods/deployments/...</span><br></pre></td></tr></table></figure>

<h2 id="13、查看某资源对象的配置文件"><a href="#13、查看某资源对象的配置文件" class="headerlink" title="13、查看某资源对象的配置文件"></a>13、查看某资源对象的配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --export表示省略由系统生成的信息, 后面加 &gt; file.yaml就可以快速生成一个配置文件了</span></span><br><span class="line">kubectl get source_type source_name -o yaml --<span class="built_in">export</span></span><br></pre></td></tr></table></figure>

<h2 id="14、标签管理相关命令"><a href="#14、标签管理相关命令" class="headerlink" title="14、标签管理相关命令"></a>14、标签管理相关命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加标签,如果是修改的话需要后面添加--overwrite</span></span><br><span class="line">kubectl label pods/pod_name key=value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给工作节点添加标签，后续可以使用nodeSelector来指定pod被调度到指定的工作节点上运行</span></span><br><span class="line">kubectl label nodes node_name key=value</span><br></pre></td></tr></table></figure>

<h2 id="15、注解管理相关命令"><a href="#15、注解管理相关命令" class="headerlink" title="15、注解管理相关命令"></a>15、注解管理相关命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl annotate pods pod_name key=value</span><br></pre></td></tr></table></figure>

<h2 id="16、patch修改Deployment控制器进行控制器升级"><a href="#16、patch修改Deployment控制器进行控制器升级" class="headerlink" title="16、patch修改Deployment控制器进行控制器升级"></a>16、patch修改Deployment控制器进行控制器升级</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -p 以补丁形式更新补丁形式默认是json</span></span><br><span class="line">kubectl patch deployment deployment-demo -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;minReadySeconds&quot;: 5&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改depolyment中的镜像文件</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployments deployment-demo myapp=ikubernetes/myapp:v2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印滚动更新过程中的状态信息</span></span><br><span class="line">kubectl rollout status deployment deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控deployment的更新过程</span></span><br><span class="line">kubectl get deployments deployment-demo --watch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停更新</span></span><br><span class="line">kubectl kubectl rollout pause deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续更新</span></span><br><span class="line">kubectl rollout resume deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史版本(能查到具体的历史需要在apply的时候加上--record参数)</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployments deployment-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到指定版本，不加--to-version则回滚到上一个</span></span><br><span class="line">kubectl rollout undo deployments deployment-demo --to-revision=2</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/10/07/Kubernetes/" data-id="ckpjvyk7z0001xwg02t9n1f5b" data-title="kubernetes" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/10/18/MySQL/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          MySQL
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/db/" rel="tag">db</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/db/" style="font-size: 10px;">db</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/web/" style="font-size: 10px;">web</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/05/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/10/25/Nginx/">Nginx</a>
          </li>
        
          <li>
            <a href="/2020/10/18/Jenkins/">Jenkins</a>
          </li>
        
          <li>
            <a href="/2020/10/18/MySQL/">MySQL</a>
          </li>
        
          <li>
            <a href="/2020/10/07/Kubernetes/">kubernetes</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>